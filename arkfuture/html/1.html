<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IRC Web Client - ç°ä»£ç‰ˆ</title>
	<style>
		/* åŸºç¡€å˜é‡ */
		:root {
			--clr-background: #F5F7FA;
			--clr-background2: #E4E7F4;
			--clr-background3: #FFFFFF;
			--clr-background4: #D1D5DB;
			--clr-font: #1F2937;
			--clr-brown: #92400E;
			--clr-green: #065F46;
			--clr-gold: #D97706;
			--clr-red: #DC2626;
			--clr-purple: #7C3AED;
			--clr-blue: #2563EB;
			--clr-accent: #4F46E5;
			--clr-accent2: #818CF8;
			--clr-border: #9CA3AF;
			--clr-warning: #F59E0B;
			--clr-success: #10B981;
			--clr-info: #0891B2;
			--clr-user-online: #10B981;
			--clr-user-away: #F59E0B;
			--spacing-sm: 8px;
			--spacing-md: 12px;
			--spacing-lg: 16px;
			--spacing-xl: 20px;
			--border-radius: 12px;
			--border-radius-sm: 8px;
			--transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
			--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
			--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
			--opacity-50: 0.5;
			--glass-blur: blur(12px);
		}

		/* æ·±è‰²ä¸»é¢˜ */
		@media (prefers-color-scheme: dark) {
			:root {
				--clr-background: #111827;
				--clr-background2: #1F2937;
				--clr-background3: #1F2937;
				--clr-background4: #4B5563;
				--clr-font: #F9FAFB;
				--clr-brown: #FDE68A;
				--clr-green: #6EE7B7;
				--clr-gold: #FBBF24;
				--clr-red: #FCA5A5;
				--clr-purple: #C4B5FD;
				--clr-blue: #93C5FD;
				--clr-accent: #818CF8;
				--clr-accent2: #A5B4FC;
				--clr-border: #4B5563;
				--clr-warning: #FCD34D;
				--clr-success: #6EE7B7;
				--clr-info: #67E8F9;
				--clr-user-online: #6EE7B7;
				--clr-user-away: #FCD34D;
				--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
				--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
				--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
			}
		}

		* {
			box-sizing: border-box;
		}

		html, body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			margin: 0;
			padding: 0;
			height: 100%;
			background: linear-gradient(135deg, var(--clr-background), var(--clr-background2));
			color: var(--clr-font);
			font-size: 14px;
			line-height: 1.6;
			overflow: hidden;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		.main {
			display: flex;
			flex-direction: column;
			height: 100vh;
			width: 100%;
		}

		.header {
			background: linear-gradient(90deg, var(--clr-accent), var(--clr-purple));
			padding: var(--spacing-md) var(--spacing-lg);
			flex: 0 0 auto;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
			box-shadow: var(--shadow-md);
			z-index: 10;
			position: relative;
		}

		.header h1 {
			margin: 0;
			font-size: 20px;
			font-weight: 700;
			color: white;
			letter-spacing: -0.5px;
			display: flex;
			align-items: center;
			gap: var(--spacing-sm);
		}

		.header h1::before {
			content: "#";
			color: rgba(255, 255, 255, 0.7);
		}

		.settings-bar {
			flex: 0 0 auto;
			background: var(--clr-background3);
			border-bottom: 1px solid var(--clr-border);
			display: flex;
			align-items: center;
			padding: var(--spacing-sm) var(--spacing-md);
			gap: var(--spacing-sm);
			overflow-x: auto;
			flex-wrap: nowrap;
			min-height: 56px;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
			box-shadow: var(--shadow-sm);
		}

		.settings-group {
			display: flex;
			align-items: center;
			gap: 8px;
			flex: 0 0 auto;
			position: relative;
		}

		.settings-group label {
			font-size: 12px;
			font-weight: 600;
			color: var(--clr-font);
			white-space: nowrap;
			opacity: 0.8;
		}

		.settings-group input[type="text"] {
			padding: 8px 12px;
			background: var(--clr-background);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius-sm);
			font-size: 13px;
			min-width: 140px;
			transition: var(--transition);
			box-shadow: var(--shadow-sm);
		}

		.settings-group input[type="text"]:focus {
			outline: none;
			border-color: var(--clr-accent);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
			transform: translateY(-1px);
		}

		.settings-group input[type="checkbox"] {
			width: 18px;
			height: 18px;
			cursor: pointer;
			margin: 0;
			accent-color: var(--clr-accent);
			transition: var(--transition);
		}

		.settings-group input[type="checkbox"]:hover {
			transform: scale(1.1);
		}

		.btn {
			padding: 8px 14px;
			border: none;
			border-radius: var(--border-radius-sm);
			cursor: pointer;
			font-weight: 600;
			font-size: 13px;
			white-space: nowrap;
			transition: var(--transition);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
			box-shadow: var(--shadow-sm);
			position: relative;
			overflow: hidden;
		}

		.btn:hover {
			transform: translateY(-2px);
			box-shadow: var(--shadow-md);
		}

		.btn:active {
			transform: translateY(0);
		}

		.btn::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.3);
			transform: translate(-50%, -50%);
			transition: width 0.6s, height 0.6s;
		}

		.btn:active::after {
			width: 300px;
			height: 300px;
		}

		.connect-btn {
			background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
			color: white;
		}

		.connect-btn:disabled {
			background: var(--clr-background4);
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
			opacity: 0.6;
		}

		.connect-btn.disconnect {
			background: linear-gradient(135deg, var(--clr-red), #EF4444);
		}

		.log-toggle-btn {
			background: var(--clr-background4);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
		}

		.log-toggle-btn:hover {
			background: var(--clr-accent);
			color: white;
			border-color: var(--clr-accent);
		}

		.ssl-help-btn {
			background: linear-gradient(135deg, var(--clr-warning), #F59E0B);
			color: #000;
			padding: 8px 12px;
		}

		.ssl-help-btn:hover {
			background: linear-gradient(135deg, #F59E0B, #D97706);
		}

		.theme-toggle-btn {
			background: var(--clr-background4);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
			padding: 8px;
			border-radius: 50%;
			width: 36px;
			height: 36px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.theme-toggle-btn:hover {
			background: var(--clr-accent);
			color: white;
			transform: rotate(180deg);
		}

		.connection-status {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 6px 12px;
			background: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: 20px;
			font-size: 12px;
			font-weight: 500;
			margin-left: auto;
			flex: 0 0 auto;
			transition: var(--transition);
			box-shadow: var(--shadow-sm);
		}

		.connection-status.connected {
			border-color: var(--clr-success);
			background: rgba(16, 185, 129, 0.1);
			box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
		}

		.connection-status.disconnected {
			border-color: var(--clr-red);
			background: rgba(220, 38, 38, 0.1);
			box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
		}

		.connection-status .indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--clr-border);
			transition: var(--transition);
			position: relative;
		}

		.connection-status.connected .indicator {
			background: var(--clr-success);
			animation: pulse 2s infinite;
		}

		.connection-status.disconnected .indicator {
			background: var(--clr-red);
		}

		@keyframes pulse {
			0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
			70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
			100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
		}

		.ssl-warning {
			display: none;
			position: absolute;
			bottom: 20px;
			right: 20px;
			max-width: 420px;
			background: linear-gradient(135deg, var(--clr-warning), #F59E0B);
			color: #000;
			padding: var(--spacing-md);
			border-radius: var(--border-radius);
			font-size: 13px;
			z-index: 200;
			box-shadow: var(--shadow-lg);
			line-height: 1.5;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
			border: 1px solid rgba(0, 0, 0, 0.1);
			transform: translateY(100px);
			opacity: 0;
			transition: var(--transition);
		}

		.ssl-warning.visible {
			display: block;
			transform: translateY(0);
			opacity: 1;
		}

		.ssl-warning a {
			color: #000;
			font-weight: 600;
			text-decoration: underline;
			cursor: pointer;
			transition: var(--transition);
		}

		.ssl-warning a:hover {
			opacity: 0.8;
		}

		.ssl-warning code {
			background: rgba(0, 0, 0, 0.1);
			padding: 2px 6px;
			border-radius: 4px;
			font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
			font-weight: 600;
		}

		.ssl-warning .close {
			position: absolute;
			top: 8px;
			right: 8px;
			cursor: pointer;
			font-size: 18px;
			line-height: 1;
			opacity: 0.7;
		}

		.ssl-warning .close:hover {
			opacity: 1;
		}

		.log-container {
			position: absolute;
			inset: 0;
			background: rgba(0, 0, 0, 0.85);
			border-bottom: 2px solid var(--clr-accent);
			display: none;
			flex-direction: column;
			z-index: 100;
			box-shadow: var(--shadow-lg);
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
		}

		.log-container.visible {
			display: flex;
		}

		.log-header {
			flex: 0 0 auto;
			padding: var(--spacing-sm) var(--spacing-md);
			background: rgba(31, 41, 55, 0.7);
			border-bottom: 1px solid var(--clr-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-weight: 600;
			font-size: 13px;
			min-height: 40px;
			color: var(--clr-font);
		}

		.log-controls {
			display: flex;
			gap: 8px;
		}

		.log-controls button {
			padding: 6px 12px;
			background: var(--clr-background4);
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 11px;
			transition: var(--transition);
			color: var(--clr-font);
		}

		.log-controls button:hover {
			background: var(--clr-accent);
			color: white;
			transform: translateY(-1px);
		}

		#logOutput {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--spacing-sm);
			font-size: 11px;
			font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
			background: rgba(17, 24, 39, 0.9);
			color: #F9FAFB;
			white-space: pre-wrap;
			word-wrap: break-word;
			line-height: 1.4;
		}

		#logOutput .log-error { color: #FCA5A5; }
		#logOutput .log-warn { color: #FCD34D; }
		#logOutput .log-info { color: #93C5FD; }
		#logOutput .log-success { color: #6EE7B7; }
		#logOutput .log-debug { color: #9CA3AF; }

		.chat-container {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			position: relative;
			min-height: 0;
		}

		.channels {
			flex: 0 0 auto;
			background: var(--clr-background3);
			border-bottom: 1px solid var(--clr-border);
			display: flex;
			align-items: center;
			padding: var(--spacing-sm) 10px;
			gap: 8px;
			overflow-x: auto;
			flex-wrap: nowrap;
			box-shadow: var(--shadow-sm);
		}

		.channels::-webkit-scrollbar {
			height: 4px;
		}

		.channel {
			padding: 8px 14px;
			background: var(--clr-background2);
			border: 1px solid var(--clr-border);
			border-radius: 20px;
			cursor: pointer;
			font-weight: 500;
			font-size: 13px;
			transition: var(--transition);
			display: inline-flex;
			align-items: center;
			gap: 8px;
			white-space: nowrap;
			min-width: fit-content;
		}

		.channel:hover {
			background: var(--clr-background4);
			transform: translateY(-1px);
		}

		.channel.active {
			background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
			color: white;
			border-color: transparent;
			box-shadow: var(--shadow-md);
		}

		.channel.unread {
			border-color: var(--clr-accent);
			animation: pulse-border 2s infinite;
		}

		@keyframes pulse-border {
			0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
			70% { box-shadow: 0 0 0 8px rgba(79, 70, 229, 0); }
			100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
		}

		.channel button.x {
			background: rgba(0, 0, 0, 0.1);
			border: none;
			color: inherit;
			cursor: pointer;
			padding: 2px 6px;
			font-weight: bold;
			border-radius: 50%;
			font-size: 14px;
			transition: var(--transition);
			line-height: 1;
			width: 20px;
			height: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.channel button.x:hover {
			background: rgba(220, 38, 38, 0.8);
			color: white;
			transform: scale(1.1);
		}

		.unread-badge {
			background: var(--clr-accent);
			color: white;
			border-radius: 10px;
			padding: 2px 6px;
			font-size: 10px;
			font-weight: 700;
			min-width: 18px;
			text-align: center;
			position: absolute;
			top: -8px;
			right: -8px;
		}

		.channelcontents-wrapper {
			flex: 1 1 auto;
			display: flex;
			overflow: hidden;
			min-height: 0;
		}

		.channelcontents-wrapper.visible {
			display: flex;
		}

		.channelcontents-wrapper.hidden {
			display: none;
		}

		.channelcontents {
			display: flex;
			flex-direction: row;
			width: 100%;
			height: 100%;
			min-height: 0;
		}

		.channelcontent {
			flex: 1 1 auto;
			display: none;
			flex-direction: row;
			min-height: 0;
		}

		.channelcontent.active {
			display: flex;
		}

		.channelcontent nav {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
			background: var(--clr-background3);
			border-radius: var(--border-radius);
			overflow: hidden;
			border: 1px solid var(--clr-border);
			margin: var(--spacing-sm);
			box-shadow: var(--shadow-sm);
		}

		.channelcontent nav h3 {
			flex: 0 0 auto;
			padding: var(--spacing-md);
			margin: 0;
			background: var(--clr-background2);
			border-bottom: 1px solid var(--clr-border);
			font-weight: 600;
			font-size: 14px;
			min-height: 40px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			color: var(--clr-font);
		}

		.channelcontent nav nav {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--spacing-md);
			min-height: 0;
			background: var(--clr-background);
		}

		/* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
		.message {
			margin: var(--spacing-sm) 0;
			padding: var(--spacing-sm) var(--spacing-md);
			display: flex;
			gap: 10px;
			align-items: flex-start;
			transition: var(--transition);
			border-radius: var(--border-radius-sm);
		}

		.message:hover {
			background: rgba(0, 0, 0, 0.02);
		}

		.dark .message:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		.message-avatar {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			font-size: 12px;
			color: white;
			flex-shrink: 0;
			box-shadow: var(--shadow-sm);
		}

		.message-content {
			flex: 1;
			display: flex;
			flex-direction: column;
			gap: 4px;
		}

		.message-header {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.message-username {
			font-weight: 700;
			color: var(--clr-purple);
			font-size: 13px;
		}

		.message-timestamp {
			font-size: 10px;
			color: var(--clr-border);
			opacity: 0.7;
		}

		.message-text {
			margin: 0;
			color: var(--clr-font);
			word-wrap: break-word;
			line-height: 1.5;
			font-size: 14px;
		}

		.message-text a {
			color: var(--clr-accent);
			text-decoration: none;
			border-bottom: 1px dashed var(--clr-accent);
			transition: var(--transition);
		}

		.message-text a:hover {
			color: var(--clr-purple);
			border-bottom-style: solid;
		}

		.message-text code {
			background: var(--clr-background2);
			padding: 2px 4px;
			border-radius: 4px;
			font-family: 'Fira Code', monospace;
			font-size: 12px;
		}

		.message-action {
			background: rgba(0, 0, 0, 0.05);
			padding: var(--spacing-sm);
			border-radius: var(--border-radius-sm);
			border-left: 3px solid var(--clr-accent);
		}

		.dark .message-action {
			background: rgba(255, 255, 255, 0.05);
		}

		ul {
			flex: 0 0 240px;
			overflow-y: auto;
			padding: var(--spacing-sm);
			margin: 0;
			border-left: 1px solid var(--clr-border);
			list-style: none;
			background: var(--clr-background3);
			min-height: 0;
			box-shadow: inset 2px 0 4px rgba(0, 0, 0, 0.05);
		}

		.user-list-item {
			padding: 8px 12px;
			margin: 2px 0;
			display: flex;
			align-items: center;
			gap: 8px;
			border-radius: var(--border-radius-sm);
			transition: var(--transition);
			cursor: pointer;
		}

		.user-list-item:hover {
			background: var(--clr-background2);
			transform: translateX(4px);
		}

		.user-avatar-small {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			background: linear-gradient(135deg, var(--clr-accent2), var(--clr-purple));
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 10px;
			font-weight: 700;
			color: white;
		}

		.user-prefix {
			font-weight: 700;
			color: var(--clr-purple);
			min-width: 12px;
			text-align: center;
		}

		.user-nick {
			flex: 1;
			color: var(--clr-green);
			font-weight: 500;
			font-size: 13px;
		}

		.user-status {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: var(--clr-user-online);
			box-shadow: 0 0 0 2px var(--clr-background3);
		}

		.user-away {
			background: var(--clr-user-away);
		}

		.input-container {
			flex: 0 0 auto;
			padding: var(--spacing-md);
			background: var(--clr-background3);
			border-top: 1px solid var(--clr-border);
			display: flex;
			align-items: center;
			gap: var(--spacing-sm);
			position: relative;
		}

		#input {
			flex: 1;
			padding: 12px var(--spacing-md);
			background: var(--clr-background);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius);
			font-size: 14px;
			transition: var(--transition);
			box-shadow: var(--shadow-sm);
		}

		#input:focus {
			outline: none;
			border-color: var(--clr-accent);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
			transform: translateY(-1px);
		}

		#input::placeholder {
			color: var(--clr-border);
			opacity: 0.7;
		}

		.input-actions {
			display: flex;
			gap: 8px;
			align-items: center;
		}

		.input-action-btn {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			background: var(--clr-background4);
			border: 1px solid var(--clr-border);
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: var(--transition);
			color: var(--clr-font);
			font-size: 16px;
		}

		.input-action-btn:hover {
			background: var(--clr-accent);
			color: white;
			transform: scale(1.1);
		}

		.command-suggestions {
			position: absolute;
			bottom: 100%;
			left: var(--spacing-md);
			right: var(--spacing-md);
			background: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius-sm);
			box-shadow: var(--shadow-lg);
			max-height: 200px;
			overflow-y: auto;
			display: none;
			z-index: 50;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
		}

		.command-suggestions.visible {
			display: block;
		}

		.suggestion-item {
			padding: 10px var(--spacing-md);
			cursor: pointer;
			font-size: 13px;
			border-bottom: 1px solid var(--clr-background2);
			transition: var(--transition);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.suggestion-item:last-child {
			border-bottom: none;
		}

		.suggestion-item:hover {
			background: var(--clr-accent);
			color: white;
			transform: translateX(4px);
		}

		.suggestion-item .desc {
			font-size: 11px;
			opacity: 0.7;
		}

		/* é€šçŸ¥æ ·å¼ */
		.notification {
			position: absolute;
			top: 80px;
			right: 20px;
			background: var(--clr-background3);
			border-left: 4px solid var(--clr-accent);
			padding: var(--spacing-md);
			border-radius: var(--border-radius-sm);
			box-shadow: var(--shadow-lg);
			max-width: 320px;
			z-index: 150;
			transform: translateX(400px);
			opacity: 0;
			transition: var(--transition);
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
		}

		.notification.visible {
			transform: translateX(0);
			opacity: 1;
		}

		.notification .title {
			font-weight: 700;
			font-size: 14px;
			margin-bottom: 4px;
			color: var(--clr-font);
		}

		.notification .message {
			font-size: 13px;
			color: var(--clr-font);
			opacity: 0.8;
		}

		.notification .close {
			position: absolute;
			top: 8px;
			right: 8px;
			cursor: pointer;
			opacity: 0.6;
			transition: var(--transition);
		}

		.notification .close:hover {
			opacity: 1;
			transform: scale(1.1);
		}

		/* æœç´¢æ¡† */
		.search-container {
			position: absolute;
			top: 80px;
			right: 20px;
			background: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius-sm);
			box-shadow: var(--shadow-lg);
			display: none;
			z-index: 140;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
			transform: translateY(-10px);
			opacity: 0;
			transition: var(--transition);
			min-width: 280px;
		}

		.search-container.visible {
			display: block;
			transform: translateY(0);
			opacity: 1;
		}

		.search-input {
			padding: 10px var(--spacing-md);
			border: none;
			background: transparent;
			color: var(--clr-font);
			width: 100%;
			border-radius: var(--border-radius-sm);
			font-size: 13px;
		}

		.search-input:focus {
			outline: none;
		}

		.search-results {
			max-height: 200px;
			overflow-y: auto;
			border-top: 1px solid var(--clr-background2);
		}

		.search-result-item {
			padding: 8px var(--spacing-md);
			font-size: 12px;
			cursor: pointer;
			transition: var(--transition);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.search-result-item:hover {
			background: var(--clr-accent);
			color: white;
		}

		/* å¿«é€Ÿå‘½ä»¤é¢æ¿ */
		.quick-commands {
			position: absolute;
			bottom: 100px;
			left: 50%;
			transform: translateX(-50%) translateY(100px);
			background: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-lg);
			padding: var(--spacing-md);
			display: none;
			z-index: 120;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
			opacity: 0;
			transition: var(--transition);
		}

		.quick-commands.visible {
			display: flex;
			flex-direction: column;
			gap: 8px;
			transform: translateX(-50%) translateY(0);
			opacity: 1;
		}

		.quick-command-btn {
			padding: 8px 16px;
			background: var(--clr-background2);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius-sm);
			cursor: pointer;
			transition: var(--transition);
			font-size: 13px;
			color: var(--clr-font);
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.quick-command-btn:hover {
			background: var(--clr-accent);
			color: white;
			transform: translateX(4px);
		}

		/* æ»šåŠ¨æŒ‡ç¤ºå™¨ */
		.scroll-indicator {
			position: absolute;
			bottom: 70px;
			right: 20px;
			background: var(--clr-accent);
			color: white;
			padding: 8px 16px;
			border-radius: 20px;
			font-size: 12px;
			cursor: pointer;
			opacity: 0;
			transition: var(--transition);
			pointer-events: none;
			z-index: 5;
			box-shadow: var(--shadow-md);
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.scroll-indicator.visible {
			opacity: 1;
			pointer-events: all;
		}

		.scroll-indicator:hover {
			transform: translateY(-2px);
			background: var(--clr-purple);
		}

		/* ç©ºçŠ¶æ€ */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			color: var(--clr-border);
			text-align: center;
			padding: var(--spacing-xl);
		}

		.empty-state h3 {
			margin: 0 0 12px 0;
			font-size: 24px;
			font-weight: 700;
			background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		.empty-state p {
			margin: 0;
			font-size: 14px;
			opacity: 0.7;
			max-width: 300px;
		}

		.empty-state .logo {
			font-size: 64px;
			margin-bottom: var(--spacing-md);
			opacity: 0.3;
			animation: float 3s ease-in-out infinite;
		}

		@keyframes float {
			0% { transform: translateY(0px); }
			50% { transform: translateY(-10px); }
			100% { transform: translateY(0px); }
		}

		/* åŠ è½½åŠ¨ç”» */
		.loading {
			display: inline-flex;
			gap: 4px;
			align-items: center;
		}

		.loading span {
			width: 6px;
			height: 6px;
			border-radius: 50%;
			background: var(--clr-accent);
			animation: loading-bounce 1.4s infinite ease-in-out both;
		}

		.loading span:nth-child(1) { animation-delay: -0.32s; }
		.loading span:nth-child(2) { animation-delay: -0.16s; }

		@keyframes loading-bounce {
			0%, 80%, 100% { transform: scale(0); }
			40% { transform: scale(1); }
		}

		/* å·¥å…·æç¤º */
		.tooltip {
			position: fixed;
			background: rgba(0, 0, 0, 0.8);
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 11px;
			pointer-events: none;
			opacity: 0;
			transition: opacity 0.2s;
			z-index: 1000;
			white-space: nowrap;
		}

		.tooltip.visible {
			opacity: 1;
		}

		/* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}

		::-webkit-scrollbar-track {
			background: var(--clr-background);
		}

		::-webkit-scrollbar-thumb {
			background: var(--clr-accent);
			border-radius: 4px;
			border: 2px solid var(--clr-background);
		}

		::-webkit-scrollbar-thumb:hover {
			background: var(--clr-purple);
		}

		/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
		@media (max-width: 768px) {
			.settings-bar {
				flex-wrap: wrap;
				padding: 10px;
				gap: 8px;
				min-height: auto;
			}

			.settings-group {
				flex: 1 1 45%;
				min-width: 140px;
			}

			.settings-group input {
				min-width: 100px;
				width: 100%;
			}

			.connection-status {
				margin-left: 0;
				flex: 1 1 100%;
				justify-content: center;
				margin-top: 6px;
			}

			.log-container {
				height: 45vh;
			}

			.channelcontent {
				flex-direction: column;
			}

			ul {
				flex: 0 0 130px;
				border-left: none;
				border-top: 1px solid var(--clr-border);
			}

			#input {
				margin: 8px;
				padding: 10px;
			}

			.notification {
				max-width: 280px;
				right: 10px;
			}

			.search-container {
				right: 10px;
				max-width: calc(100% - 20px);
			}

			ul {
				flex: 0 0 130px;
			}

			.user-list-item {
				padding: 6px 8px;
			}

			.user-avatar-small {
				width: 20px;
				height: 20px;
			}
		}

		@media (max-width: 480px) {
			.settings-group {
				flex: 1 1 100%;
			}

			.channel {
				font-size: 12px;
				padding: 6px 12px;
			}

			.connection-status span:last-child {
				display: none;
			}

			ul {
				flex: 0 0 100px;
			}

			.log-header {
				padding: 8px;
			}

			.message {
				padding: 6px 8px;
			}

			.message-avatar {
				width: 28px;
				height: 28px;
			}
		}

		/* é”®ç›˜å¿«æ·é”®æç¤º */
		.keyboard-shortcuts {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%) scale(0.9);
			background: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-lg);
			padding: var(--spacing-lg);
			z-index: 300;
			display: none;
			opacity: 0;
			transition: var(--transition);
			max-width: 90vw;
			max-height: 80vh;
			overflow-y: auto;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
		}

		.keyboard-shortcuts.visible {
			display: block;
			opacity: 1;
			transform: translate(-50%, -50%) scale(1);
		}

		.keyboard-shortcuts h3 {
			margin: 0 0 var(--spacing-md) 0;
			font-size: 18px;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.shortcut-item {
			display: flex;
			justify-content: space-between;
			padding: 8px 0;
			border-bottom: 1px solid var(--clr-background2);
		}

		.shortcut-item:last-child {
			border-bottom: none;
		}

		.shortcut-keys {
			display: flex;
			gap: 4px;
		}

		.shortcut-key {
			padding: 2px 6px;
			background: var(--clr-background2);
			border: 1px solid var(--clr-border);
			border-radius: 4px;
			font-size: 11px;
			font-family: monospace;
			font-weight: 600;
		}

		/* ç”¨æˆ·ä¸Šä¸‹æ–‡èœå• */
		.context-menu {
			position: absolute;
			background: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius-sm);
			box-shadow: var(--shadow-lg);
			padding: 6px 0;
			z-index: 200;
			display: none;
			min-width: 160px;
			backdrop-filter: var(--glass-blur);
			-webkit-backdrop-filter: var(--glass-blur);
		}

		.context-menu.visible {
			display: block;
		}

		.context-menu-item {
			padding: 8px 16px;
			cursor: pointer;
			font-size: 13px;
			transition: var(--transition);
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.context-menu-item:hover {
			background: var(--clr-accent);
			color: white;
		}

		.context-menu-separator {
			height: 1px;
			background: var(--clr-background2);
			margin: 4px 0;
		}

		/* ä»£ç å—æ ·å¼ */
		.message-text pre {
			background: var(--clr-background2);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius-sm);
			padding: var(--spacing-sm);
			margin: var(--spacing-sm) 0;
			overflow-x: auto;
		}

		.message-text code {
			font-family: 'Fira Code', monospace;
			font-size: 12px;
		}

		.message-text pre code {
			background: none;
			border: none;
			padding: 0;
		}

		/* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
		.file-drop-zone {
			position: absolute;
			inset: 0;
			background: rgba(79, 70, 229, 0.1);
			border: 2px dashed var(--clr-accent);
			border-radius: var(--border-radius);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 50;
			pointer-events: none;
			transition: var(--transition);
		}

		.file-drop-zone.visible {
			display: flex;
			pointer-events: all;
		}

		.file-drop-zone-content {
			background: var(--clr-background3);
			padding: var(--spacing-lg);
			border-radius: var(--border-radius);
			box-shadow: var(--shadow-lg);
			text-align: center;
		}

		.file-drop-zone-content h3 {
			margin: 0 0 8px 0;
			color: var(--clr-font);
		}

		.file-drop-zone-content p {
			margin: 0;
			color: var(--clr-border);
			font-size: 13px;
		}
	</style>
</head>

<body>
	<div class="main">
		<div class="header">
			<h1 id="caption">IRC Client Pro</h1>
		</div>

		<div class="settings-bar">
			<div class="settings-group">
				<label>WebSocket:</label>
				<input type="text" id="wsUrl" value="" placeholder="wss://irc.example.com:port/">
			</div>
			<div class="settings-group">
				<label>æ˜µç§°:</label>
				<input type="text" id="nickInput" value="" placeholder="è¾“å…¥æ˜µç§°">
			</div>
			<div class="settings-group">
				<label>é¢‘é“:</label>
				<input type="text" id="channelInput" value="" placeholder="#channel">
			</div>
			<div class="settings-group">
				<label title="å¯ç”¨åä¼šåœ¨æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿">
					<input type="checkbox" id="autoReconnect"> è‡ªåŠ¨é‡è¿
				</label>
			</div>
			<div class="settings-group">
				<label title="æ¶ˆæ¯é€šçŸ¥">
					<input type="checkbox" id="enableNotifications" checked> æ¶ˆæ¯é€šçŸ¥
				</label>
			</div>
			<div class="settings-group">
				<button class="btn ssl-help-btn" onclick="showSSLWarning()" title="ç‚¹å‡»æŸ¥çœ‹SSLè¯ä¹¦é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ">SSLå¸®åŠ©</button>
			</div>
			<button class="btn connect-btn" id="connectBtn" onclick="toggleConnection()">è¿æ¥</button>
			<button class="btn log-toggle-btn" onclick="toggleLog()">æ—¥å¿—</button>
			<button class="btn theme-toggle-btn" onclick="toggleTheme()" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
			<div class="connection-status disconnected" id="connectionStatus">
				<span class="indicator"></span>
				<span id="statusText">æœªè¿æ¥</span>
			</div>
		</div>

		<div class="ssl-warning" id="sslWarning">
			<span class="close" onclick="document.getElementById('sslWarning').classList.remove('visible')">Ã—</span>
			<strong>âš ï¸ æµè§ˆå™¨æ— æ³•å¿½ç•¥SSLè¯ä¹¦é”™è¯¯!</strong> è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š<br>
			1. æ”¹ç”¨ <code>ws://</code> éåŠ å¯†è¿æ¥(å¦‚æœæµè§ˆå™¨æ”¯æŒ)<br>
			2. åœ¨æµè§ˆå™¨ä¸­è®¿é—® <a id="sslLink" target="_blank">æœåŠ¡å™¨URL</a> å¹¶æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦<br>
		</div>

		<div class="log-container" id="logContainer">
			<div class="log-header">
				<span>WebSocketæ—¥å¿—</span>
				<div class="log-controls">
					<button onclick="clearLog()">æ¸…ç©º</button>
					<button onclick="toggleLog()">å…³é—­</button>
				</div>
			</div>
			<div id="logOutput"></div>
		</div>

		<div class="chat-container">
			<div class="channels" id="channelsContainer"></div>
			<div class="channelcontents-wrapper hidden" id="contentsWrapper">
				<div class="channelcontents" id="channelContents"></div>
			</div>
			<div class="empty-state" id="emptyState">
				<div class="logo">ğŸ’¬</div>
				<h3>æ¬¢è¿ä½¿ç”¨ IRC å®¢æˆ·ç«¯ Pro</h3>
				<p>å¡«å†™æœåŠ¡å™¨ä¿¡æ¯å¹¶ç‚¹å‡»è¿æ¥å¼€å§‹èŠå¤©</p>
			</div>
			
			<div class="file-drop-zone" id="fileDropZone">
				<div class="file-drop-zone-content">
					<h3>ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</h3>
					<p>æ”¯æŒå‘é€æ–‡ä»¶åˆ°å½“å‰é¢‘é“</p>
				</div>
			</div>

			<div class="notification" id="notification">
				<span class="close" onclick="hideNotification()">Ã—</span>
				<div class="title" id="notificationTitle"></div>
				<div class="message" id="notificationMessage"></div>
			</div>

			<div class="search-container" id="searchContainer">
				<input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ¶ˆæ¯...">
				<div class="search-results" id="searchResults"></div>
			</div>

			<div class="quick-commands" id="quickCommands">
				<div class="quick-command-btn" onclick="executeQuickCommand('/me')">
					ğŸ­ <span>/me - åŠ¨ä½œæ¶ˆæ¯</span>
				</div>
				<div class="quick-command-btn" onclick="executeQuickCommand('/join')">
					â• <span>/join - åŠ å…¥é¢‘é“</span>
				</div>
				<div class="quick-command-btn" onclick="executeQuickCommand('/nick')">
					ğŸ‘¤ <span>/nick - æ›´æ”¹æ˜µç§°</span>
				</div>
				<div class="quick-command-btn" onclick="executeQuickCommand('/msg')">
					ğŸ’¬ <span>/msg - ç§èŠ</span>
				</div>
				<div class="quick-command-btn" onclick="executeQuickCommand('/clear')">
					ğŸ§¹ <span>/clear - æ¸…å±</span>
				</div>
				<div class="quick-command-btn" onclick="toggleQuickCommands()">
					âŒ <span>å…³é—­</span>
				</div>
			</div>

			<div class="keyboard-shortcuts" id="keyboardShortcuts">
				<h3>âŒ¨ï¸ é”®ç›˜å¿«æ·é”®</h3>
				<div class="shortcut-item">
					<span>åˆ‡æ¢ä¸»é¢˜</span>
					<div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">T</span></div>
				</div>
				<div class="shortcut-item">
					<span>æœç´¢æ¶ˆæ¯</span>
					<div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">F</span></div>
				</div>
				<div class="shortcut-item">
					<span>æ‰“å¼€æ—¥å¿—</span>
					<div class="shortcut-keys"><span class="shortcut-key">Ctrl</span><span class="shortcut-key">L</span></div>
				</div>
				<div class="shortcut-item">
					<span>å¿«é€Ÿå‘½ä»¤</span>
					<div class="shortcut-keys"><span class="shortcut-key">/</span></div>
				</div>
				<div class="shortcut-item">
					<span>å…³é—­æç¤º</span>
					<div class="shortcut-keys"><span class="shortcut-key">ESC</span></div>
				</div>
				<div style="text-align: center; margin-top: var(--spacing-md);">
					<button class="btn" onclick="toggleKeyboardShortcuts()">å…³é—­</button>
				</div>
			</div>

			<div class="context-menu" id="userContextMenu">
				<div class="context-menu-item" onclick="openPrivateChat()">
					ğŸ’¬ å‘èµ·ç§èŠ
				</div>
				<div class="context-menu-item" onclick="whoisUser()">
					â„¹ï¸ æŸ¥çœ‹ä¿¡æ¯
				</div>
				<div class="context-menu-item" onclick="openUserNotes()">
					ğŸ“ æ·»åŠ å¤‡æ³¨
				</div>
				<div class="context-menu-separator"></div>
				<div class="context-menu-item" onclick="ignoreUser()">
					ğŸš« å¿½ç•¥ç”¨æˆ·
				</div>
			</div>

			<div class="scroll-indicator" id="scrollIndicator" onclick="scrollToBottom()">
				â¬‡ï¸ æ–°æ¶ˆæ¯
			</div>

			<div class="input-container">
				<input type="text" name="input" id="input" placeholder="è¾“å…¥æ¶ˆæ¯æˆ–å‘½ä»¤ (/)..." 
					   onkeydown="onKeyDown(event)" oninput="onInputChange()">
				<div class="input-actions">
					<div class="input-action-btn" onclick="toggleQuickCommands()" title="å¿«é€Ÿå‘½ä»¤">âš¡</div>
					<div class="input-action-btn" onclick="selectFile()" title="å‘é€æ–‡ä»¶">ğŸ“</div>
					<div class="input-action-btn" onclick="insertEmoji()" title="æ’å…¥è¡¨æƒ…">ğŸ˜Š</div>
				</div>
				<div class="command-suggestions" id="commandSuggestions"></div>
			</div>
		</div>
	</div>

	<div class="tooltip" id="globalTooltip"></div>
</body>

<script>
// å…¨å±€å˜é‡
var nickname = "";
var channelName = "";
var wsUrl = "";
var channels, channelContents, contentsWrapper, emptyState, input;
var channelMap = new Map();
var activeChannel = null;
var statusChannel = null;
var PrefixChars;
var websocket = null;
var isConnected = false;
var autoReconnect = false;
var reconnectAttempts = 0;
var maxReconnectAttempts = 5;
var reconnectDelay = 3000;
var unreadCounts = new Map();
var messageHistory = [];
var currentHistoryIndex = -1;
var userNotes = new Map();
var ignoredUsers = new Set();
var notificationSound = null;
var messageSearchIndex = [];
var currentTheme = 'auto'; // auto, light, dark

// IRCå‘½ä»¤åˆ—è¡¨
var availableCommands = [
	{ cmd: '/me', desc: 'å‘é€åŠ¨ä½œæ¶ˆæ¯', usage: '/me åŠ¨ä½œ' },
	{ cmd: '/join', desc: 'åŠ å…¥é¢‘é“', usage: '/join #é¢‘é“' },
	{ cmd: '/part', desc: 'ç¦»å¼€é¢‘é“', usage: '/part #é¢‘é“' },
	{ cmd: '/nick', desc: 'æ›´æ”¹æ˜µç§°', usage: '/nick æ–°æ˜µç§°' },
	{ cmd: '/msg', desc: 'å‘é€ç§èŠ', usage: '/msg ç”¨æˆ· æ¶ˆæ¯' },
	{ cmd: '/whois', desc: 'æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯', usage: '/whois ç”¨æˆ·' },
	{ cmd: '/ignore', desc: 'å¿½ç•¥ç”¨æˆ·', usage: '/ignore ç”¨æˆ·' },
	{ cmd: '/unignore', desc: 'å–æ¶ˆå¿½ç•¥', usage: '/unignore ç”¨æˆ·' },
	{ cmd: '/clear', desc: 'æ¸…ç©ºå½“å‰é¢‘é“', usage: '/clear' },
	{ cmd: '/help', desc: 'æ˜¾ç¤ºå¸®åŠ©', usage: '/help' }
];

// åˆå§‹åŒ–
function onLoad() {
	channels = document.getElementById("channelsContainer");
	channelContents = document.getElementById("channelContents");
	contentsWrapper = document.getElementById("contentsWrapper");
	emptyState = document.getElementById("emptyState");
	input = document.getElementById("input");

	let url = new URL(document.location);
	if (url.hash) {
		document.getElementById('channelInput').value = url.hash;
	}
	if (window.frameElement) {
		document.getElementById("caption").style.display = "none";
	}
	updateConnectionStatus(false);

	// åŠ è½½è®¾ç½®
	loadSettings();

	// åˆå§‹åŒ–é€šçŸ¥éŸ³æ•ˆ
	initNotificationSound();

	// åˆå§‹åŒ–æ‹–æ‹½
	initDragAndDrop();

	// åˆå§‹åŒ–å·¥å…·æç¤º
	initTooltips();

	// è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
	if (input) {
		input.addEventListener('blur', () => setTimeout(() => input.focus(), 100));
		input.focus();
	}

	// ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
	window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeDisplay);

	// é”®ç›˜å¿«æ·é”®
	document.addEventListener('keydown', globalKeyHandler);

	// æ»šåŠ¨äº‹ä»¶
	document.addEventListener('scroll', onGlobalScroll, true);

	writeToLog(`[ç³»ç»Ÿ] å®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ`);
}
window.addEventListener("load", onLoad, false);

// è®¾ç½®ç®¡ç†
function loadSettings() {
	try {
		const saved = localStorage.getItem('ircSettings');
		if (saved) {
			const settings = JSON.parse(saved);
			document.getElementById('wsUrl').value = settings.wsUrl || '';
			document.getElementById('nickInput').value = settings.nick || '';
			document.getElementById('channelInput').value = settings.channel || '';
			document.getElementById('autoReconnect').checked = settings.autoReconnect || false;
			document.getElementById('enableNotifications').checked = settings.enableNotifications !== false;
			currentTheme = settings.theme || 'auto';
			applyTheme(currentTheme);
		}
		// åŠ è½½ç”¨æˆ·å¤‡æ³¨
		const notes = localStorage.getItem('ircUserNotes');
		if (notes) {
			userNotes = new Map(JSON.parse(notes));
		}
		// åŠ è½½å¿½ç•¥åˆ—è¡¨
		const ignored = localStorage.getItem('ircIgnoredUsers');
		if (ignored) {
			ignoredUsers = new Set(JSON.parse(ignored));
		}
	} catch (e) {
		writeToLog(`[ERROR] åŠ è½½è®¾ç½®å¤±è´¥: ${e.message}`);
	}
}

function saveSettings() {
	try {
		const settings = {
			wsUrl: document.getElementById('wsUrl').value,
			nick: document.getElementById('nickInput').value,
			channel: document.getElementById('channelInput').value,
			autoReconnect: document.getElementById('autoReconnect').checked,
			enableNotifications: document.getElementById('enableNotifications').checked,
			theme: currentTheme
		};
		localStorage.setItem('ircSettings', JSON.stringify(settings));
	} catch (e) {
		writeToLog(`[ERROR] ä¿å­˜è®¾ç½®å¤±è´¥: ${e.message}`);
	}
}

// ä¸»é¢˜ç®¡ç†
function toggleTheme() {
	const themes = ['auto', 'light', 'dark'];
	const currentIndex = themes.indexOf(currentTheme);
	currentTheme = themes[(currentIndex + 1) % 3];
	applyTheme(currentTheme);
	saveSettings();
}

function applyTheme(theme) {
	const html = document.documentElement;
	if (theme === 'dark') {
		html.classList.add('dark');
	} else if (theme === 'light') {
		html.classList.remove('dark');
	} else {
		// è·Ÿéšç³»ç»Ÿ
		updateThemeDisplay();
	}
}

function updateThemeDisplay() {
	const html = document.documentElement;
	if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
		html.classList.add('dark');
	} else {
		html.classList.remove('dark');
	}
}

// é€šçŸ¥ç³»ç»Ÿ
function initNotificationSound() {
	try {
		const audioContext = new (window.AudioContext || window.webkitAudioContext)();
		notificationSound = () => {
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			oscillator.frequency.value = 800;
			oscillator.type = 'sine';
			gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + 0.3);
		};
	} catch (e) {
		writeToLog(`[WARN] æ— æ³•åˆå§‹åŒ–é€šçŸ¥éŸ³æ•ˆ: ${e.message}`);
	}
}

function showNotification(title, message, channel) {
	const enableNotifications = document.getElementById('enableNotifications').checked;
	if (!enableNotifications || !("Notification" in window)) return;

	// æ£€æŸ¥æƒé™
	if (Notification.permission === 'default') {
		Notification.requestPermission();
		return;
	}
	if (Notification.permission !== 'granted') return;

	// å¦‚æœçª—å£ä¸æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œæ˜¾ç¤ºé€šçŸ¥
	if (document.hidden) {
		try {
			const notification = new Notification(`IRC - ${channel || 'æ–°æ¶ˆæ¯'}`, {
				body: message,
				icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234F46E5"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="40" font-weight="bold">#</text></svg>',
				tag: 'irc-message'
			});
			notification.onclick = () => {
				window.focus();
				channel && Tab_Show(channel);
			};
			setTimeout(notification.close.bind(notification), 5000);
		} catch (e) {
			writeToLog(`[ERROR] æ˜¾ç¤ºé€šçŸ¥å¤±è´¥: ${e.message}`);
		}
	}

	// æ’­æ”¾æç¤ºéŸ³
	if (notificationSound) notificationSound();

	// æ˜¾ç¤ºå†…éƒ¨é€šçŸ¥
	const notificationEl = document.getElementById('notification');
	const titleEl = document.getElementById('notificationTitle');
	const messageEl = document.getElementById('notificationMessage');
	
	titleEl.textContent = title;
	messageEl.textContent = message;
	notificationEl.classList.add('visible');
	
	setTimeout(() => {
		hideNotification();
	}, 5000);
}

function hideNotification() {
	document.getElementById('notification').classList.remove('visible');
}

// å·¥å…·æç¤º
function initTooltips() {
	const tooltip = document.getElementById('globalTooltip');
	document.addEventListener('mouseover', (e) => {
		const target = e.target.closest('[data-tooltip]');
		if (target) {
			tooltip.textContent = target.dataset.tooltip;
			tooltip.classList.add('visible');
			const rect = target.getBoundingClientRect();
			let x = rect.left + rect.width / 2;
			let y = rect.top;
			x = Math.min(Math.max(x, 20), window.innerWidth - 20);
			y = Math.min(Math.max(y - 20, 20), window.innerHeight - 20);
			tooltip.style.left = `${x}px`;
			tooltip.style.top = `${y}px`;
			tooltip.style.transform = 'translateX(-50%)';
		}
	});
	
	document.addEventListener('mouseout', (e) => {
		if (e.target.closest('[data-tooltip]')) {
			tooltip.classList.remove('visible');
		}
	});
}

// æ‹–æ‹½ä¸Šä¼ 
function initDragAndDrop() {
	const dropZone = document.getElementById('fileDropZone');
	let dragTimer;

	document.addEventListener('dragover', (e) => {
		e.preventDefault();
		clearTimeout(dragTimer);
		dropZone.classList.add('visible');
	});

	document.addEventListener('dragleave', (e) => {
		e.preventDefault();
		clearTimeout(dragTimer);
		dragTimer = setTimeout(() => {
			dropZone.classList.remove('visible');
		}, 100);
	});

	document.addEventListener('drop', (e) => {
		e.preventDefault();
		dropZone.classList.remove('visible');
		clearTimeout(dragTimer);
		
		if (!activeChannel || activeChannel === statusChannel) {
			showNotification('é”™è¯¯', 'è¯·å…ˆåŠ å…¥ä¸€ä¸ªé¢‘é“', '');
			return;
		}

		const files = e.dataTransfer.files;
		if (files.length > 0) {
			handleFileUpload(files[0]);
		}
	});
}

function selectFile() {
	const input = document.createElement('input');
	input.type = 'file';
	input.onchange = (e) => {
		const file = e.target.files[0];
		if (file) handleFileUpload(file);
	};
	input.click();
}

function handleFileUpload(file) {
	if (file.size > 5 * 1024 * 1024) {
		showNotification('æ–‡ä»¶è¿‡å¤§', 'ç›®å‰åªæ”¯æŒ5MBä»¥ä¸‹çš„æ–‡ä»¶', 'ç³»ç»Ÿ');
		return;
	}

	const reader = new FileReader();
	reader.onload = (e) => {
		const data = e.target.result;
		const fileName = file.name;
		const fileSize = (file.size / 1024).toFixed(1);
		
		// ç”Ÿæˆæ–‡ä»¶åˆ†äº«é“¾æ¥ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
		const shareUrl = `https://file.io/${btoa(fileName)}`;
		const message = `ğŸ“ åˆ†äº«æ–‡ä»¶: ${fileName} (${fileSize}KB) - ${shareUrl}`;
		
		doSend("privmsg " + activeChannel.name + " :" + message + "\n");
		writeToScreen("var(--clr-blue)", message, activeChannel, nickname);
		showNotification('æ–‡ä»¶å‘é€', `å·²å‘é€æ–‡ä»¶: ${fileName}`, activeChannel.name);
	};
	reader.readAsDataURL(file);
}

// å…¨å±€å¿«æ·é”®
function globalKeyHandler(e) {
	if (e.ctrlKey) {
		switch(e.key.toLowerCase()) {
			case 'f':
				e.preventDefault();
				toggleMessageSearch();
				break;
			case 'l':
				e.preventDefault();
				toggleLog();
				break;
			case 't':
				e.preventDefault();
				toggleTheme();
				break;
		}
	} else if (e.key === 'Escape') {
		// å…³é—­æ‰€æœ‰å¼¹çª—
		document.getElementById('searchContainer').classList.remove('visible');
		document.getElementById('quickCommands').classList.remove('visible');
		document.getElementById('keyboardShortcuts').classList.remove('visible');
		document.getElementById('userContextMenu').classList.remove('visible');
	}
}

// æ¶ˆæ¯æœç´¢
function toggleMessageSearch() {
	const container = document.getElementById('searchContainer');
	container.classList.toggle('visible');
	if (container.classList.contains('visible')) {
		document.getElementById('searchInput').focus();
	}
}

function onGlobalScroll(e) {
	if (e.target.classList.contains('channelcontent') || e.target.parentElement?.classList.contains('channelcontent')) {
		checkScrollPosition();
	}
}

// è¿æ¥çŠ¶æ€ç®¡ç†
function updateConnectionStatus(connected) {
	const statusEl = document.getElementById('connectionStatus');
	const statusText = document.getElementById('statusText');
	if (!statusEl || !statusText) return;

	if (connected) {
		statusEl.classList.remove('disconnected');
		statusEl.classList.add('connected');
		statusText.textContent = `å·²è¿æ¥ (${nickname})`;
	} else {
		statusEl.classList.remove('connected');
		statusEl.classList.add('disconnected');
		statusText.textContent = 'æœªè¿æ¥';
	}
}

// æ—¥å¿—ç®¡ç†
function toggleLog() {
	const logContainer = document.getElementById('logContainer');
	if (logContainer) {
		logContainer.classList.toggle('visible');
		if (!logContainer.classList.contains('visible')) {
			logContainer.scrollTop = logContainer.scrollHeight;
		}
	}
}

function clearLog() {
	const logOutput = document.getElementById('logOutput');
	if (logOutput) {
		logOutput.textContent = '';
	}
}

function writeToLog(message, level = 'INFO') {
	const logOutput = document.getElementById('logOutput');
	if (logOutput) {
		const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
		const levelClass = `log-${level.toLowerCase()}`;
		logOutput.innerHTML += `<span class="${levelClass}">[${timestamp}] ${message}</span>\n`;
		logOutput.scrollTop = logOutput.scrollHeight;
	}
}

// SSLè­¦å‘Š
function showSSLWarning(url) {
	const warning = document.getElementById('sslWarning');
	const link = document.getElementById('sslLink');
	if (!warning || !link) return;

	let displayUrl = url || document.getElementById('wsUrl')?.value.trim();
	if (displayUrl) {
		link.href = displayUrl.replace('wss://', 'https://').replace('ws://', 'http://');
		link.textContent = link.href;
	} else {
		link.href = '#';
		link.textContent = 'è¯·å…ˆåœ¨WebSocketåœ°å€æ è¾“å…¥æœåŠ¡å™¨åœ°å€';
	}
	warning.classList.add('visible');
	setTimeout(() => {
		if (warning) warning.classList.remove('visible');
	}, 8000);
}

// è¿æ¥ç®¡ç†
function toggleConnection() {
	if (isConnected) {
		autoReconnect = false;
		const reconnectCheckbox = document.getElementById('autoReconnect');
		if (reconnectCheckbox) reconnectCheckbox.checked = false;
		if (websocket) {
			try {
				websocket.close(1000, "User disconnected");
			} catch (e) {
				writeToLog(`[ERROR] å…³é—­WebSocketæ—¶å‡ºé”™: ${e.message}`, 'ERROR');
			}
		}
		onDisconnect();
	} else {
		doConnect();
	}
}

function validateNickname(nick) {
	if (!nick || nick.trim() === "") return false;
	return /^[a-zA-Z_\\`\[\]{}^|][a-zA-Z0-9_\\`\[\]{}^|-]*$/.test(nick);
}

function validateWsUrl(url) {
	if (!url) return false;
	return /^wss?:\/\/.+/.test(url);
}

function doConnect() {
	const wsUrlInput = document.getElementById('wsUrl');
	const nickInput = document.getElementById('nickInput');
	const channelInput = document.getElementById('channelInput');
	const reconnectCheckbox = document.getElementById('autoReconnect');
	const connectBtn = document.getElementById('connectBtn');

	if (!wsUrlInput || !nickInput || !channelInput || !connectBtn) {
		alert("ç•Œé¢å…ƒç´ åŠ è½½é”™è¯¯, è¯·åˆ·æ–°é¡µé¢é‡è¯•");
		return;
	}

	wsUrl = wsUrlInput.value.trim();
	nickname = nickInput.value.trim();
	channelName = channelInput.value.trim();
	autoReconnect = reconnectCheckbox ? reconnectCheckbox.checked : false;

	if (!validateWsUrl(wsUrl)) {
		alert("WebSocketåœ°å€æ ¼å¼é”™è¯¯!å¿…é¡»ä»¥ ws:// æˆ– wss:// å¼€å¤´");
		return;
	}
	if (!validateNickname(nickname)) {
		alert("æ˜µç§°æ ¼å¼æ— æ•ˆ!å¿…é¡»ä»¥å­—æ¯æˆ–ç‰¹å®šç¬¦å·å¼€å¤´, ä¸èƒ½åŒ…å«ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦");
		return;
	}
	if (channelName && !channelName.startsWith('#')) {
		channelName = '#' + channelName;
	}

	reconnectAttempts = 0;
	wsUrlInput.disabled = true;
	nickInput.disabled = true;
	channelInput.disabled = true;
	if (reconnectCheckbox) reconnectCheckbox.disabled = true;

	connectBtn.textContent = 'è¿æ¥ä¸­...';
	connectBtn.disabled = true;

	// ä¿å­˜è®¾ç½®
	saveSettings();

	// æ¸…ç©ºç•Œé¢
	channels.innerHTML = '';
	channelContents.innerHTML = '';
	channelMap.clear();
	messageSearchIndex = [];

	// æ˜¾ç¤ºèŠå¤©åŒºåŸŸ
	contentsWrapper.classList.remove('hidden');
	contentsWrapper.classList.add('visible');
	if (emptyState) emptyState.style.display = 'none';
	if (input) input.style.display = 'block';

	statusChannel = new Tab_Create("Status", "ç³»ç»ŸçŠ¶æ€", false);
	writeToLog(`[ç³»ç»Ÿ] æ­£åœ¨è¿æ¥: ${wsUrl}`);
	WebSocket_Connect(wsUrl);
}

function onDisconnect() {
	isConnected = false;
	const wsUrlInput = document.getElementById('wsUrl');
	const nickInput = document.getElementById('nickInput');
	const channelInput = document.getElementById('channelInput');
	const reconnectCheckbox = document.getElementById('autoReconnect');
	const connectBtn = document.getElementById('connectBtn');

	if (wsUrlInput) wsUrlInput.disabled = false;
	if (nickInput) nickInput.disabled = false;
	if (channelInput) channelInput.disabled = false;
	if (reconnectCheckbox) reconnectCheckbox.disabled = false;

	if (connectBtn) {
		connectBtn.textContent = 'è¿æ¥';
		connectBtn.disabled = false;
		connectBtn.classList.remove('disconnect');
	}

	updateConnectionStatus(false);

	// éšè—èŠå¤©åŒºåŸŸ
	contentsWrapper.classList.remove('visible');
	contentsWrapper.classList.add('hidden');
	if (emptyState) emptyState.style.display = 'flex';
	if (input) input.style.display = 'none';

	writeToScreen("status", "DISCONNECTED", statusChannel, "");
	writeToLog(`[ç³»ç»Ÿ] å·²æ–­å¼€è¿æ¥`);

	if (autoReconnect && reconnectAttempts < maxReconnectAttempts) {
		reconnectAttempts++;
		const delay = reconnectDelay * reconnectAttempts;
		writeToLog(`[é‡è¿] ${Math.floor(delay / 1000)}ç§’åå°è¯•ç¬¬ ${reconnectAttempts}/${maxReconnectAttempts} æ¬¡é‡è¿...`);
		setTimeout(() => {
			if (!isConnected && autoReconnect) {
				writeToLog(`[é‡è¿] æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...`);
				doConnect();
			}
		}, delay);
	} else if (autoReconnect && reconnectAttempts >= maxReconnectAttempts) {
		writeToLog(`[é‡è¿] è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°, åœæ­¢å°è¯•`, 'WARN');
		autoReconnect = false;
		if (reconnectCheckbox) reconnectCheckbox.checked = false;
		showNotification('é‡è¿å¤±è´¥', 'è‡ªåŠ¨é‡è¿å¤±è´¥, è¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨è®¾ç½®', 'ç³»ç»Ÿ');
	}
}

// é”®ç›˜äº‹ä»¶
function onKeyDown(e) {
	if (e.key === 'Enter') {
		const suggestions = document.getElementById('commandSuggestions');
		if (suggestions.classList.contains('visible')) {
			const selected = suggestions.querySelector('.suggestion-item.active');
			if (selected) {
				input.value = selected.dataset.command + ' ';
				suggestions.classList.remove('visible');
				input.focus();
				return;
			}
		}
		send();
	} else if (e.key === 'Tab') {
		e.preventDefault();
		handleTabComplete();
	} else if (e.key === 'ArrowUp' && !input.value && messageHistory.length > 0) {
		e.preventDefault();
		currentHistoryIndex = Math.min(currentHistoryIndex + 1, messageHistory.length - 1);
		input.value = messageHistory[messageHistory.length - 1 - currentHistoryIndex];
	} else if (e.key === 'ArrowDown' && currentHistoryIndex >= 0) {
		e.preventDefault();
		currentHistoryIndex = Math.max(currentHistoryIndex - 1, -1);
		input.value = currentHistoryIndex >= 0 ? messageHistory[messageHistory.length - 1 - currentHistoryIndex] : '';
	} else {
		currentHistoryIndex = -1;
	}

	// éšè—å‘½ä»¤å»ºè®®
	if (e.key !== '/' && !input.value.startsWith('/')) {
		document.getElementById('commandSuggestions').classList.remove('visible');
	}
}

function onInputChange() {
	const value = input.value;
	if (value.startsWith('/')) {
		showCommandSuggestions(value.substring(1));
	} else {
		document.getElementById('commandSuggestions').classList.remove('visible');
	}
}

function handleTabComplete() {
	const text = input.value;
	const cursorPos = input.selectionStart;
	const beforeCursor = text.substring(0, cursorPos);
	const parts = beforeCursor.split(' ');
	const currentWord = parts[parts.length - 1];

	if (currentWord.length > 0 && activeChannel && activeChannel.users) {
		// æ˜µç§°è¡¥å…¨
		const matches = activeChannel.users.filter(user => 
			user[1].toLowerCase().startsWith(currentWord.toLowerCase())
		);
		if (matches.length === 1) {
			const completion = matches[0][1];
			parts[parts.length - 1] = completion;
			input.value = parts.join(' ') + text.substring(cursorPos);
			input.setSelectionRange(parts.join(' ').length, parts.join(' ').length);
		} else if (matches.length > 1) {
			showNotification('è‡ªåŠ¨è¡¥å…¨', `å¯èƒ½çš„åŒ¹é…: ${matches.map(m => m[1]).join(', ')}`, 'ç³»ç»Ÿ');
		}
	}
}

function showCommandSuggestions(query) {
	const suggestions = document.getElementById('commandSuggestions');
	const matches = availableCommands.filter(cmd => 
		cmd.cmd.includes(query.toLowerCase())
	);
	
	if (matches.length === 0) {
		suggestions.classList.remove('visible');
		return;
	}

	suggestions.innerHTML = matches.map((cmd, index) => `
		<div class="suggestion-item ${index === 0 ? 'active' : ''}" 
			 data-command="${cmd.cmd}"
			 onmouseover="this.classList.add('active');"
			 onmouseout="this.classList.remove('active');"
			 onclick="selectCommand('${cmd.cmd}')">
			<span><strong>${cmd.cmd}</strong> - ${cmd.desc}</span>
			<span class="desc">${cmd.usage}</span>
		</div>
	`).join('');
	
	suggestions.classList.add('visible');
}

function selectCommand(command) {
	input.value = command + ' ';
	document.getElementById('commandSuggestions').classList.remove('visible');
	input.focus();
}

// Tabç®¡ç†
function Tab_onClick(evt) {
	if (!evt || !evt.currentTarget) return;
	let chanName = evt.currentTarget.value;
	Tab_Show(chanName);
}

function Tabs_Hide() {
	let tabcontent = document.querySelectorAll(".channelcontent");
	tabcontent.forEach(content => content.classList.remove('active'));

	let tablinks = document.querySelectorAll(".channel");
	tablinks.forEach(link => {
		link.classList.remove("active");
		// æ¸…é™¤æœªè¯»æ ‡è®°
		const badge = link.querySelector('.unread-badge');
		if (badge) badge.remove();
	});
}

function Tab_Show(name) {
	if (!name) return;
	let channel = channelMap.get(name);
	Tabs_Hide();
	if (channel && channel.channel) {
		channel.channel.classList.add('active');
		channel.button.classList.add("active");
		activeChannel = channel;
		// æ¸…é™¤æœªè¯»è®¡æ•°
		unreadCounts.set(name, 0);
		// æ»šåŠ¨åˆ°åº•éƒ¨
		setTimeout(() => {
			if (channel.content) {
				channel.content.scrollTop = channel.content.scrollHeight;
			}
		}, 10);
	}
}

function Tab_Close(evt) {
	evt.stopPropagation();
	if (!evt || !evt.currentTarget) return;
	const chanName = evt.currentTarget.value;
	
	// ç¡®è®¤å¯¹è¯æ¡†
	if (chanName !== 'Status') {
		const confirm = window.confirm(`ç¡®å®šè¦ç¦»å¼€é¢‘é“ ${chanName} å—?`);
		if (!confirm) return;
	}
	
	doSend("part " + chanName);
	Channel_Destroy(chanName);
}

function Tab_Create(name, topic, createlist) {
	if (!name || !channels || !channelContents) {
		console.error("Tab_Create: ç¼ºå°‘å¿…è¦å…ƒç´ ");
		return null;
	}
	
	// é˜²æ­¢é‡å¤åˆ›å»º
	if (channelMap.has(name)) {
		Tab_Show(name);
		return channelMap.get(name);
	}
	
	Tabs_Hide();
	this.name = name;
	let escapedName = HTML_escape(name);

	this.button = document.createElement("button");
	this.button.innerHTML = escapedName + '<span class="unread-badge" style="display: none;">0</span>';
	this.button.value = escapedName;
	this.button.onclick = Tab_onClick;
	this.button.className = "channel";

	let x = document.createElement("button");
	x.innerHTML = "Ã—";
	x.onclick = Tab_Close;
	x.value = escapedName;
	x.className = "x";
	this.button.appendChild(x);

	channels.appendChild(this.button);

	this.channel = document.createElement("div");
	this.channel.className = "channelcontent";

	let navWrapper = document.createElement("nav");
	this.topic = document.createElement("h3");
	this.topic.innerHTML = HTML_escape(topic || "æ— ä¸»é¢˜");
	navWrapper.appendChild(this.topic);

	this.content = document.createElement("nav");
	this.content.addEventListener('scroll', checkScrollPosition);
	navWrapper.appendChild(this.content);

	this.channel.appendChild(navWrapper);

	if (createlist) {
		this.userlist = document.createElement("ul");
		this.users = [];
		this.names_end = true;
		this.channel.appendChild(this.userlist);
	}

	channelContents.appendChild(this.channel);
	channelMap.set(name, this);
	activeChannel = this;
	Tab_Show(name);
	
	// åˆå§‹åŒ–è¯¥é¢‘é“çš„æœªè¯»è®¡æ•°
	unreadCounts.set(name, 0);
	
	return this;
}

function Channel_Destroy(name) {
	if (!name) return;
	let channel = channelMap.get(name);
	if (!channel) return;
	channel.button.remove();
	channel.channel.remove();
	if (activeChannel == channel) {
		activeChannel = statusChannel;
	}
	channelMap.delete(name);
	unreadCounts.delete(name);
	if (activeChannel) {
		Tab_Show(activeChannel.name);
	}
}

function Channel_InsertUser(nick, channel, prefix) {
	if (!nick || !channel || !channel.userlist) return;
	
	// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
	for (let i = 0; i < channel.users.length; i++) {
		if (channel.users[i] && channel.users[i][1] === nick) {
			return;
		}
	}
	
	let user = document.createElement("li");
	user.className = 'user-list-item';
	user.dataset.nick = nick;
	user.oncontextmenu = (e) => showUserContextMenu(e, nick);
	
	let avatar = document.createElement("div");
	avatar.className = 'user-avatar-small';
	avatar.textContent = nick.charAt(0).toUpperCase();
	
	let prefixEl = document.createElement("span");
	prefixEl.className = 'user-prefix';
	if (prefix && prefix !== " ") prefixEl.textContent = prefix[0];
	
	avatar.appendChild(prefixEl);
	user.appendChild(avatar);
	
	let nickEl = document.createElement("span");
	nickEl.className = 'user-nick';
	nickEl.textContent = nick;
	user.appendChild(nickEl);
	
	let statusEl = document.createElement("span");
	statusEl.className = 'user-status';
	statusEl.title = 'åœ¨çº¿';
	user.appendChild(statusEl);
	
	let i = 0;
	for (i; i < channel.users.length; i++) {
		if (channel.users[i] && channel.users[i][1]) {
			if (channel.users[i][1].localeCompare(nick, undefined, { sensitivity: 'accent' }) < 0) continue;
		}
		break;
	}
	channel.users.splice(i, 0, [prefix || " ", nick]);
	channel.userlist.insertBefore(user, channel.userlist.childNodes[i]);
	
	// æ·»åŠ å¤´åƒå·¥å…·æç¤º
	user.dataset.tooltip = userNotes.get(nick) || 'å³é”®æŸ¥çœ‹æ›´å¤šé€‰é¡¹';
}

function Channel_AppendUser(nick, channel, dontnotify, prefix) {
	if (!nick || !channel || !channel.userlist) return;
	
	// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
	if (channel.users.some(u => u[1] === nick)) return;
	
	let user = document.createElement("li");
	user.className = 'user-list-item';
	user.dataset.nick = nick;
	user.oncontextmenu = (e) => showUserContextMenu(e, nick);
	
	let avatar = document.createElement("div");
	avatar.className = 'user-avatar-small';
	avatar.textContent = nick.charAt(0).toUpperCase();
	
	let prefixEl = document.createElement("span");
	prefixEl.className = 'user-prefix';
	if (prefix && prefix !== " ") prefixEl.textContent = prefix[0];
	
	avatar.appendChild(prefixEl);
	user.appendChild(avatar);
	
	let nickEl = document.createElement("span");
	nickEl.className = 'user-nick';
	nickEl.textContent = nick;
	user.appendChild(nickEl);
	
	let statusEl = document.createElement("span");
	statusEl.className = 'user-status';
	statusEl.title = 'åœ¨çº¿';
	user.appendChild(statusEl);
	
	channel.userlist.appendChild(user);
	channel.users.push([prefix || " ", nick]);
	
	// æ·»åŠ å¤´åƒå·¥å…·æç¤º
	user.dataset.tooltip = userNotes.get(nick) || 'å³é”®æŸ¥çœ‹æ›´å¤šé€‰é¡¹';
}

function Channel_RemoveUser(nick, channel) {
	if (!nick || !channel || !channel.userlist) return;
	for (let i = 0; i < channel.userlist.children.length; i++) {
		let userItem = channel.userlist.children[i];
		if (!userItem || !userItem.dataset.nick) continue;
		let anick = userItem.dataset.nick;
		if (anick == nick) {
			userItem.remove();
			if (channel.users && channel.users[i]) {
				channel.users.splice(i, 1);
			}
			return true;
		}
	}
	return false;
}

function Channel_RenameUser(nick, newnick, channel) {
	if (!nick || !newnick || !channel) return false;
	if (!channel.userlist) return false;
	for (let i = 0; i < channel.users.length; i++) {
		if (channel.users[i] && channel.users[i][1] == nick) {
			let prefix = channel.users[i][0];
			Channel_RemoveUser(nick, channel);
			Channel_InsertUser(newnick, channel, prefix);
			return true;
		}
	}
	return false;
}

function Channel_UpdateUserPrefix(nick, channel, add, prefix) {
	if (!nick || !channel || !channel.users || !PrefixChars) return;
	for (let i = 0; i < channel.users.length; i++) {
		if (channel.users[i] && channel.users[i][1] == nick) {
			let pos = PrefixChars[0].indexOf(prefix);
			if (pos < 0) return;
			let prefixes = "";
			if (add == "true" || add === true) {
				let ii;
				for (ii = 0; ii < channel.users[i][0].length; ii++) {
					if (PrefixChars[1].indexOf(channel.users[i][0][ii]) >= pos) break;
					prefixes += channel.users[i][0][ii];
				}
				prefixes += PrefixChars[1][pos];
				for (; ii < channel.users[i][0].length; ii++) {
					prefixes += channel.users[i][0][ii];
				}
			} else {
				let tmp = channel.users[i][0].indexOf(PrefixChars[1][pos]);
				if (tmp >= 0) {
					prefixes = channel.users[i][0].substring(0, tmp) + channel.users[i][0].substring(tmp + 1);
				}
			}
			if (prefixes == "") prefixes = " ";
			channel.users[i][0] = prefixes;
			Channel_RenameUser(nick, nick, channel);
			break;
		}
	}
}

// æ¶ˆæ¯æ˜¾ç¤º
function writeToScreen(type, message, channel, username) {
	if (!channel || !channel.content) return;
	
	// åº”ç”¨å¿½ç•¥è§„åˆ™
	if (username && ignoredUsers.has(username)) return;
	
	const now = new Date();
	const messageId = `${channel.name}-${now.getTime()}-${Math.random().toString(36).substr(2, 9)}`;
	
	const messageEl = document.createElement("div");
	messageEl.className = 'message';
	messageEl.dataset.timestamp = now.getTime();
	messageEl.dataset.id = messageId;
	
	// æ¶ˆæ¯æœç´¢ç´¢å¼•
	messageSearchIndex.push({
		id: messageId,
		content: `${username} ${message}`.toLowerCase(),
		channel: channel.name,
		timestamp: now.getTime()
	});
	
	// ç”¨æˆ·å¤´åƒ
	let displayUsername = username;
	if (username === "*" || username === "-") {
		displayUsername = 'ç³»ç»Ÿ';
	} else if (username === nickname) {
		displayUsername = nickname;
	}
	
	const avatar = document.createElement("div");
	avatar.className = 'message-avatar';
	avatar.textContent = displayUsername.charAt(0).toUpperCase();
	
	const content = document.createElement("div");
	content.className = 'message-content';
	
	const header = document.createElement("div");
	header.className = 'message-header';
	
	const usernameEl = document.createElement("span");
	usernameEl.className = 'message-username';
	usernameEl.textContent = displayUsername;
	
	const timestampEl = document.createElement("span");
	timestampEl.className = 'message-timestamp';
	timestampEl.textContent = formatTime(now);
	
	header.appendChild(usernameEl);
	header.appendChild(timestampEl);
	
	const textEl = document.createElement("p");
	textEl.className = 'message-text';
	
	let displayMessage = '';
	if (type === 'status') {
		textEl.style.color = 'var(--clr-brown)';
		displayMessage = message;
	} else if (username === '*' || username === '-') {
		textEl.className = 'message-text message-action';
		textEl.style.color = 'var(--clr-gold)';
		displayMessage = message;
	} else if (message.includes('åŠ å…¥é¢‘é“') || message.includes('ç¦»å¼€é¢‘é“') || message.includes('æ›´åä¸º')) {
		textEl.style.color = 'var(--clr-green)';
		displayMessage = message;
	} else if (message.includes('è¸¢å‡º')) {
		textEl.style.color = 'var(--clr-red)';
		displayMessage = message;
	} else {
		textEl.style.color = 'var(--clr-font)';
		displayMessage = username ? `${username}: ${linkify(message)}` : linkify(message);
	}
	
	textEl.innerHTML = displayMessage;
	
	content.appendChild(header);
	content.appendChild(textEl);
	messageEl.appendChild(avatar);
	messageEl.appendChild(content);
	
	let output = channel.content;
	if (output) {
		output.appendChild(messageEl);
		
		// é™åˆ¶æ¶ˆæ¯æ•°é‡
		while (output.children.length > 300) {
			const removed = output.children[0];
			if (removed.dataset.id) {
				messageSearchIndex = messageSearchIndex.filter(m => m.id !== removed.dataset.id);
			}
			output.removeChild(removed);
		}
		
		// è‡ªåŠ¨æ»šåŠ¨
		const isScrolledToBottom = output.scrollHeight - output.clientHeight <= output.scrollTop + 100;
		if (isScrolledToBottom) {
			requestAnimationFrame(() => {
				output.scrollTop = output.scrollHeight;
				messageEl.scrollIntoView({ behavior: 'smooth', block: 'end' });
			});
		} else if (username && username !== nickname) {
			// æ˜¾ç¤ºæ»šåŠ¨æç¤º
			showScrollIndicator();
			// æ›´æ–°æœªè¯»è®¡æ•°
			if (!channel.channel.classList.contains('active')) {
				const unread = (unreadCounts.get(channel.name) || 0) + 1;
				unreadCounts.set(channel.name, unread);
				updateUnreadBadge(channel.name, unread);
			}
		}
	}
}

function linkify(text) {
	// URLé“¾æ¥
	const urlRegex = /(https?:\/\/[^\s<>{}|\\^`[\]]+)/g;
	text = text.replace(urlRegex, function (url) {
		return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--clr-accent); text-decoration: underline; word-break: break-all;">${url}</a>`;
	});
	
	// é¢‘é“é“¾æ¥
	const channelRegex = /(#[\w-]+)/g;
	text = text.replace(channelRegex, function (chan) {
		return `<a href="#" onclick="joinChannel('${chan}'); return false;" style="color: var(--clr-purple); font-weight: 600;">${chan}</a>`;
	});
	
	return text;
}

function formatTime(date) {
	const now = new Date();
	const diff = now - date;
	
	if (diff < 60000) return 'åˆšåˆš';
	if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
	if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
	if (diff < 604800000) return `${Math.floor(diff / 86400000)}å¤©å‰`;
	
	return date.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
}

function updateUnreadBadge(channelName, count) {
	const button = channels.querySelector(`[value="${channelName}"]`);
	if (button) {
		let badge = button.querySelector('.unread-badge');
		if (!badge) {
			badge = document.createElement('span');
			badge.className = 'unread-badge';
			button.appendChild(badge);
		}
		badge.textContent = count;
		badge.style.display = count > 0 ? 'block' : 'none';
		button.classList.toggle('unread', count > 0);
	}
}

function showScrollIndicator() {
	const indicator = document.getElementById('scrollIndicator');
	if (!indicator) return;
	indicator.classList.add('visible');
	setTimeout(() => indicator.classList.remove('visible'), 5000);
}

function scrollToBottom() {
	if (activeChannel && activeChannel.content) {
		activeChannel.content.scrollTop = activeChannel.content.scrollHeight;
		document.getElementById('scrollIndicator').classList.remove('visible');
	}
}

function checkScrollPosition() {
	const output = activeChannel?.content;
	if (!output) return;
	const isAtBottom = output.scrollHeight - output.clientHeight <= output.scrollTop + 100;
	if (isAtBottom) {
		document.getElementById('scrollIndicator').classList.remove('visible');
		unreadCounts.set(activeChannel.name, 0);
		updateUnreadBadge(activeChannel.name, 0);
	}
}

// æ¶ˆæ¯å‘é€
function send() {
	let text = input ? input.value.trim() : "";
	if (!text || !activeChannel) return;
	
	// ä¿å­˜åˆ°å†å²
	if (text) {
		messageHistory.unshift(text);
		if (messageHistory.length > 50) messageHistory.pop();
		currentHistoryIndex = -1;
	}
	
	let msg;
	if (text[0] == "/") {
		handleCommand(text.substring(1));
	} else {
		msg = "privmsg " + activeChannel.name + " :" + text + "\n";
		writeToScreen("normal", text, activeChannel, nickname);
	}
	
	if (msg) {
		doSend(msg);
	}
	if (input) input.value = "";
	document.getElementById('commandSuggestions').classList.remove('visible');
}

function handleCommand(command) {
	const parts = command.split(' ');
	const cmd = parts[0].toUpperCase();
	const args = parts.slice(1).join(' ');
	
	switch(cmd) {
		case 'ME':
			if (args) {
				doSend("privmsg " + activeChannel.name + " :\x