<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>IRC Web Client</title>
	<style>
		/* 设计系统 - 颜色变量 */
		:root {
			/* 背景色 */
			--bg-primary: #F5F7FA;
			--bg-secondary: #E4E7F4;
			--bg-tertiary: #FFFFFF;
			--bg-quaternary: #D1D5DB;
			
			/* 文字颜色 */
			--text-primary: #1F2937;
			--text-secondary: #6B7280;
			--text-tertiary: #9CA3AF;
			
			/* 功能色 */
			--accent-primary: #4F46E5;
			--accent-secondary: #7C3AED;
			--accent-hover: #4338CA;
			--success: #10B981;
			--warning: #F59E0B;
			--error: #DC2626;
			--info: #2563EB;
			
			/* 频道颜色 */
			--color-brown: #92400E;
			--color-green: #065F46;
			--color-gold: #D97706;
			--color-red: #DC2626;
			--color-purple: #7C3AED;
			--color-blue: #2563EB;
			
			/* 边框 */
			--border-color: #E5E7EB;
			--border-radius: 8px;
			--border-radius-sm: 4px;
			--border-radius-lg: 12px;
			
			/* 间距 */
			--space-xs: 4px;
			--space-sm: 8px;
			--space-md: 12px;
			--space-lg: 16px;
			--space-xl: 20px;
			--space-2xl: 24px;
			
			/* 阴影 */
			--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
			--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
			--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
			
			/* 动画 */
			--transition-fast: 0.15s ease;
			--transition-normal: 0.2s ease;
			--transition-slow: 0.3s ease;
			
			/* 字体 */
			--font-size-xs: 11px;
			--font-size-sm: 12px;
			--font-size-base: 14px;
			--font-size-lg: 16px;
			--font-size-xl: 18px;
			--font-weight-normal: 400;
			--font-weight-medium: 500;
			--font-weight-semibold: 600;
			--font-weight-bold: 700;
		}

		/* 深色模式 */
		@media (prefers-color-scheme: dark) {
			:root {
				--bg-primary: #111827;
				--bg-secondary: #1F2937;
				--bg-tertiary: #1F2937;
				--bg-quaternary: #4B5563;
				
				--text-primary: #F9FAFB;
				--text-secondary: #D1D5DB;
				--text-tertiary: #9CA3AF;
				
				--accent-primary: #818CF8;
				--accent-secondary: #C4B5FD;
				--accent-hover: #6366F1;
				--success: #6EE7B7;
				--warning: #FCD34D;
				--error: #FCA5A5;
				--info: #93C5FD;
				
				--color-brown: #FDE68A;
				--color-green: #6EE7B7;
				--color-gold: #FBBF24;
				--color-red: #FCA5A5;
				--color-purple: #C4B5FD;
				--color-blue: #93C5FD;
				
				--border-color: #374151;
			}
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		html, body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			height: 100%;
			background-color: var(--bg-primary);
			color: var(--text-primary);
			font-size: var(--font-size-base);
			line-height: 1.5;
			overflow: hidden;
		}

		/* 主容器 - 使用flexbox确保兼容性 */
		.main {
			display: flex;
			flex-direction: column;
			height: 100vh;
			width: 100%;
		}

		/* 头部 */
		.header {
			background: linear-gradient(90deg, var(--bg-secondary), var(--bg-primary));
			padding: var(--space-md) var(--space-lg);
			border-bottom: 1px solid var(--border-color);
			box-shadow: var(--shadow-sm);
			flex: 0 0 auto;
		}

		.header h1 {
			font-size: var(--font-size-xl);
			font-weight: var(--font-weight-bold);
			color: var(--text-primary);
		}

		/* 设置栏 */
		.settings-bar {
			background-color: var(--bg-secondary);
			padding: var(--space-md) var(--space-lg);
			display: flex;
			align-items: center;
			gap: var(--space-md);
			overflow-x: auto;
			border-bottom: 1px solid var(--border-color);
			flex: 0 0 auto;
			min-height: 60px;
		}

		.settings-group {
			display: flex;
			flex-direction: column;
			gap: var(--space-xs);
			flex: 0 0 auto;
		}

		.settings-group label {
			font-size: var(--font-size-xs);
			font-weight: var(--font-weight-medium);
			color: var(--text-secondary);
			white-space: nowrap;
		}

		.settings-group input[type="text"] {
			padding: var(--space-sm) var(--space-md);
			background-color: var(--bg-tertiary);
			color: var(--text-primary);
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius-sm);
			font-size: var(--font-size-sm);
			min-width: 140px;
			transition: var(--transition-fast);
		}

		.settings-group input[type="text"]:focus {
			outline: none;
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
		}

		.settings-group input[type="checkbox"] {
			width: 16px;
			height: 16px;
			cursor: pointer;
			accent-color: var(--accent-primary);
		}

		/* 按钮样式 */
		.btn {
			padding: var(--space-sm) var(--space-md);
			border: none;
			border-radius: var(--border-radius-sm);
			cursor: pointer;
			font-weight: var(--font-weight-medium);
			font-size: var(--font-size-sm);
			transition: var(--transition-fast);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			white-space: nowrap;
			box-shadow: var(--shadow-sm);
		}

		.btn:active {
			transform: translateY(1px);
			box-shadow: var(--shadow-sm);
		}

		.connect-btn {
			background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
			color: white;
			font-weight: var(--font-weight-semibold);
		}

		.connect-btn:hover:not(:disabled) {
			background: linear-gradient(135deg, var(--accent-hover), var(--accent-secondary));
			box-shadow: var(--shadow-md);
		}

		.connect-btn:disabled {
			background: var(--bg-quaternary);
			color: var(--text-tertiary);
			cursor: not-allowed;
			box-shadow: none;
		}

		.connect-btn.disconnect {
			background: linear-gradient(135deg, var(--error), #EF4444);
		}

		.log-toggle-btn {
			background-color: var(--bg-tertiary);
			color: var(--text-primary);
			border: 1px solid var(--border-color);
		}

		.log-toggle-btn:hover {
			background-color: var(--accent-primary);
			color: white;
			border-color: var(--accent-primary);
		}

		.ssl-help-btn {
			background: linear-gradient(135deg, var(--warning), #F59E0B);
			color: #000;
			font-weight: var(--font-weight-semibold);
		}

		.ssl-help-btn:hover {
			box-shadow: var(--shadow-md);
		}

		/* 连接状态 */
		.connection-status {
			display: inline-flex;
			align-items: center;
			gap: var(--space-sm);
			padding: var(--space-xs) var(--space-md);
			background-color: var(--bg-tertiary);
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius-sm);
			font-size: var(--font-size-xs);
			font-weight: var(--font-weight-medium);
			color: var(--text-secondary);
			margin-left: auto;
			transition: var(--transition-fast);
		}

		.connection-status.connected {
			border-color: var(--success);
			background-color: rgba(16, 185, 129, 0.1);
			color: var(--success);
		}

		.connection-status.disconnected {
			border-color: var(--error);
			background-color: rgba(220, 38, 38, 0.1);
			color: var(--error);
		}

		.connection-status .indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background-color: currentColor;
			animation: pulse 2s infinite;
		}

		.connection-status.connected .indicator {
			animation: none;
		}

		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.5; }
		}

		/* SSL警告 */
		.ssl-warning {
			position: fixed;
			bottom: var(--space-lg);
			right: var(--space-lg);
			max-width: 380px;
			background: linear-gradient(135deg, var(--warning), #F59E0B);
			color: #000;
			padding: var(--space-md);
			border-radius: var(--border-radius);
			font-size: var(--font-size-sm);
			z-index: 1000;
			box-shadow: var(--shadow-lg);
			line-height: 1.5;
			transform: translateY(100px);
			opacity: 0;
			transition: var(--transition-slow);
		}

		.ssl-warning.visible {
			transform: translateY(0);
			opacity: 1;
		}

		.ssl-warning strong {
			display: block;
			margin-bottom: var(--space-xs);
		}

		.ssl-warning a {
			color: #000;
			font-weight: var(--font-weight-semibold);
			text-decoration: underline;
		}

		.ssl-warning code {
			background: rgba(0, 0, 0, 0.1);
			padding: 2px 4px;
			border-radius: 3px;
			font-family: 'Consolas', 'Monaco', monospace;
			font-size: var(--font-size-xs);
		}

		/* 日志容器 */
		.log-container {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: var(--bg-tertiary);
			border-bottom: 2px solid var(--accent-primary);
			display: none;
			flex-direction: column;
			z-index: 100;
			box-shadow: var(--shadow-lg);
		}

		.log-container.visible {
			display: flex;
		}

		.log-header {
			flex: 0 0 auto;
			padding: var(--space-sm) var(--space-md);
			background-color: var(--bg-secondary);
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-weight: var(--font-weight-semibold);
			font-size: var(--font-size-sm);
			min-height: 40px;
		}

		.log-controls {
			display: flex;
			gap: var(--space-xs);
		}

		.log-controls button {
			padding: var(--space-xs) var(--space-sm);
			background-color: var(--bg-quaternary);
			border: none;
			border-radius: var(--border-radius-sm);
			cursor: pointer;
			font-size: var(--font-size-xs);
			transition: var(--transition-fast);
		}

		.log-controls button:hover {
			background-color: var(--accent-primary);
			color: white;
		}

		#logOutput {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--space-sm);
			font-size: var(--font-size-xs);
			font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
			background-color: var(--bg-tertiary);
			color: var(--text-primary);
			white-space: pre-wrap;
			word-wrap: break-word;
			line-height: 1.5;
		}

		#logOutput:empty::before {
			content: '日志为空...';
			color: var(--text-tertiary);
			font-style: italic;
		}

		/* 聊天容器 - 修复为三栏flex布局 */
		.chat-container {
			flex: 1 1 auto;
			display: flex;
			flex-direction: row;
			overflow: hidden;
			position: relative;
			min-height: 0;
		}

		/* 频道列表 - 左侧边栏 */
		.channels {
			flex: 0 0 220px;
			background-color: var(--bg-secondary);
			border-right: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			padding: var(--space-sm);
			gap: var(--space-xs);
			overflow-y: auto;
			min-height: 0;
		}

		.channel {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: var(--space-sm) var(--space-md);
			background-color: var(--bg-tertiary);
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius-sm);
			cursor: pointer;
			font-weight: var(--font-weight-medium);
			font-size: var(--font-size-sm);
			transition: var(--transition-fast);
		}

		.channel:hover {
			background-color: var(--bg-quaternary);
			border-color: var(--accent-primary);
			transform: translateX(2px);
		}

		.channel.active {
			background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
			color: white;
			border-color: var(--accent-primary);
			box-shadow: var(--shadow-md);
		}

		.channel button.x {
			background: none;
			border: none;
			color: inherit;
			cursor: pointer;
			padding: 2px 6px;
			font-weight: var(--font-weight-bold);
			border-radius: var(--border-radius-sm);
			font-size: var(--font-size-base);
			transition: var(--transition-fast);
			line-height: 1;
		}

		.channel button.x:hover {
			background-color: rgba(255, 255, 255, 0.2);
			transform: scale(1.1);
		}

		/* 频道内容区域 - 中间主区域 */
		.channelcontents-wrapper {
			flex: 1 1 auto;
			display: none;
			flex-direction: column;
			min-height: 0;
		}

		.channelcontents-wrapper.visible {
			display: flex;
		}

		.channelcontents-wrapper.hidden {
			display: none;
		}

		.channelcontents {
			display: flex;
			flex-direction: column;
			width: 100%;
			height: 100%;
			min-height: 0;
		}

		.channelcontent {
			flex: 1 1 auto;
			display: none;
			flex-direction: column;
			min-height: 0;
		}

		.channelcontent.active {
			display: flex;
		}

		.channelcontent nav {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
			background-color: var(--bg-tertiary);
			overflow: hidden;
		}

		.channelcontent nav h3 {
			flex: 0 0 auto;
			padding: var(--space-md);
			background-color: var(--bg-secondary);
			border-bottom: 1px solid var(--border-color);
			font-weight: var(--font-weight-semibold);
			font-size: var(--font-size-base);
			min-height: 48px;
			display: flex;
			align-items: center;
			color: var(--text-primary);
		}

		.channelcontent nav nav {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--space-sm);
		}

		/* 用户列表 - 右侧边栏 */
		.userlist-container {
			flex: 0 0 200px;
			background-color: var(--bg-secondary);
			border-left: 1px solid var(--border-color);
			display: none;
			flex-direction: column;
			min-height: 0;
		}

		.userlist-container.visible {
			display: flex;
		}

		.userlist-header {
			padding: var(--space-md);
			font-weight: var(--font-weight-semibold);
			font-size: var(--font-size-sm);
			border-bottom: 1px solid var(--border-color);
			flex: 0 0 auto;
			background-color: var(--bg-secondary);
			color: var(--text-primary);
		}

		ul {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--space-sm);
			list-style: none;
			background-color: var(--bg-tertiary);
			min-height: 0;
		}

		.channelcontents li {
			padding: var(--space-xs) var(--space-sm);
			margin: 2px 0;
			display: flex;
			gap: var(--space-sm);
			border-radius: var(--border-radius-sm);
			transition: var(--transition-fast);
			font-size: var(--font-size-sm);
		}

		.channelcontents li:hover {
			background-color: var(--bg-secondary);
		}

		.channelcontents li p {
			margin: 0;
		}

		.channelcontents li p:first-child {
			width: 20px;
			color: var(--color-purple);
			font-weight: var(--font-weight-bold);
			text-align: center;
		}

		.channelcontents li p:nth-child(2) {
			flex: 1;
			color: var(--color-green);
		}

		/* 消息样式 */
		.channelcontent nav p {
			margin: 0;
			padding: var(--space-xs) 0;
			line-height: 1.6;
			font-size: var(--font-size-sm);
		}

		/* 输入框 - 固定在底部 */
		.input-container {
			flex: 0 0 auto;
			padding: var(--space-sm) var(--space-lg);
			background-color: var(--bg-secondary);
			border-top: 1px solid var(--border-color);
		}

		#input {
			width: 100%;
			padding: var(--space-md);
			background-color: var(--bg-tertiary);
			color: var(--text-primary);
			border: 1px solid var(--border-color);
			border-radius: var(--border-radius);
			font-size: var(--font-size-base);
			transition: var(--transition-fast);
		}

		#input:focus {
			outline: none;
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
		}

		#input::placeholder {
			color: var(--text-tertiary);
		}

		/* 空状态 */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			color: var(--text-tertiary);
			text-align: center;
			padding: var(--space-lg);
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
		}

		.empty-state h3 {
			margin: 0 0 var(--space-sm) 0;
			font-size: var(--font-size-lg);
			font-weight: var(--font-weight-semibold);
			color: var(--text-secondary);
		}

		.empty-state p {
			margin: 0;
			font-size: var(--font-size-sm);
		}

		/* 滚动条 */
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}

		::-webkit-scrollbar-track {
			background: var(--bg-primary);
		}

		::-webkit-scrollbar-thumb {
			background: var(--accent-primary);
			border-radius: var(--border-radius-sm);
		}

		::-webkit-scrollbar-thumb:hover {
			background: var(--accent-hover);
		}

		/* 响应式设计 - 修复移动端布局 */
		@media (max-width: 1024px) {
			.userlist-container {
				display: none !important;
			}
		}

		@media (max-width: 768px) {
			.settings-bar {
				flex-wrap: wrap;
				padding: var(--space-sm);
				gap: var(--space-sm);
				min-height: auto;
			}
			
			.settings-group {
				flex: 1 1 45%;
				min-width: 120px;
			}
			
			.settings-group input[type="text"] {
				min-width: 100%;
			}
			
			.connection-status {
				margin-left: 0;
				flex: 1 1 100%;
				justify-content: center;
				margin-top: var(--space-xs);
			}
			
			.channels {
				flex: 0 0 180px;
			}
			
			.log-container {
				height: 50vh;
			}
		}

		@media (max-width: 480px) {
			.channels {
				flex: 0 0 100%;
				flex-direction: row;
				overflow-x: auto;
				overflow-y: hidden;
				border-right: none;
				border-top: 1px solid var(--border-color);
				padding: var(--space-xs);
				height: 60px;
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				z-index: 10;
			}
			
			.channel {
				min-width: 120px;
				justify-content: center;
			}
			
			.chat-container {
				padding-bottom: 60px; /* 为频道栏留出空间 */
			}
			
			.settings-group {
				flex: 1 1 100%;
			}
			
			.connection-status span:last-child {
				display: none;
			}
			
			.ssl-warning {
				max-width: calc(100vw - var(--space-lg) * 2);
				left: var(--space-lg);
				right: var(--space-lg);
			}
		}
	</style>
</head>
<body>
	<div class="main">
		<header class="header">
			<h1 id="caption">IRC Client</h1>
		</header>

		<div class="settings-bar">
			<div class="settings-group">
				<label>WebSocket地址</label>
				<input type="text" id="wsUrl" value="" placeholder="wss://irc.example.com:port/">
			</div>
			<div class="settings-group">
				<label>昵称</label>
				<input type="text" id="nickInput" value="" placeholder="输入昵称">
			</div>
			<div class="settings-group">
				<label>频道</label>
				<input type="text" id="channelInput" value="" placeholder="#channel">
			</div>
			<div class="settings-group">
				<label>
					<input type="checkbox" id="autoReconnect"> 自动重连
				</label>
			</div>
			<div class="settings-group">
				<button class="btn ssl-help-btn" onclick="showSSLWarning()" title="SSL证书问题解决方案">SSL帮助</button>
			</div>
			<button class="btn connect-btn" id="connectBtn" onclick="toggleConnection()">连接</button>
			<button class="btn log-toggle-btn" onclick="toggleLog()">查看日志</button>
			<div class="connection-status disconnected" id="connectionStatus">
				<span class="indicator"></span>
				<span id="statusText">未连接</span>
			</div>
		</div>

		<div class="ssl-warning" id="sslWarning">
			<strong>浏览器无法忽略SSL证书错误</strong>
			请使用以下方案：
			1. 改用 ws:// 非加密连接（如支持）
			2. 在浏览器中访问 <a id="sslLink" target="_blank">服务器URL</a> 并手动信任证书
		</div>

		<div class="log-container" id="logContainer">
			<div class="log-header">
				<span>WebSocket日志</span>
				<div class="log-controls">
					<button onclick="clearLog()">清空</button>
					<button onclick="toggleLog()">关闭</button>
				</div>
			</div>
			<div id="logOutput"></div>
		</div>

		<div class="chat-container">
			<div class="channels" id="channelsContainer"></div>
			
			<div class="channelcontents-wrapper hidden" id="contentsWrapper">
				<div class="channelcontents" id="channelContents"></div>
			</div>

			<div class="userlist-container" id="userlistContainer">
				<div class="userlist-header">在线用户</div>
				<ul id="globalUserList"></ul>
			</div>

			<div class="empty-state" id="emptyState">
				<h3>欢迎使用 IRC 客户端</h3>
				<p>请先填写服务器信息并点击连接</p>
			</div>
		</div>

		<div class="input-container" style="display: none;" id="inputContainer">
			<input type="text" name="input" id="input" placeholder="输入消息..." onkeydown="onKeyPress(event)">
		</div>
	</div>

	<script>
		// 应用配置
		const CONFIG = {
			MAX_MESSAGES: 200,
			RECONNECT_ATTEMPTS: 5,
			RECONNECT_DELAY: 3000,
			CONNECTION_TIMEOUT: 30000,
			MESSAGE_TIMEOUT: 5000
		};

		// 状态管理
		let AppState = {
			nickname: "",
			channelName: "",
			wsUrl: "",
			websocket: null,
			isConnected: false,
			autoReconnect: false,
			reconnectAttempts: 0,
			activeChannel: null,
			statusChannel: null,
			channelMap: new Map(),
			prefixChars: null,
			messageTimers: new Map()
		};

		// DOM 元素缓存
		let DOM = {};

		// 初始化
		function initializeApp() {
			DOM = {
				channels: document.getElementById("channelsContainer"),
				channelContents: document.getElementById("channelContents"),
				contentsWrapper: document.getElementById("contentsWrapper"),
				emptyState: document.getElementById("emptyState"),
				input: document.getElementById("input"),
				inputContainer: document.getElementById("inputContainer"),
				wsUrlInput: document.getElementById('wsUrl'),
				nickInput: document.getElementById('nickInput'),
				channelInput: document.getElementById('channelInput'),
				reconnectCheckbox: document.getElementById('autoReconnect'),
				connectBtn: document.getElementById('connectBtn'),
				statusEl: document.getElementById('connectionStatus'),
				statusText: document.getElementById('statusText'),
				logContainer: document.getElementById('logContainer'),
				logOutput: document.getElementById('logOutput'),
				sslWarning: document.getElementById('sslWarning'),
				sslLink: document.getElementById('sslLink'),
				caption: document.getElementById("caption"),
				userlistContainer: document.getElementById('userlistContainer')
			};

			// 从URL获取频道
			const url = new URL(document.location);
			if (url.hash) {
				DOM.channelInput.value = url.hash;
			}

			// 隐藏标题（如果在iframe中）
			if (window.frameElement) {
				DOM.caption.style.display = "none";
			}

			updateConnectionStatus(false);
			
			// 自动聚焦输入框
			if (DOM.input) {
				DOM.input.addEventListener('blur', () => setTimeout(() => DOM.input.focus(), 100));
			}
		}

		window.addEventListener("load", initializeApp, false);

		// 连接状态更新
		function updateConnectionStatus(connected) {
			if (!DOM.statusEl || !DOM.statusText) return;

			AppState.isConnected = connected;
			
			if (connected) {
				DOM.statusEl.classList.remove('disconnected');
				DOM.statusEl.classList.add('connected');
				DOM.statusText.textContent = `已连接 (${AppState.nickname})`;
			} else {
				DOM.statusEl.classList.remove('connected');
				DOM.statusEl.classList.add('disconnected');
				DOM.statusText.textContent = '未连接';
			}
		}

		// 日志功能
		function toggleLog() {
			if (DOM.logContainer) {
				DOM.logContainer.classList.toggle('visible');
				if (DOM.logContainer.classList.contains('visible')) {
					DOM.logOutput.scrollTop = DOM.logOutput.scrollHeight;
				}
			}
		}

		function clearLog() {
			if (DOM.logOutput) {
				DOM.logOutput.textContent = '';
			}
		}

		function writeToLog(message) {
			if (!DOM.logOutput) return;
			const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
			DOM.logOutput.textContent += `[${timestamp}] ${message}\n`;
			DOM.logOutput.scrollTop = DOM.logOutput.scrollHeight;
		}

		// SSL警告
		function showSSLWarning(url) {
			if (!DOM.sslWarning || !DOM.sslLink) return;

			const displayUrl = url || DOM.wsUrlInput?.value.trim();
			if (displayUrl) {
				const httpUrl = displayUrl.replace('wss://', 'https://').replace('ws://', 'http://');
				DOM.sslLink.href = httpUrl;
				DOM.sslLink.textContent = httpUrl;
			} else {
				DOM.sslLink.href = '#';
				DOM.sslLink.textContent = '请先在WebSocket地址栏输入服务器地址';
			}
			
			DOM.sslWarning.classList.add('visible');
			setTimeout(() => {
				DOM.sslWarning.classList.remove('visible');
			}, CONFIG.MESSAGE_TIMEOUT);
		}

		// 连接管理
		function toggleConnection() {
			if (AppState.isConnected) {
				AppState.autoReconnect = false;
				if (DOM.reconnectCheckbox) DOM.reconnectCheckbox.checked = false;
				if (AppState.websocket) {
					try {
						AppState.websocket.close(1000, "User disconnected");
					} catch (e) {
						writeToLog(`[ERROR] 关闭WebSocket时出错: ${e.message}`);
					}
				}
				handleDisconnect();
			} else {
				establishConnection();
			}
		}

		function validateNickname(nick) {
			return nick && /^[a-zA-Z_\\`\[\]{}^|][a-zA-Z0-9_\\`\[\]{}^|-]*$/.test(nick.trim());
		}

		function validateWsUrl(url) {
			return /^wss?:\/\/.+/.test(url);
		}

		function establishConnection() {
			AppState.wsUrl = DOM.wsUrlInput.value.trim();
			AppState.nickname = DOM.nickInput.value.trim();
			AppState.channelName = DOM.channelInput.value.trim();
			AppState.autoReconnect = DOM.reconnectCheckbox?.checked || false;

			// 验证输入
			if (!validateWsUrl(AppState.wsUrl)) {
				showMessage("WebSocket地址格式错误!必须以 ws:// 或 wss:// 开头", 'error');
				return;
			}
			if (!validateNickname(AppState.nickname)) {
				showMessage("昵称格式无效!必须以字母或特定符号开头,不能包含空格", 'error');
				return;
			}
			if (AppState.channelName && !AppState.channelName.startsWith('#')) {
				AppState.channelName = '#' + AppState.channelName;
			}

			// 重置重连计数
			AppState.reconnectAttempts = 0;

			// 禁用输入
			setInputsDisabled(true);

			// 更新UI
			DOM.connectBtn.textContent = '连接中...';
			DOM.connectBtn.disabled = true;

			// 清空界面
			DOM.channels.innerHTML = '';
			DOM.channelContents.innerHTML = '';
			AppState.channelMap.clear();

			// 显示聊天区域
			DOM.contentsWrapper.classList.remove('hidden');
			DOM.contentsWrapper.classList.add('visible');
			if (DOM.emptyState) DOM.emptyState.style.display = 'none';
			if (DOM.inputContainer) DOM.inputContainer.style.display = 'block';

			AppState.statusChannel = new ChannelTab("Status", "Status Window", false);
			writeToLog(`[系统] 正在连接: ${AppState.wsUrl}`);
			
			connectWebSocket(AppState.wsUrl);
		}

		function setInputsDisabled(disabled) {
			DOM.wsUrlInput.disabled = disabled;
			DOM.nickInput.disabled = disabled;
			DOM.channelInput.disabled = disabled;
			if (DOM.reconnectCheckbox) DOM.reconnectCheckbox.disabled = disabled;
		}

		function handleDisconnect() {
			setInputsDisabled(false);
			
			DOM.connectBtn.textContent = '连接';
			DOM.connectBtn.disabled = false;
			DOM.connectBtn.classList.remove('disconnect');

			updateConnectionStatus(false);

			// 隐藏聊天区域
			DOM.contentsWrapper.classList.remove('visible');
			DOM.contentsWrapper.classList.add('hidden');
			if (DOM.emptyState) DOM.emptyState.style.display = 'flex';
			if (DOM.inputContainer) DOM.inputContainer.style.display = 'none';
			if (DOM.userlistContainer) DOM.userlistContainer.classList.remove('visible');

			displayMessage("var(--text-primary)", "DISCONNECTED", AppState.statusChannel, "");
			writeToLog(`[系统] 已断开连接`);

			attemptReconnect();
		}

		function attemptReconnect() {
			if (!AppState.autoReconnect || AppState.reconnectAttempts >= CONFIG.RECONNECT_ATTEMPTS) {
				if (AppState.reconnectAttempts >= CONFIG.RECONNECT_ATTEMPTS) {
					writeToLog(`[重连] 达到最大重连次数,停止尝试`);
					AppState.autoReconnect = false;
					if (DOM.reconnectCheckbox) DOM.reconnectCheckbox.checked = false;
					showMessage('自动重连失败,请检查网络或服务器设置', 'warning');
				}
				return;
			}

			AppState.reconnectAttempts++;
			const delay = CONFIG.RECONNECT_DELAY * AppState.reconnectAttempts;
			writeToLog(`[重连] ${Math.floor(delay / 1000)}秒后尝试第 ${AppState.reconnectAttempts}/${CONFIG.RECONNECT_ATTEMPTS} 次重连...`);
			
			setTimeout(() => {
				if (!AppState.isConnected && AppState.autoReconnect) {
					writeToLog(`[重连] 正在尝试重新连接...`);
					establishConnection();
				}
			}, delay);
		}

		function showMessage(text, type = 'info') {
			const message = document.createElement('div');
			message.textContent = text;
			const bgColor = type === 'error' ? 'var(--error)' : type === 'warning' ? 'var(--warning)' : 'var(--info)';
			const textColor = type === 'warning' ? '#000' : 'white';
			message.style.cssText = `
				position: fixed;
				top: 20px;
				left: 50%;
				transform: translateX(-50%);
				padding: 12px 24px;
				background: ${bgColor};
				color: ${textColor};
				border-radius: var(--border-radius);
				box-shadow: var(--shadow-lg);
				z-index: 2000;
				animation: slideDown 0.3s ease;
				max-width: 80%;
				word-wrap: break-word;
			`;
			
			// 添加动画样式
			if (!document.getElementById('messageAnimations')) {
				const style = document.createElement('style');
				style.id = 'messageAnimations';
				style.textContent = `
					@keyframes slideDown {
						from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
						to { transform: translateX(-50%) translateY(0); opacity: 1; }
					}
				`;
				document.head.appendChild(style);
			}
			
			document.body.appendChild(message);
			setTimeout(() => {
				message.remove();
			}, CONFIG.MESSAGE_TIMEOUT);
		}

		// 键盘事件
		function onKeyPress(e) {
			if (e?.key === 'Enter') {
				sendMessage();
			}
		}

		// 频道标签管理
		function onChannelTabClick(evt) {
			if (!evt?.currentTarget) return;
			const chanName = evt.currentTarget.value;
			showChannel(chanName);
		}

		function hideAllChannels() {
			document.querySelectorAll(".channelcontent").forEach(content => {
				content.classList.remove('active');
			});
			document.querySelectorAll(".channel").forEach(link => {
				link.classList.remove("active");
			});
		}

		function showChannel(name) {
			if (!name) return;
			const channel = AppState.channelMap.get(name);
			hideAllChannels();
			if (channel?.channel) {
				channel.channel.classList.add('active');
				channel.button.classList.add("active");
				AppState.activeChannel = channel;
				setTimeout(() => {
					if (channel.content) {
						channel.content.scrollTop = channel.content.scrollHeight;
					}
				}, 10);
			}
		}

		function escapeHTML(text) {
			if (!text) return "";
			const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
			return text.replace(/[&<>"']/g, m => map[m]);
		}

		function sortUserList(userA, userB) {
			if (!userA?.[1] || !userB?.[1]) return 0;
			if (userA[0][0] === userB[0][0]) {
				return userA[1].localeCompare(userB[1], undefined, { sensitivity: 'accent' });
			}
			if (!AppState.prefixChars?.[1]) return 0;
			const aIndex = AppState.prefixChars[1].indexOf(userA[0][0]);
			const bIndex = AppState.prefixChars[1].indexOf(userB[0][0]);
			return aIndex - bIndex;
		}

		// 频道标签类
		function ChannelTab(name, topic, createUserList) {
			if (!name || !DOM.channels || !DOM.channelContents) {
				console.error("ChannelTab: 缺少必要元素");
				return;
			}

			hideAllChannels();
			this.name = name;
			const escapedName = escapeHTML(name);

			// 创建标签按钮
			this.button = document.createElement("button");
			this.button.innerHTML = escapedName;
			this.button.value = escapedName;
			this.button.onclick = onChannelTabClick;
			this.button.className = "channel";

			// 关闭按钮
			const closeBtn = document.createElement("button");
			closeBtn.innerHTML = "×";
			closeBtn.onclick = (evt) => {
				evt.stopPropagation();
				sendCommand("part " + closeBtn.value);
			};
			closeBtn.value = escapedName;
			closeBtn.className = "x";
			this.button.appendChild(closeBtn);

			DOM.channels.appendChild(this.button);

			// 创建内容区域
			this.channel = document.createElement("div");
			this.channel.className = "channelcontent";

			const navWrapper = document.createElement("nav");
			this.topic = document.createElement("h3");
			this.topic.innerHTML = escapeHTML(topic || "无主题");
			navWrapper.appendChild(this.topic);

			this.content = document.createElement("nav");
			navWrapper.appendChild(this.content);

			this.channel.appendChild(navWrapper);

			// 用户列表
			if (createUserList) {
				this.userlist = document.createElement("ul");
				this.users = [];
				this.names_end = true;
				this.channel.appendChild(this.userlist);
			}

			DOM.channelContents.appendChild(this.channel);
			AppState.channelMap.set(name, this);
			AppState.activeChannel = this;
			showChannel(name);
			return this;
		}

		function closeChannel(evt) {
			evt.stopPropagation();
			if (!evt?.currentTarget) return;
			sendCommand("part " + evt.currentTarget.value);
		}

		function destroyChannel(name) {
			if (!name) return;
			const channel = AppState.channelMap.get(name);
			if (!channel) return;
			channel.button.remove();
			channel.channel.remove();
			if (AppState.activeChannel === channel) {
				AppState.activeChannel = AppState.statusChannel;
			}
			AppState.channelMap.delete(name);
			if (AppState.activeChannel) {
				showChannel(AppState.activeChannel.name);
			}
		}

		function insertUserToChannel(nick, channel, prefix) {
			if (!nick || !channel?.userlist) return;
			const user = document.createElement("li");
			const prefixEl = document.createElement("p");
			if (prefix && prefix !== " ") prefixEl.innerHTML = prefix[0];
			user.appendChild(prefixEl);
			const nickEl = document.createElement("p");
			nickEl.innerHTML = escapeHTML(nick);
			user.appendChild(nickEl);
			
			let i = 0;
			for (; i < channel.users.length; i++) {
				if (channel.users[i]?.[1] && channel.users[i][1].localeCompare(nick, undefined, { sensitivity: 'accent' }) < 0) continue;
				break;
			}
			channel.users.splice(i, 0, [prefix || " ", nick]);
			channel.userlist.insertBefore(user, channel.userlist.childNodes[i]);
		}

		function appendUserToChannel(nick, channel, dontnotify, prefix) {
			if (!nick || !channel?.userlist) return;
			const user = document.createElement("li");
			const prefixEl = document.createElement("p");
			if (prefix && prefix !== " ") prefixEl.innerHTML = prefix[0];
			user.appendChild(prefixEl);
			const nickEl = document.createElement("p");
			nickEl.innerHTML = escapeHTML(nick);
			user.appendChild(nickEl);
			channel.userlist.appendChild(user);
		}

		function removeUserFromChannel(nick, channel) {
			if (!nick || !channel?.userlist) return false;
			for (let i = 0; i < channel.userlist.children.length; i++) {
				const userItem = channel.userlist.children[i];
				if (!userItem?.children[1]) continue;
				if (userItem.children[1].textContent === nick) {
					userItem.remove();
					if (channel.users?.[i]) {
						channel.users.splice(i, 1);
					}
					return true;
				}
			}
			return false;
		}

		function renameUserInChannel(nick, newnick, channel) {
			if (!nick || !newnick || !channel) return false;
			if (!channel.userlist) return false;
			
			for (let i = 0; i < channel.users.length; i++) {
				if (channel.users[i]?.[1] === nick) {
					const prefix = channel.users[i][0];
					removeUserFromChannel(nick, channel);
					insertUserToChannel(newnick, channel, prefix);
					return true;
				}
			}
			return false;
		}

		function updateUserPrefix(nick, channel, add, prefix) {
			if (!nick || !channel?.users || !AppState.prefixChars) return;
			
			for (let i = 0; i < channel.users.length; i++) {
				if (channel.users[i]?.[1] === nick) {
					const pos = AppState.prefixChars[0].indexOf(prefix);
					if (pos < 0) return;
					
					let prefixes = "";
					if (add === "true" || add === true) {
						let ii = 0;
						for (; ii < channel.users[i][0].length; ii++) {
							if (AppState.prefixChars[1].indexOf(channel.users[i][0][ii]) >= pos) break;
							prefixes += channel.users[i][0][ii];
						}
						prefixes += AppState.prefixChars[1][pos];
						for (; ii < channel.users[i][0].length; ii++) {
							prefixes += channel.users[i][0][ii];
						}
					} else {
						const tmp = channel.users[i][0].indexOf(AppState.prefixChars[1][pos]);
						if (tmp >= 0) {
							prefixes = channel.users[i][0].substring(0, tmp) + channel.users[i][0].substring(tmp + 1);
						}
					}
					if (prefixes === "") prefixes = " ";
					channel.users[i][0] = prefixes;
					renameUserInChannel(nick, nick, channel);
					break;
				}
			}
		}

		// 消息显示
		function displayMessage(color, message, channel, username) {
			if (!channel?.content) return;
			const pre = document.createElement("p");
			pre.style.color = color;
			const now = new Date();
			const utcTime = now.toISOString().substr(11, 8);
			const displayMessage = username ? 
				`[${utcTime}] ${username}: ${linkify(message || "")}` : 
				`[${utcTime}] ${linkify(message || "")}`;
			pre.innerHTML = displayMessage;
			
			if (channel.content) {
				channel.content.appendChild(pre);
				while (channel.content.children.length > CONFIG.MAX_MESSAGES) {
					channel.content.removeChild(channel.content.children[0]);
				}
				requestAnimationFrame(() => {
					channel.content.scrollTop = channel.content.scrollHeight;
				});
			}
		}

		function linkify(text) {
			if (!text) return "";
			const urlRegex = /(https?:\/\/[^\s<>{}|\\^`[\]]+)/g;
			return text.replace(urlRegex, (url) => {
				return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--accent-primary); text-decoration: underline; word-break: break-all;">${url}</a>`;
			});
		}

		function sendMessage() {
			const text = DOM.input?.value.trim();
			if (!text || !AppState.activeChannel) return;

			let message;
			if (text[0] === "/") {
				if (text.indexOf("/me ") === 0) {
					message = "privmsg " + AppState.activeChannel.name + " :\x01ACTION " + text.substring(4) + "\n";
					displayMessage("var(--color-red)", `${AppState.nickname} ${text.substring(4)}`, AppState.activeChannel, "*");
				} else {
					displayMessage("var(--text-primary)", text, AppState.statusChannel, "");
					message = text.substring(1) + "\n";
				}
			} else {
				message = "privmsg " + AppState.activeChannel.name + " :" + text + "\n";
				displayMessage("var(--text-primary)", text, AppState.activeChannel, AppState.nickname);
			}
			
			sendToWebSocket(message);
			DOM.input.value = "";
		}

		function sendCommand(command) {
			sendToWebSocket(command + "\n");
		}

		// WebSocket 管理
		function connectWebSocket(wsUri) {
			if (!wsUri) {
				writeToLog("[ERROR] WebSocket地址为空");
				return;
			}

			try {
				// 清理旧连接
				if (AppState.websocket) {
					try {
						AppState.websocket.onclose = null;
						AppState.websocket.onerror = null;
						AppState.websocket.onopen = null;
						AppState.websocket.onmessage = null;
						if (AppState.websocket.readyState !== WebSocket.CLOSED) {
							AppState.websocket.close(1000, "Reconnecting");
						}
					} catch (e) {
						writeToLog(`[WARN] 清理旧连接时出错: ${e.message}`);
					}
					AppState.websocket = null;
				}

				writeToLog(`[WebSocket] 正在创建连接: ${wsUri}`);
				AppState.websocket = new WebSocket(wsUri);
				AppState.websocket.binaryType = 'blob';

				// 连接超时处理
				const connectTimeout = setTimeout(() => {
					if (AppState.websocket?.readyState === WebSocket.CONNECTING) {
						writeToLog(`[ERROR] 连接超时 (${CONFIG.CONNECTION_TIMEOUT / 1000}秒)`);
						try {
							AppState.websocket.close(1006, "Connection timeout");
						} catch (e) {
							writeToLog(`[ERROR] 超时关闭连接失败: ${e.message}`);
						}
					}
				}, CONFIG.CONNECTION_TIMEOUT);

				AppState.websocket.onclose = (evt) => {
					clearTimeout(connectTimeout);
					handleWebSocketClose(evt);
				};
				AppState.websocket.onerror = (evt) => handleWebSocketError(evt);
				AppState.websocket.onopen = (evt) => {
					clearTimeout(connectTimeout);
					handleWebSocketOpen(evt);
				};
				AppState.websocket.onmessage = (evt) => handleWebSocketMessage(evt);
			} catch (e) {
				writeToLog(`[ERROR] WebSocket创建失败: ${e.message}`);
				handleDisconnect();
				if (AppState.wsUrl?.startsWith('wss://')) {
					showSSLWarning(AppState.wsUrl);
				}
				showMessage(`连接失败: ${e.message}\n\n如果是SSL证书错误,请点击"SSL帮助"查看解决方案`, 'error');
			}
		}

		function handleWebSocketClose(evt) {
			AppState.isConnected = false;
			const code = evt.code;
			let logMsg = `[CLOSE] Code: ${code}`;

			switch (code) {
				case 1000: logMsg += ' (正常关闭)'; break;
				case 1006: logMsg += ' (异常断开 - 可能SSL证书错误)'; break;
				case 1005: logMsg += ' (无状态码)'; break;
				case 1011: logMsg += ' (服务器异常)'; break;
				default: if (code >= 4000 && code <= 4999) logMsg += ' (应用层错误)';
			}
			logMsg += ` - ${evt.reason || '连接关闭'}`;

			displayMessage("var(--text-primary)", "DISCONNECTED", AppState.statusChannel, "");
			writeToLog(logMsg);

			if (AppState.websocket) {
				try {
					AppState.websocket.onclose = null;
					AppState.websocket.onerror = null;
					AppState.websocket.onopen = null;
					AppState.websocket.onmessage = null;
				} catch (e) {
					writeToLog(`[WARN] 清理事件监听器失败: ${e.message}`);
				}
				AppState.websocket = null;
			}
			handleDisconnect();
		}

		function handleWebSocketError(evt) {
			const errorType = AppState.websocket?.readyState === WebSocket.CONNECTING ? '连接失败' : '消息错误';
			displayMessage("var(--error)", `ERROR: ${errorType}`, AppState.statusChannel, "");
			writeToLog(`[ERROR] ${errorType}: ${evt.data || '未知错误'}`);
			if (AppState.wsUrl?.startsWith('wss://')) {
				showSSLWarning(AppState.wsUrl);
			}
		}

		function handleWebSocketOpen(evt) {
			AppState.isConnected = true;
			AppState.reconnectAttempts = 0;
			displayMessage("var(--text-primary)", "CONNECTED", AppState.statusChannel, "");
			writeToLog(`[OPEN] WebSocket连接成功: ${AppState.wsUrl}`);
			updateConnectionStatus(true);

			DOM.connectBtn.textContent = '断开';
			DOM.connectBtn.disabled = false;
			DOM.connectBtn.classList.add('disconnect');

			sendToWebSocket("user websocket * * :WebSocket User");
			sendToWebSocket("nick " + AppState.nickname);
		}

		function handleWebSocketMessage(evt) {
			if (!evt?.data) return;
			const rawData = evt.data;
			writeToLog(`← RECV: ${typeof rawData === 'string' ? rawData : '[二进制数据]'}`);
			
			if (rawData instanceof Blob) {
				const fileReader = new FileReader();
				fileReader.addEventListener("loadend", (e) => {
					handleBinaryInput(e.target.result);
				});
				fileReader.readAsText(rawData);
			} else {
				processMessage(rawData);
			}
		}

		function handleBinaryInput(raw) {
			writeToLog(`← RECV (Blob→Text): ${raw}`);
			processMessage(raw);
		}

		function sendToWebSocket(message) {
			if (!message) return;
			if (AppState.websocket?.readyState === WebSocket.OPEN) {
				try {
					AppState.websocket.send(message);
					writeToLog(`→ SEND: ${message.trim()}`);
				} catch (e) {
					writeToLog(`[ERROR] 发送消息失败: ${e.message}`);
					displayMessage("var(--error)", "发送失败: " + e.message, AppState.statusChannel, "");
				}
			} else {
				writeToLog(`[ERROR] WebSocket未连接,无法发送: ${message.trim()}`);
				if (!AppState.isConnected) {
					displayMessage("var(--error)", "未连接,消息未发送", AppState.statusChannel, "");
				}
			}
		}

		// IRC 命令处理
		const IRCCommands = new Map([
			["001", (nick, data) => {
				sendToWebSocket("CAP REQ :multi-prefix");
				if (AppState.channelName) {
					sendToWebSocket("join " + AppState.channelName);
					writeToLog(`[IRC] 接收001,准备加入频道: ${AppState.channelName}`);
				}
			}],
			["005", (nick, data) => {
				if (!data) return;
				for (let i = 2; i < data.length; i++) {
					if (data[i].indexOf("PREFIX=") === 0) {
						const tmp = data[i].substring(8) + " ";
						if (tmp) {
							AppState.prefixChars = tmp.split(")");
							displayMessage("var(--color-brown)", "PREFIX CHARS: " + AppState.prefixChars[0] + " " + AppState.prefixChars[1], AppState.statusChannel, "");
							writeToLog(`[IRC] 支持的PREFIX: ${AppState.prefixChars[0]} ${AppState.prefixChars[1]}`);
						}
					}
				}
			}],
			["332", (nick, data) => {
				if (data?.length < 5) return;
				const channel = AppState.channelMap.get(data[3]);
				if (!channel?.topic) return;
				let text = data[4].substring(1);
				for (let i = 5; i < data.length; i++) text += " " + data[i];
				channel.topic.innerHTML = escapeHTML(text || "无主题");
				writeToLog(`[IRC] 频道主题: ${data[3]} - ${text}`);
			}],
			["353", (nick, data) => {
				if (data?.length < 6) return;
				const channel = AppState.channelMap.get(data[4]);
				if (!channel) return;
				if (channel.names_end === true) {
					channel.users = [];
					channel.names_end = false;
				}
				data[5] = data[5].substring(1);
				for (let i = 5; i < data.length; i++) {
					let prefix = "";
					let ii = 0;
					while (AppState.prefixChars?.[1] && AppState.prefixChars[1].indexOf(data[i][ii]) >= 0) {
						prefix += data[i][ii];
						ii++;
					}
					if (prefix === "") prefix = " ";
					channel.users.push([prefix, data[i].substring(ii)]);
				}
				writeToLog(`[IRC] 接收用户列表: ${channel.users.length} 用户`);
			}],
			["366", (nick, data) => {
				if (data?.length < 4) return;
				const channel = AppState.channelMap.get(data[3]);
				if (!channel) return;
				channel.users.sort(sortUserList);
				channel.userlist.innerHTML = "";
				for (let i = 0; i < channel.users.length; i++) {
					appendUserToChannel(channel.users[i][1], channel, true, channel.users[i][0]);
				}
				channel.names_end = true;
				writeToLog(`[IRC] 用户列表加载完成`);
				
				// 显示用户列表面板
				if (DOM.userlistContainer) {
					DOM.userlistContainer.classList.add('visible');
				}
			}],
			["432", (nick, data) => {
				const newNick = prompt("错误: 昵称包含非法字符\n请输入新的昵称", "");
				if (newNick) {
					AppState.nickname = newNick;
					sendToWebSocket("nick " + newNick);
					writeToLog(`[IRC] 昵称错误,重新输入: ${newNick}`);
				}
			}],
			["433", (nick, data) => {
				const newNick = prompt("错误: 昵称已被占用\n请输入新的昵称", "");
				if (newNick) {
					AppState.nickname = newNick;
					sendToWebSocket("nick " + newNick);
					writeToLog(`[IRC] 昵称冲突,新昵称: ${newNick}`);
				}
			}],
			["JOIN", (nick, data) => {
				if (data?.length < 3) return;
				if (data[0].indexOf(":" + AppState.nickname + "!") !== 0) {
					if (data[2][0] === ":") data[2] = data[2].substring(1);
					const channel = AppState.channelMap.get(data[2]);
					if (channel) {
						insertUserToChannel(nick, channel, " ");
						displayMessage("var(--color-green)", `${nick} 加入频道`, channel, "*");
					}
				} else {
					const channel = new ChannelTab(data[2].substring(1), "", true);
					displayMessage("var(--color-green)", `你已加入频道 ${data[2].substring(1)}`, channel, "*");
				}
				writeToLog(`[IRC] 用户加入: ${nick} → ${data[2]}`);
			}],
			["KICK", (nick, data) => {
				if (data?.length < 5) return;
				const channel = AppState.channelMap.get(data[2]);
				if (!channel) return;
				let text = data[4].substring(1);
				for (let i = 5; i < data.length; i++) text += " " + data[i];
				
				if (data[3] !== AppState.nickname) {
					if (removeUserFromChannel(data[3], channel)) {
						displayMessage("var(--error)", `${data[3]} 被 ${nick} 踢出 (原因: ${text})`, channel, "*");
					}
				} else {
					destroyChannel(data[2]);
					displayMessage("var(--error)", `你被 ${nick} 踢出 ${data[2]} (原因: ${text})`, AppState.statusChannel, "");
				}
				writeToLog(`[IRC] 被踢出: ${data[2]} by ${nick} - ${text}`);
			}],
			["MODE", (nick, data) => {
				if (data?.length < 4) return;
				const channel = AppState.channelMap.get(data[2]);
				if (!channel) return;
				let text = data[3];
				for (let i = 4; i < data.length; i++) text += " " + data[i];
				displayMessage("var(--color-blue)", `${nick} 设置模式: ${text}`, channel, "*");
				
				if (!AppState.prefixChars || data[3].length < 1) return;
				let ii = 4;
				let status = "false";
				for (let i = 0; i < data[3].length; i++) {
					if (data[3][i] === "+") status = "true";
					else if (data[3][i] === "-") status = "false";
					else {
						if (ii < data.length) {
							updateUserPrefix(data[ii], channel, status, data[3][i]);
							ii++;
						}
					}
				}
				writeToLog(`[IRC] 模式变更: ${text}`);
			}],
			["NICK", (nick, data) => {
				if (data?.length < 3) return;
				const newnick = data[2].substring(1);
				if (nick === AppState.nickname) AppState.nickname = newnick;
				
				AppState.channelMap.forEach((channel, name) => {
					if (renameUserInChannel(nick, newnick, channel)) {
						const message = newnick === AppState.nickname ? 
							`你现在的新昵称是 ${newnick}` : 
							`${nick} 更名为 ${newnick}`;
						displayMessage("var(--color-green)", message, channel, "*");
					}
				});
				writeToLog(`[IRC] 昵称变更: ${nick} → ${newnick}`);
			}],
			["PART", (nick, data) => {
				if (data?.length < 3) return;
				if (data[0].indexOf(":" + AppState.nickname + "!") !== 0) {
					const channel = AppState.channelMap.get(data[2]);
					if (channel && removeUserFromChannel(nick, channel)) {
						displayMessage("var(--color-green)", `${nick} 离开频道`, channel, "*");
					}
				} else {
					destroyChannel(data[2]);
					displayMessage("var(--color-green)", `你已离开频道 ${data[2]}`, AppState.statusChannel, "");
				}
				writeToLog(`[IRC] 离开频道: ${data[2]}`);
			}],
			["TOPIC", (nick, data) => {
				if (data?.length < 4) return;
				const channel = AppState.channelMap.get(data[2]);
				if (!channel?.topic) return;
				let text = data[3].substring(1);
				for (let i = 4; i < data.length; i++) text += " " + data[i];
				channel.topic.innerHTML = escapeHTML(text || "无主题");
				displayMessage("var(--color-blue)", `${nick} 设置主题为: ${text}`, channel, "*");
				writeToLog(`[IRC] 主题变更: ${data[2]} - ${text}`);
			}],
			["QUIT", (nick, data) => {
				AppState.channelMap.forEach((channel, name) => {
					if (removeUserFromChannel(nick, channel)) {
						displayMessage("var(--color-purple)", `${nick} 退出IRC`, channel, "*");
					}
				});
				writeToLog(`[IRC] 用户退出: ${nick}`);
			}],
			["PRIVMSG", (nick, data) => {
				if (data?.length < 4) return;
				let channel = AppState.channelMap.get(data[2]);
				if (!channel) channel = AppState.statusChannel;
				let text = data[3].substring(1);
				for (let i = 4; i < data.length; i++) text += " " + data[i];
				
				const actualNick = data[0].substring(1).split("!")[0];
				if (text[0] === "\x01") {
					if (text.indexOf("\x01ACTION ") === 0) {
						displayMessage("var(--color-red)", `${actualNick} ${text.substring(8)}`, channel, "*");
					} else {
						displayMessage("var(--color-red)", `${actualNick} ${text}`, channel, "*");
					}
				} else {
					displayMessage("var(--text-primary)", text, channel, actualNick);
				}
			}],
			["NOTICE", (nick, data) => {
				if (data?.length < 4) return;
				let channel = AppState.channelMap.get(data[2]);
				if (!channel) channel = AppState.statusChannel;
				let text = data[3].substring(1);
				for (let i = 4; i < data.length; i++) text += " " + data[i];
				
				const actualNick = data[0].substring(1).split("!")[0];
				displayMessage("var(--warning)", `通知 ${actualNick}: ${text}`, channel, "-");
				writeToLog(`[NOTICE] ${actualNick}: ${text}`);
			}]
		]);

		function processMessage(rawData) {
			if (!rawData) return;
			const data = rawData.split(" ");
			if (!data || data.length < 2) {
				writeToLog(`[DEBUG] 无效数据: ${rawData}`);
				return;
			}

			const nick = data[0].substring(1).split("!")[0];
			const command = data[1].toUpperCase();
			const handler = IRCCommands.get(command);
			
			if (handler) {
				handler(nick, data);
				return;
			}

			if (!isNaN(parseInt(data[1]))) {
				let text = data[1];
				for (let i = 3; i < data.length; i++) text += " " + data[i];
				displayMessage("var(--warning)", text, AppState.statusChannel, "");
				writeToLog(`[SERVER] ${data[1]}: ${text}`);
				return;
			}

			if (data[0] === "PING") {
				const pongResponse = rawData.replace("PING", "PONG");
				displayMessage("var(--color-brown)", pongResponse, AppState.statusChannel, "");
				sendToWebSocket(pongResponse);
				writeToLog(`[PING/PONG] ${pongResponse}`);
				return;
			}

			if (data[0] === "ERROR") {
				displayMessage("var(--text-primary)", rawData, AppState.statusChannel, "");
				writeToLog(`[ERROR] ${rawData}`);
				return;
			}

			console.log("DEBUG:", rawData);
			writeToLog(`[DEBUG] ${rawData}`);
		}
	</script>

</body></html>