<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ç°ä»£åŒ–IRC Webå®¢æˆ·ç«¯</title>
	<style>
		:root {
			--clr-background: #F5F7FA;
			--clr-background2: #E4E7F4;
			--clr-background3: #FFFFFF;
			--clr-background4: #D1D5DB;
			--clr-font: #1F2937;
			--clr-brown: #92400E;
			--clr-green: #065F46;
			--clr-gold: #D97706;
			--clr-red: #DC2626;
			--clr-purple: #7C3AED;
			--clr-blue: #2563EB;
			--clr-accent: #4F46E5;
			--clr-border: #9CA3AF;
			--clr-warning: #F59E0B;
			--clr-success: #10B981;
			--spacing-sm: 8px;
			--spacing-md: 12px;
			--spacing-lg: 16px;
			--border-radius: 8px;
			--transition: all 0.2s ease;
		}

		@media (prefers-color-scheme: dark) {
			:root {
				--clr-background: #111827;
				--clr-background2: #1F2937;
				--clr-background3: #1F2937;
				--clr-background4: #4B5563;
				--clr-font: #F9FAFB;
				--clr-brown: #FDE68A;
				--clr-green: #6EE7B7;
				--clr-gold: #FBBF24;
				--clr-red: #FCA5A5;
				--clr-purple: #C4B5FD;
				--clr-blue: #93C5FD;
				--clr-accent: #818CF8;
				--clr-border: #4B5563;
				--clr-warning: #FCD34D;
				--clr-success: #6EE7B7;
			}
		}

		* {
			box-sizing: border-box;
		}

		html,
		body {
			font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			margin: 0;
			padding: 0;
			height: 100%;
			background-color: var(--clr-background);
			color: var(--clr-font);
			font-size: 14px;
			line-height: 1.5;
			overflow: hidden;
		}

		.main {
			display: flex;
			flex-direction: column;
			height: 100vh;
			width: 100%;
		}

		.header {
			background: linear-gradient(90deg, var(--clr-background2), var(--clr-background));
			padding: var(--spacing-md) var(--spacing-lg);
			flex: 0 0 auto;
			border-bottom: 1px solid var(--clr-border);
		}

		.header h1 {
			margin: 0;
			font-size: 22px;
			font-weight: 700;
			color: var(--clr-accent);
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.header h1::before {
			content: "ğŸ’¬";
			font-size: 24px;
		}

		.settings-bar {
			flex: 0 0 auto;
			background-color: var(--clr-background2);
			border-bottom: 1px solid var(--clr-border);
			display: flex;
			align-items: center;
			padding: var(--spacing-sm) var(--spacing-md);
			gap: var(--spacing-sm);
			overflow-x: auto;
			flex-wrap: nowrap;
			min-height: 50px;
		}

		.settings-group {
			display: flex;
			align-items: center;
			gap: 6px;
			flex: 0 0 auto;
		}

		.settings-group label {
			font-size: 12px;
			font-weight: 600;
			color: var(--clr-font);
			white-space: nowrap;
		}

		.settings-group input[type="text"] {
			padding: 8px 12px;
			background-color: var(--clr-background3);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius);
			font-size: 13px;
			min-width: 140px;
			transition: var(--transition);
		}

		.settings-group input[type="checkbox"] {
			width: 18px;
			height: 18px;
			cursor: pointer;
			margin: 0;
		}

		.settings-group input:focus {
			outline: none;
			border-color: var(--clr-accent);
			box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
		}

		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: var(--border-radius);
			cursor: pointer;
			font-weight: 600;
			font-size: 13px;
			white-space: nowrap;
			transition: var(--transition);
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
		}

		.connect-btn {
			background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
			color: white;
		}

		.connect-btn:hover:not(:disabled) {
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
		}

		.connect-btn:disabled {
			background: var(--clr-background4);
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
		}

		.connect-btn.disconnect {
			background: linear-gradient(135deg, var(--clr-red), #EF4444);
		}

		.log-toggle-btn {
			background-color: var(--clr-background4);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
		}

		.log-toggle-btn:hover {
			background-color: var(--clr-accent);
			color: white;
		}

		.ssl-help-btn {
			background: linear-gradient(135deg, var(--clr-warning), #F59E0B);
			color: #000;
			padding: 6px 10px;
		}

		.ssl-help-btn:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
		}

		.connection-status {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 6px 12px;
			background-color: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius);
			font-size: 12px;
			font-weight: 500;
			margin-left: auto;
			flex: 0 0 auto;
			transition: var(--transition);
		}

		.connection-status.connected {
			border-color: var(--clr-success);
			background-color: rgba(16, 185, 129, 0.1);
		}

		.connection-status.disconnected {
			border-color: var(--clr-red);
			background-color: rgba(220, 38, 38, 0.1);
		}

		.connection-status .indicator {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			background-color: var(--clr-border);
			transition: var(--transition);
		}

		.connection-status.connected .indicator {
			background-color: var(--clr-success);
		}

		.connection-status.disconnected .indicator {
			background-color: var(--clr-red);
		}

		.ssl-warning {
			display: none;
			position: absolute;
			bottom: 20px;
			right: 20px;
			max-width: 380px;
			background: linear-gradient(135deg, var(--clr-warning), #F59E0B);
			color: #000;
			padding: var(--spacing-md);
			border-radius: var(--border-radius);
			font-size: 13px;
			z-index: 200;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
			line-height: 1.4;
		}

		.ssl-warning.visible {
			display: block;
		}

		.ssl-warning a {
			color: #000;
			font-weight: 600;
			text-decoration: underline;
			cursor: pointer;
		}

		.ssl-warning code {
			background: rgba(0, 0, 0, 0.1);
			padding: 2px 4px;
			border-radius: 3px;
			font-family: monospace;
		}

		.chat-container {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			position: relative;
			min-height: 0;
		}

		.channels {
			flex: 0 0 auto;
			background-color: var(--clr-background2);
			border-bottom: 1px solid var(--clr-border);
			display: flex;
			align-items: center;
			padding: var(--spacing-sm) 10px;
			gap: 6px;
			overflow-x: auto;
			flex-wrap: nowrap;
		}

		.channel {
			padding: 8px 14px;
			background-color: var(--clr-background3);
			border: 1px solid var(--clr-border);
			border-radius: 20px;
			cursor: pointer;
			font-weight: 500;
			font-size: 13px;
			transition: var(--transition);
			display: inline-flex;
			align-items: center;
			gap: 6px;
			white-space: nowrap;
		}

		.channel:hover {
			background-color: var(--clr-background4);
		}

		.channel.active {
			background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
			color: white;
			border-color: var(--clr-accent);
		}

		.channel button.x {
			background: none;
			border: none;
			color: inherit;
			cursor: pointer;
			padding: 2px 6px;
			font-weight: bold;
			border-radius: 50%;
			font-size: 14px;
			transition: var(--transition);
			line-height: 1;
		}

		.channel button.x:hover {
			background-color: rgba(255, 255, 255, 0.2);
		}

		.log-container {
			position: absolute;
			inset: 0;
			background-color: var(--clr-background3);
			border-bottom: 2px solid var(--clr-accent);
			display: none;
			flex-direction: column;
			z-index: 100;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		}

		.log-container.visible {
			display: flex;
		}

		.log-header {
			flex: 0 0 auto;
			padding: var(--spacing-sm) var(--spacing-md);
			background-color: var(--clr-background2);
			border-bottom: 1px solid var(--clr-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			font-weight: 600;
			font-size: 13px;
			min-height: 35px;
		}

		.log-controls {
			display: flex;
			gap: 6px;
		}

		.log-controls button {
			padding: 4px 10px;
			background-color: var(--clr-background4);
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 11px;
			transition: var(--transition);
		}

		.log-controls button:hover {
			background-color: var(--clr-accent);
			color: white;
		}

		#logOutput {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--spacing-sm);
			font-size: 11px;
			font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
			background-color: var(--clr-background3);
			color: var(--clr-font);
			white-space: pre-wrap;
			word-wrap: break-word;
			line-height: 1.4;
		}

		#logOutput:empty::before {
			content: 'æ—¥å¿—ä¸ºç©º...';
			color: var(--clr-border);
			font-style: italic;
		}

		.channelcontents-wrapper {
			flex: 1 1 auto;
			display: flex;
			overflow: hidden;
			min-height: 0;
		}

		.channelcontents-wrapper.visible {
			display: flex;
		}

		.channelcontents-wrapper.hidden {
			display: none;
		}

		.channelcontents {
			display: flex;
			flex-direction: row;
			width: 100%;
			height: 100%;
			min-height: 0;
		}

		.channelcontent {
			flex: 1 1 auto;
			display: none;
			flex-direction: row;
			min-height: 0;
		}

		.channelcontent.active {
			display: flex;
		}

		.channelcontent nav {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
			background-color: var(--clr-background3);
			border-radius: var(--border-radius);
			overflow: hidden;
			border: 1px solid var(--clr-border);
		}

		.channelcontent nav h3 {
			flex: 0 0 auto;
			padding: var(--spacing-md);
			margin: 0;
			background-color: var(--clr-background2);
			border-bottom: 1px solid var(--clr-border);
			font-weight: 600;
			font-size: 14px;
			min-height: 40px;
			display: flex;
			align-items: center;
		}

		.channelcontent nav nav {
			flex: 1 1 auto;
			overflow-y: auto;
			padding: var(--spacing-md);
			min-height: 0;
		}

		.channelcontent nav p {
			margin: 0;
			padding: 3px 0;
			line-height: 1.5;
		}

		ul {
			flex: 0 0 200px;
			overflow-y: auto;
			padding: var(--spacing-sm);
			margin: 0;
			border-left: 1px solid var(--clr-border);
			list-style: none;
			background-color: var(--clr-background3);
			min-height: 0;
		}

		.channelcontents li {
			padding: 8px 12px;
			margin: 2px 0;
			display: flex;
			gap: 8px;
			border-radius: 4px;
			transition: var(--transition);
			cursor: pointer;
		}

		.channelcontents li:hover {
			background-color: var(--clr-background2);
		}

		.channelcontents li p {
			margin: 0;
		}

		.channelcontents li p:first-child {
			width: 20px;
			color: var(--clr-purple);
			font-weight: bold;
			text-align: center;
		}

		.channelcontents li p:nth-child(2) {
			flex: 1;
			color: var(--clr-green);
		}

		#input {
			flex: 0 0 auto;
			padding: 12px 16px;
			background-color: var(--clr-background3);
			color: var(--clr-font);
			border: 1px solid var(--clr-border);
			border-radius: var(--border-radius);
			font-size: 14px;
			transition: var(--transition);
			margin: var(--spacing-sm);
			width: auto;
			position: static;
			display: block;
		}

		#input:focus {
			outline: none;
			border-color: var(--clr-accent);
			box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
		}

		#input::placeholder {
			color: var(--clr-border);
		}

		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}

		::-webkit-scrollbar-track {
			background: var(--clr-background);
		}

		::-webkit-scrollbar-thumb {
			background: var(--clr-accent);
			border-radius: 4px;
		}

		::-webkit-scrollbar-thumb:hover {
			background: var(--clr-purple);
		}

		/* ç§»åŠ¨ç«¯ä¼˜åŒ– */
		@media (max-width: 768px) {
			.settings-bar {
				flex-wrap: wrap;
				padding: 8px;
				gap: 8px;
				min-height: auto;
			}

			.settings-group {
				flex: 1 1 45%;
				min-width: 140px;
			}

			.settings-group input {
				min-width: 100px;
				width: 100%;
			}

			.connection-status {
				margin-left: 0;
				flex: 1 1 100%;
				justify-content: center;
				margin-top: 4px;
			}

			.log-container {
				height: 40vh;
			}

			.channelcontent {
				flex-direction: column;
			}

			ul {
				flex: 0 0 120px;
				border-left: none;
				border-top: 1px solid var(--clr-border);
			}

			#input {
				margin: 8px;
				padding: 12px;
			}
		}

		@media (max-width: 480px) {
			.settings-group {
				flex: 1 1 100%;
			}

			.channel {
				font-size: 12px;
				padding: 6px 12px;
			}

			.connection-status span:last-child {
				display: none;
			}

			ul {
				flex: 0 0 100px;
			}

			#input {
				margin: 8px;
				padding: 12px;
			}
		}

		/* æ»šåŠ¨åˆ°åº•éƒ¨çš„æç¤º */
		.scroll-indicator {
			position: absolute;
			bottom: 70px;
			right: 20px;
			background: var(--clr-accent);
			color: white;
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			cursor: pointer;
			opacity: 0;
			transition: opacity 0.3s;
			pointer-events: none;
			z-index: 5;
		}

		.scroll-indicator.visible {
			opacity: 1;
			pointer-events: all;
		}

		/* ç©ºçŠ¶æ€æç¤º */
		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			color: var(--clr-border);
			text-align: center;
			padding: var(--spacing-lg);
		}

		.empty-state h3 {
			margin: 0 0 8px 0;
			font-size: 18px;
			font-weight: 600;
		}

		.empty-state p {
			margin: 0;
			font-size: 14px;
		}
		
		/* åª’ä½“é¢„è§ˆç›¸å…³æ ·å¼ */
		.media-container {
			position: relative;
			display: inline-block;
			margin: 2px;
			border-radius: 4px;
			overflow: hidden;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		
		.media-container img {
			max-width: 150px;
			max-height: 150px;
			object-fit: cover;
			cursor: pointer;
			border-radius: 4px;
		}
		
		.media-container video, .media-container audio {
			max-width: 300px;
			max-height: 200px;
			border-radius: 4px;
			cursor: pointer;
		}
		
		.media-overlay {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.5);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 12px;
			opacity: 0;
			transition: opacity 0.2s;
			border-radius: 4px;
		}
		
		.media-container:hover .media-overlay {
			opacity: 1;
		}
		
		.media-preview-modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s;
		}
		
		.media-preview-modal.visible {
			opacity: 1;
			pointer-events: all;
		}
		
		.media-preview-content {
			position: relative;
			max-width: 90%;
			max-height: 90%;
		}
		
		.media-preview-content img {
			max-width: 100%;
			max-height: 80vh;
			object-fit: contain;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		}
		
		.media-preview-content video {
			max-width: 100%;
			max-height: 80vh;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		}
		
		.media-preview-content audio {
			width: 100%;
			max-width: 800px;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
		}
		
		.close-preview {
			position: absolute;
			top: -40px;
			right: 0;
			background: var(--clr-red);
			color: white;
			border: none;
			width: 30px;
			height: 30px;
			border-radius: 50%;
			cursor: pointer;
			font-weight: bold;
			font-size: 18px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.media-info {
			text-align: center;
			color: white;
			margin-top: 10px;
			font-size: 14px;
		}
		
		/* æ–‡ä»¶å›¾æ ‡æ ·å¼ */
		.file-icon {
			display: inline-block;
			width: 16px;
			height: 16px;
			margin-right: 4px;
			vertical-align: middle;
		}
		
		/* é”™è¯¯å¤„ç†æ ·å¼ */
		.media-error {
			display: inline-block;
			padding: 10px;
			background: #f8d7da;
			color: #721c24;
			border-radius: 4px;
			font-size: 12px;
		}
		
		/* èŠå¤©æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
		.chat-message {
			margin: 4px 0;
			padding: 6px 8px;
			border-radius: 4px;
			display: flex;
			align-items: flex-start;
		}
		
		.chat-message:hover {
			background-color: var(--clr-background2);
		}
		
		.chat-message .timestamp {
			color: var(--clr-border);
			font-size: 11px;
			margin-right: 8px;
		}
		
		.chat-message .username {
			font-weight: 600;
			margin-right: 6px;
			color: var(--clr-accent);
		}
		
		.chat-message .content {
			flex: 1;
		}
		
		.chat-message.system {
			color: var(--clr-green);
			font-style: italic;
		}
		
		.chat-message.action {
			color: var(--clr-red);
		}
		
		.chat-message.error {
			color: var(--clr-red);
		}
		
		.chat-message.notice {
			color: var(--clr-gold);
		}
	</style>
</head>

<body>
	<div class="main">
		<div class="header">
			<h1>ç°ä»£åŒ–IRCå®¢æˆ·ç«¯</h1>
		</div>

		<div class="settings-bar">
			<div class="settings-group">
				<label>WebSocket:</label>
				<input type="text" id="wsUrl" value="wss://irc.arkfuture.top:8097" placeholder="wss://irc.example.com:port/">
			</div>
			<div class="settings-group">
				<label>æ˜µç§°:</label>
				<input type="text" id="nickInput" value="" placeholder="è¾“å…¥æ˜µç§°">
			</div>
			<div class="settings-group">
				<label>é¢‘é“:</label>
				<input type="text" id="channelInput" value="#lobby" placeholder="#channel">
			</div>
			<div class="settings-group">
				<label title="å¯ç”¨åä¼šåœ¨æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿">
					<input type="checkbox" id="autoReconnect"> è‡ªåŠ¨é‡è¿
				</label>
			</div>
			<div class="settings-group">
				<label title="SSLå¸®åŠ©">
					<button class="btn ssl-help-btn" onclick="showSSLWarning()" title="ç‚¹å‡»æŸ¥çœ‹SSLè¯ä¹¦é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ">SSLå¸®åŠ©</button>
				</label>
			</div>
			<button class="btn connect-btn" id="connectBtn" onclick="toggleConnection()">
				<span class="btn-icon">ğŸ”Œ</span>
				<span class="btn-text">è¿æ¥</span>
			</button>
			<button class="btn log-toggle-btn" onclick="toggleLog()">ğŸ“‹ æ—¥å¿—</button>
			<div class="connection-status disconnected" id="connectionStatus">
				<span class="indicator"></span>
				<span id="statusText">æœªè¿æ¥</span>
			</div>
		</div>

		<div class="ssl-warning" id="sslWarning">
			<strong>âš ï¸ æµè§ˆå™¨æ— æ³•å¿½ç•¥SSLè¯ä¹¦é”™è¯¯!</strong> è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š<br>
			1. æ”¹ç”¨ <code>ws://</code> éåŠ å¯†è¿æ¥(å¦‚æœæµè§ˆå™¨æ”¯æŒ)<br>
			2. åœ¨æµè§ˆå™¨ä¸­è®¿é—® <a id="sslLink" target="_blank">æœåŠ¡å™¨URL</a> å¹¶æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦<br>
		</div>

		<div class="log-container" id="logContainer">
			<div class="log-header">
				<span>WebSocketæ—¥å¿—</span>
				<div class="log-controls">
					<button onclick="clearLog()">æ¸…ç©º</button>
					<button onclick="toggleLog()">å…³é—­</button>
				</div>
			</div>
			<div id="logOutput"></div>
		</div>

		<div class="chat-container">
			<div class="channels" id="channelsContainer"></div>
			<div class="channelcontents-wrapper hidden" id="contentsWrapper">
				<div class="channelcontents" id="channelContents"></div>
			</div>
			<div class="empty-state" id="emptyState">
				<h3>æ¬¢è¿ä½¿ç”¨ IRC å®¢æˆ·ç«¯</h3>
				<p>è¯·å…ˆå¡«å†™æœåŠ¡å™¨ä¿¡æ¯å¹¶ç‚¹å‡»è¿æ¥</p>
			</div>
			<input type="text" name="input" id="input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="display: none;"
				   onkeydown="onKeyPress(event)" onkeydown="onKeyDown(event)" />
		</div>
		
		<!-- åª’ä½“é¢„è§ˆæ¨¡æ€æ¡† -->
		<div class="media-preview-modal" id="mediaPreviewModal">
			<div class="media-preview-content">
				<img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡" style="display: none;">
				<video id="previewVideo" controls style="display: none;"></video>
				<audio id="previewAudio" controls style="display: none;"></audio>
				<button class="close-preview" onclick="closeMediaPreview()">Ã—</button>
				<div class="media-info" id="mediaInfo"></div>
			</div>
		</div>
	</div>
</body>

<script>
	var nickname = "";
	var channelName = "";
	var wsUrl = "";
	var channels, channelContents, contentsWrapper, emptyState, input;
	var channelMap = new Map();
	var activeChannel = null;
	var statusChannel = null;
	var PrefixChars;
	var websocket = null;
	var isConnected = false;
	var autoReconnect = false;
	var reconnectAttempts = 0;
	var maxReconnectAttempts = 5;
	var reconnectDelay = 3000;

	function onLoad() {
		channels = document.getElementById("channelsContainer");
		channelContents = document.getElementById("channelContents");
		contentsWrapper = document.getElementById("contentsWrapper");
		emptyState = document.getElementById("emptyState");
		input = document.getElementById("input");

		let url = new URL(document.location);
		if (url.hash) {
			document.getElementById('channelInput').value = url.hash;
		}
		if (window.frameElement) {
			document.getElementById("caption").style.display = "none";
		}
		updateConnectionStatus(false);

		// æ·»åŠ è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
		if (input) {
			input.addEventListener('blur', () => setTimeout(() => input.focus(), 100));
		}
	}
	window.addEventListener("load", onLoad, false);

	function updateConnectionStatus(connected) {
		const statusEl = document.getElementById('connectionStatus');
		const statusText = document.getElementById('statusText');
		if (!statusEl || !statusText) return;

		if (connected) {
			statusEl.classList.remove('disconnected');
			statusEl.classList.add('connected');
			statusText.textContent = `å·²è¿æ¥ (${nickname})`;
		} else {
			statusEl.classList.remove('connected');
			statusEl.classList.add('disconnected');
			statusText.textContent = 'æœªè¿æ¥';
		}
	}

	function toggleLog() {
		const logContainer = document.getElementById('logContainer');
		if (logContainer) {
			logContainer.classList.toggle('visible');
			if (!logContainer.classList.contains('visible')) {
				logContainer.scrollTop = logContainer.scrollHeight;
			}
		}
	}

	function clearLog() {
		const logOutput = document.getElementById('logOutput');
		if (logOutput) {
			logOutput.textContent = '';
		}
	}

	function writeToLog(message) {
		const logOutput = document.getElementById('logOutput');
		if (logOutput) {
			const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
			logOutput.textContent += `[${timestamp}] ${message}\n`;
			logOutput.scrollTop = logOutput.scrollHeight;
		}
	}

	function showSSLWarning(url) {
		const warning = document.getElementById('sslWarning');
		const link = document.getElementById('sslLink');
		if (!warning || !link) return;

		let displayUrl = url || document.getElementById('wsUrl')?.value.trim();
		if (displayUrl) {
			link.href = displayUrl.replace('wss://', 'https://').replace('ws://', 'http://');
			link.textContent = link.href;
		} else {
			link.href = '#';
			link.textContent = 'è¯·å…ˆåœ¨WebSocketåœ°å€æ è¾“å…¥æœåŠ¡å™¨åœ°å€';
		}
		warning.classList.add('visible');
		setTimeout(() => {
			if (warning) warning.classList.remove('visible');
		}, 6000);
	}

	function toggleConnection() {
		if (isConnected) {
			autoReconnect = false;
			const reconnectCheckbox = document.getElementById('autoReconnect');
			if (reconnectCheckbox) reconnectCheckbox.checked = false;
			if (websocket) {
				try {
					websocket.close(1000, "User disconnected");
				} catch (e) {
					writeToLog(`[ERROR] å…³é—­WebSocketæ—¶å‡ºé”™: ${e.message}`);
				}
			}
			onDisconnect();
		} else {
			doConnect();
		}
	}

	function validateNickname(nick) {
		if (!nick || nick.trim() === "") return false;
		return /^[a-zA-Z_\\`\[\]{}^|][a-zA-Z0-9_\\`\[\]{}^|-]*$/.test(nick);
	}

	function validateWsUrl(url) {
		if (!url) return false;
		return /^wss?:\/\/.+/.test(url);
	}

	function doConnect() {
		const wsUrlInput = document.getElementById('wsUrl');
		const nickInput = document.getElementById('nickInput');
		const channelInput = document.getElementById('channelInput');
		const reconnectCheckbox = document.getElementById('autoReconnect');
		const connectBtn = document.getElementById('connectBtn');

		if (!wsUrlInput || !nickInput || !channelInput || !connectBtn) {
			alert("ç•Œé¢å…ƒç´ åŠ è½½é”™è¯¯, è¯·åˆ·æ–°é¡µé¢é‡è¯•");
			return;
		}

		wsUrl = wsUrlInput.value.trim();
		nickname = nickInput.value.trim();
		channelName = channelInput.value.trim();
		autoReconnect = reconnectCheckbox ? reconnectCheckbox.checked : false;

		if (!validateWsUrl(wsUrl)) {
			alert("WebSocketåœ°å€æ ¼å¼é”™è¯¯!å¿…é¡»ä»¥ ws:// æˆ– wss:// å¼€å¤´");
			return;
		}
		if (!validateNickname(nickname)) {
			alert("æ˜µç§°æ ¼å¼æ— æ•ˆ!å¿…é¡»ä»¥å­—æ¯æˆ–ç‰¹å®šç¬¦å·å¼€å¤´, ä¸èƒ½åŒ…å«ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦");
			return;
		}
		if (channelName && !channelName.startsWith('#')) {
			channelName = '#' + channelName;
		}

		reconnectAttempts = 0;
		wsUrlInput.disabled = true;
		nickInput.disabled = true;
		channelInput.disabled = true;
		if (reconnectCheckbox) reconnectCheckbox.disabled = true;

		connectBtn.innerHTML = '<span class="btn-icon">ğŸ”„</span><span class="btn-text">è¿æ¥ä¸­...</span>';
		connectBtn.disabled = true;

		// æ¸…ç©ºç•Œé¢
		channels.innerHTML = '';
		channelContents.innerHTML = '';
		channelMap.clear();

		// æ˜¾ç¤ºèŠå¤©åŒºåŸŸ
		contentsWrapper.classList.remove('hidden');
		contentsWrapper.classList.add('visible');
		if (emptyState) emptyState.style.display = 'flex';
		if (input) input.style.display = 'block';

		statusChannel = new Tab_Create("Status", "Status Window", false);
		writeToLog(`[ç³»ç»Ÿ] æ­£åœ¨è¿æ¥: ${wsUrl}`);
		WebSocket_Connect(wsUrl);
	}

	function onDisconnect() {
		isConnected = false;
		const wsUrlInput = document.getElementById('wsUrl');
		const nickInput = document.getElementById('nickInput');
		const channelInput = document.getElementById('channelInput');
		const reconnectCheckbox = document.getElementById('autoReconnect');
		const connectBtn = document.getElementById('connectBtn');

		if (wsUrlInput) wsUrlInput.disabled = false;
		if (nickInput) nickInput.disabled = false;
		if (channelInput) channelInput.disabled = false;
		if (reconnectCheckbox) reconnectCheckbox.disabled = false;

		if (connectBtn) {
			connectBtn.innerHTML = '<span class="btn-icon">ğŸ”Œ</span><span class="btn-text">è¿æ¥</span>';
			connectBtn.disabled = false;
			connectBtn.classList.remove('disconnect');
		}

		updateConnectionStatus(false);

		// éšè—èŠå¤©åŒºåŸŸ
		contentsWrapper.classList.remove('visible');
		contentsWrapper.classList.add('hidden');
		if (emptyState) emptyState.style.display = 'flex';
		if (input) input.style.display = 'none';

		writeToScreen("var(--clr-font)", "DISCONNECTED", statusChannel, "");
		writeToLog(`[ç³»ç»Ÿ] å·²æ–­å¼€è¿æ¥`);

		if (autoReconnect && reconnectAttempts < maxReconnectAttempts) {
			reconnectAttempts++;
			const delay = reconnectDelay * reconnectAttempts;
			writeToLog(`[é‡è¿] ${Math.floor(delay / 1000)}ç§’åå°è¯•ç¬¬ ${reconnectAttempts}/${maxReconnectAttempts} æ¬¡é‡è¿...`);
			setTimeout(() => {
				if (!isConnected && autoReconnect) {
					writeToLog(`[é‡è¿] æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...`);
					doConnect();
				}
			}, delay);
		} else if (autoReconnect && reconnectAttempts >= maxReconnectAttempts) {
			writeToLog(`[é‡è¿] è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°, åœæ­¢å°è¯•`);
			autoReconnect = false;
			if (reconnectCheckbox) reconnectCheckbox.checked = false;
			alert('è‡ªåŠ¨é‡è¿å¤±è´¥, è¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨è®¾ç½®');
		}
	}

	function onKeyPress(e) {
		if (e && e.key === 'Enter') {
			send();
		}
	}

	function onKeyDown(e) {
		if (e.key === 'Tab') {
			e.preventDefault();
			console.log("TODO: TAB KEY - Nickname completion");
			return false;
		}
	}

	function Tab_onClick(evt) {
		if (!evt || !evt.currentTarget) return;
		let chanName = evt.currentTarget.value;
		Tab_Show(chanName);
	}

	function Tabs_Hide() {
		let tabcontent = document.querySelectorAll(".channelcontent");
		tabcontent.forEach(content => content.classList.remove('active'));

		let tablinks = document.querySelectorAll(".channel");
		tablinks.forEach(link => link.classList.remove("active"));
	}

	function Tab_Show(name) {
		if (!name) return;
		let channel = channelMap.get(name);
		Tabs_Hide();
		if (channel && channel.channel) {
			channel.channel.classList.add('active');
			channel.button.classList.add("active");
			activeChannel = channel;
			// è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
			setTimeout(() => {
				if (channel.content) {
					channel.content.scrollTop = channel.content.scrollHeight;
				}
			}, 10);
		}
	}

	function HTML_escape(text) {
		if (!text) return "";
		let map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
		return text.replace(/[&<>"']/g, function (m) { return map[m]; });
	}

	function sortUserList(user_a, user_b) {
		if (!user_a || !user_b || user_a.length < 2 || user_b.length < 2) return 0;
		if (user_a[0][0] === user_b[0][0])
			return user_a[1].localeCompare(user_b[1], undefined, { sensitivity: 'accent' });
		if (!PrefixChars || !PrefixChars[1]) return 0;
		let aIndex = PrefixChars[1].indexOf(user_a[0][0]);
		let bIndex = PrefixChars[1].indexOf(user_b[0][0]);
		return aIndex - bIndex;
	}

	function Tab_Create(name, topic, createlist) {
		if (!name || !channels || !channelContents) {
			console.error("Tab_Create: ç¼ºå°‘å¿…è¦å…ƒç´ ");
			return;
		}
		Tabs_Hide();
		this.name = name;
		let escapedName = HTML_escape(name);

		this.button = document.createElement("button");
		this.button.innerHTML = escapedName;
		this.button.value = escapedName;
		this.button.onclick = Tab_onClick;
		this.button.className = "channel";

		let x = document.createElement("button");
		x.innerHTML = "Ã—";
		x.onclick = Tab_Close;
		x.value = escapedName;
		x.className = "x";
		this.button.appendChild(x);

		channels.appendChild(this.button);

		this.channel = document.createElement("div");
		this.channel.className = "channelcontent";

		let navWrapper = document.createElement("nav");
		this.topic = document.createElement("h3");
		this.topic.innerHTML = HTML_escape(topic || "æ— ä¸»é¢˜");
		navWrapper.appendChild(this.topic);

		this.content = document.createElement("nav");
		navWrapper.appendChild(this.content);

		this.channel.appendChild(navWrapper);

		if (createlist) {
			this.userlist = document.createElement("ul");
			this.users = [];
			this.names_end = true;
			this.channel.appendChild(this.userlist);
		}

		channelContents.appendChild(this.channel);
		channelMap.set(name, this);
		activeChannel = this;
		Tab_Show(name);
		return this;
	}

	function Tab_Close(evt) {
		evt.stopPropagation();
		if (!evt || !evt.currentTarget) return;
		doSend("part " + evt.currentTarget.value);
	}

	function Channel_Destroy(name) {
		if (!name) return;
		let channel = channelMap.get(name);
		if (!channel) return;
		channel.button.remove();
		channel.channel.remove();
		if (activeChannel == channel) {
			activeChannel = statusChannel;
		}
		channelMap.delete(name);
		if (activeChannel) {
			Tab_Show(activeChannel.name);
		}
	}

	function Channel_InsertUser(nick, channel, prefix) {
		if (!nick || !channel || !channel.userlist) return;
		let user = document.createElement("li");
		let tmp = document.createElement("p");
		if (prefix && prefix !== " ") tmp.innerHTML = prefix[0];
		user.appendChild(tmp);
		tmp = document.createElement("p");
		tmp.innerHTML = HTML_escape(nick);
		user.appendChild(tmp);
		let i = 0;
		for (i; i < channel.users.length; i++) {
			if (channel.users[i] && channel.users[i][1]) {
				if (channel.users[i][1].localeCompare(nick, undefined, { sensitivity: 'accent' }) < 0) continue;
			}
			break;
		}
		channel.users.splice(i, 0, [prefix || " ", nick]);
		channel.userlist.insertBefore(user, channel.userlist.childNodes[i]);
	}

	function Channel_AppendUser(nick, channel, dontnotify, prefix) {
		if (!nick || !channel || !channel.userlist) return;
		let user = document.createElement("li");
		let tmp = document.createElement("p");
		if (prefix && prefix !== " ") tmp.innerHTML = prefix[0];
		user.appendChild(tmp);
		tmp = document.createElement("p");
		tmp.innerHTML = HTML_escape(nick);
		user.appendChild(tmp);
		channel.userlist.appendChild(user);
	}

	function Channel_RemoveUser(nick, channel) {
		if (!nick || !channel || !channel.userlist) return;
		for (let i = 0; i < channel.userlist.children.length; i++) {
			let userItem = channel.userlist.children[i];
			if (!userItem || !userItem.children[1]) continue;
			let anick = userItem.children[1].textContent;
			if (anick == nick) {
				userItem.remove();
				if (channel.users && channel.users[i]) {
					channel.users.splice(i, 1);
				}
				return true;
			}
		}
	}

	function Channel_RenameUser(nick, newnick, channel) {
		if (!nick || !newnick || !channel) return;
		if (!channel.userlist) return;
		for (let i = 0; i < channel.users.length; i++) {
			if (channel.users[i] && channel.users[i][1] == nick) {
				let prefix = channel.users[i][0];
				Channel_RemoveUser(nick, channel);
				Channel_InsertUser(newnick, channel, prefix);
				return true;
			}
		}
	}

	function Channel_UpdateUserPrefix(nick, channel, add, prefix) {
		if (!nick || !channel || !channel.users || !PrefixChars) return;
		for (let i = 0; i < channel.users.length; i++) {
			if (channel.users[i] && channel.users[i][1] == nick) {
				let pos = PrefixChars[0].indexOf(prefix);
				if (pos < 0) return;
				let prefixes = "";
				if (add == "true" || add === true) {
					let ii;
					for (ii = 0; ii < channel.users[i][0].length; ii++) {
						if (PrefixChars[1].indexOf(channel.users[i][0][ii]) >= pos) break;
						prefixes += channel.users[i][0][ii];
					}
					prefixes += PrefixChars[1][pos];
					for (; ii < channel.users[i][0].length; ii++) {
						prefixes += channel.users[i][0][ii];
					}
				} else {
					let tmp = channel.users[i][0].indexOf(PrefixChars[1][pos]);
					if (tmp >= 0) {
						prefixes = channel.users[i][0].substring(0, tmp) + channel.users[i][0].substring(tmp + 1);
					}
				}
				if (prefixes == "") prefixes = " ";
				channel.users[i][0] = prefixes;
				Channel_RenameUser(nick, nick, channel);
				break;
			}
		}
	}

	function writeToScreen(color, message, channel, username) {
		if (!channel || !channel.content) return;
		let div = document.createElement("div");
		div.className = "chat-message";
		const now = new Date();
		const utcTime = now.toISOString().substr(11, 8);
		
		let displayMessage;
		if (username && username !== "") {
			displayMessage = `[${utcTime}] ${username}: ${linkify(message || "")}`;
		} else {
			displayMessage = `[${utcTime}] ${linkify(message || "")}`;
		}
		
		// æ ¹æ®æ¶ˆæ¯ç±»å‹æ·»åŠ CSSç±»
		if (username === "*" || username === "-") {
			if (message.includes("åŠ å…¥é¢‘é“") || message.includes("å·²åŠ å…¥é¢‘é“")) {
				div.className += " system";
			} else if (message.includes("ç¦»å¼€é¢‘é“") || message.includes("é€€å‡ºIRC")) {
				div.className += " system";
			} else if (message.includes("è®¾ç½®æ¨¡å¼") || message.includes("è®¾ç½®ä¸»é¢˜")) {
				div.className += " system";
			} else if (message.includes("ACTION")) {
				div.className += " action";
			}
		} else if (username === "ERROR") {
			div.className += " error";
		} else if (username === "-") {
			div.className += " notice";
		}
		
		div.innerHTML = displayMessage;
		let output = channel.content;
		if (output) {
			output.appendChild(div);
			while (output.children.length > 200) {
				output.removeChild(output.children[0]);
			}
			// ä¿æŒæ»šåŠ¨åœ¨åº•éƒ¨
			requestAnimationFrame(() => {
				output.scrollTop = output.scrollHeight;
			});
		}
	}

	function linkify(text) {
		const urlRegex = /(https?:\/\/[^\s<>{}|\\^`[\]]+)/g;
		return text.replace(urlRegex, function (url) {
			// éªŒè¯URLå®‰å…¨æ€§
			if (!isValidUrl(url)) {
				return url;
			}
			
			// æ£€æŸ¥åª’ä½“ç±»å‹
			if (isImageMedia(url)) {
				return createMediaPreview(url, 'image');
			} else if (isVideoMedia(url)) {
				return createMediaPreview(url, 'video');
			} else if (isAudioMedia(url)) {
				return createMediaPreview(url, 'audio');
			}
			return `<a href="${encodeURI(url)}" target="_blank" rel="noopener noreferrer" style="color: var(--clr-accent); text-decoration: underline; word-break: break-all;">${HTML_escape(url)}</a>`;
		});
	}

	// éªŒè¯URLå®‰å…¨æ€§
	function isValidUrl(url) {
		try {
			const parsedUrl = new URL(url);
			// åªå…è®¸HTTPå’ŒHTTPSåè®®
			if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {
				return false;
			}
			// é˜»æ­¢å†…éƒ¨åè®®å’Œjavascriptåè®®
			if (url.startsWith('javascript:') || url.startsWith('data:') || url.startsWith('vbscript:')) {
				return false;
			}
			return true;
		} catch (e) {
			return false;
		}
	}

	// æ£€æµ‹å›¾ç‰‡åª’ä½“ç±»å‹ - æ”¯æŒæŸ¥è¯¢å‚æ•°ä¸­çš„æ ¼å¼
	function isImageMedia(url) {
		// æ£€æŸ¥URLè·¯å¾„ä¸­çš„æ‰©å±•å
		if (/\.(jpeg|jpg|gif|png|webp|bmp|svg)(\?.*)?$/i.test(url)) {
			return true;
		}
		
		// æ£€æŸ¥æŸ¥è¯¢å‚æ•°ä¸­çš„æ ¼å¼
		const urlObj = new URL(url);
		const fmt = urlObj.searchParams.get('fmt');
		const f = urlObj.searchParams.get('f');
		const ext = urlObj.searchParams.get('ext');
		
		if (fmt && /jpeg|jpg|gif|png|webp|bmp|svg/i.test(fmt)) {
			return true;
		}
		if (f && /jpeg|jpg|gif|png|webp|bmp|svg/i.test(f)) {
			return true;
		}
		if (ext && /jpeg|jpg|gif|png|webp|bmp|svg/i.test(ext)) {
			return true;
		}
		
		// æ£€æŸ¥ç™¾åº¦å›¾ç‰‡ç­‰å¸¸è§æœåŠ¡çš„ç‰¹å®šå‚æ•°
		if (url.includes('baidu.com') && (url.includes('fmt=') || url.includes('f=JPEG') || url.includes('f=PNG'))) {
			return true;
		}
		
		return false;
	}

	// æ£€æµ‹è§†é¢‘åª’ä½“ç±»å‹
	function isVideoMedia(url) {
		return /\.(mp4|webm|ogg|avi|mov|wmv|flv|mkv)(\?.*)?$/i.test(url);
	}

	// æ£€æµ‹éŸ³é¢‘åª’ä½“ç±»å‹
	function isAudioMedia(url) {
		return /\.(mp3|wav|ogg|flac|m4a|aac)(\?.*)?$/i.test(url);
	}

	function createMediaPreview(url, type) {
		if (type === 'image') {
			return `
				<span class="media-container">
					<img src="${encodeURI(url)}" alt="é¢„è§ˆå›¾ç‰‡" onclick="openMediaPreview('${encodeURI(url)}', 'image')" onerror="handleMediaError(this)" />
					<span class="media-overlay">ç‚¹å‡»æ”¾å¤§</span>
				</span>
			`;
		} else if (type === 'video') {
			return `
				<span class="media-container">
					<video src="${encodeURI(url)}" controls style="max-width: 300px; max-height: 200px; border-radius: 4px;" onerror="handleMediaError(this)"></video>
					<span class="media-overlay">ç‚¹å‡»æ’­æ”¾</span>
				</span>
			`;
		} else if (type === 'audio') {
			return `
				<span class="media-container">
					<audio src="${encodeURI(url)}" controls style="width: 300px;" onerror="handleMediaError(this)"></audio>
				</span>
			`;
		}
		return `<a href="${encodeURI(url)}" target="_blank">${HTML_escape(url)}</a>`;
	}

	// å¤„ç†åª’ä½“åŠ è½½é”™è¯¯
	function handleMediaError(element) {
		element.style.display = 'none';
		const errorDiv = document.createElement('div');
		errorDiv.className = 'media-error';
		errorDiv.textContent = 'åª’ä½“åŠ è½½å¤±è´¥';
		element.parentNode.appendChild(errorDiv);
	}

	function openMediaPreview(url, type) {
		const modal = document.getElementById('mediaPreviewModal');
		const img = document.getElementById('previewImage');
		const video = document.getElementById('previewVideo');
		const audio = document.getElementById('previewAudio');
		const info = document.getElementById('mediaInfo');
		
		// éªŒè¯URLå®‰å…¨æ€§
		if (!isValidUrl(url)) {
			alert('æ— æ•ˆçš„åª’ä½“URL');
			return;
		}
		
		// éšè—æ‰€æœ‰åª’ä½“å…ƒç´ 
		img.style.display = 'none';
		video.style.display = 'none';
		audio.style.display = 'none';
		
		// æ˜¾ç¤ºå¯¹åº”ç±»å‹çš„åª’ä½“å…ƒç´ 
		if (type === 'image') {
			img.src = encodeURI(url);
			img.style.display = 'block';
		} else if (type === 'video') {
			video.src = encodeURI(url);
			video.style.display = 'block';
			video.load();
		} else if (type === 'audio') {
			audio.src = encodeURI(url);
			audio.style.display = 'block';
			audio.load();
		}
		
		info.textContent = url;
		
		// æ˜¾ç¤ºæ¨¡æ€æ¡†
		modal.classList.add('visible');
		
		// é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
		document.body.style.overflow = 'hidden';
	}

	function closeMediaPreview() {
		const modal = document.getElementById('mediaPreviewModal');
		const video = document.getElementById('previewVideo');
		const audio = document.getElementById('previewAudio');
		
		// åœæ­¢è§†é¢‘å’ŒéŸ³é¢‘æ’­æ”¾å¹¶é‡ç½®src
		if (video) {
			video.pause();
			video.src = '';
		}
		if (audio) {
			audio.pause();
			audio.src = '';
		}
		
		modal.classList.remove('visible');
		
		// æ¢å¤èƒŒæ™¯æ»šåŠ¨
		document.body.style.overflow = 'auto';
	}

	// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
	document.getElementById('mediaPreviewModal').addEventListener('click', function(e) {
		if (e.target === this) {
			closeMediaPreview();
		}
	});

	// æŒ‰ESCé”®å…³é—­
	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape') {
			closeMediaPreview();
		}
	});

	function send() {
		let text = input ? input.value.trim() : "";
		if (!text || !activeChannel) return;
		let msg;
		if (text[0] == "/") {
			if (text.indexOf("/me ") == 0) {
				msg = "privmsg " + activeChannel.name + " :\x01ACTION " + text.substring(4) + "\n";
				writeToScreen("var(--clr-red)", `${nickname} ${text.substring(4)}`, activeChannel, "*");
			} else {
				writeToScreen("var(--clr-font)", text, statusChannel, "");
				msg = text.substring(1) + "\n";
			}
		} else {
			msg = "privmsg " + activeChannel.name + " :" + text + "\n";
			writeToScreen("var(--clr-font)", text, activeChannel, nickname);
		}
		doSend(msg);
		if (input) input.value = "";
	}

	function WebSocket_Connect(wsUri) {
		if (!wsUri) {
			writeToLog("[ERROR] WebSocketåœ°å€ä¸ºç©º");
			return;
		}
		try {
			if (websocket) {
				try {
					websocket.onclose = null;
					websocket.onerror = null;
					websocket.onopen = null;
					websocket.onmessage = null;
					if (websocket.readyState !== WebSocket.CLOSED) {
						websocket.close(1000, "Reconnecting");
					}
				} catch (e) {
					writeToLog(`[WARN] æ¸…ç†æ—§è¿æ¥æ—¶å‡ºé”™: ${e.message}`);
				}
				websocket = null;
			}
			writeToLog(`[WebSocket] æ­£åœ¨åˆ›å»ºè¿æ¥: ${wsUri}`);
			websocket = new WebSocket(wsUri);
			websocket.binaryType = 'blob';

			const connectTimeout = setTimeout(() => {
				if (websocket && websocket.readyState === WebSocket.CONNECTING) {
					writeToLog(`[ERROR] è¿æ¥è¶…æ—¶ (30ç§’)`);
					try {
						websocket.close(1006, "Connection timeout");
					} catch (e) {
						writeToLog(`[ERROR] è¶…æ—¶å…³é—­è¿æ¥å¤±è´¥: ${e.message}`);
					}
				}
			}, 30000);

			websocket.onclose = function (evt) {
				clearTimeout(connectTimeout);
				onClose(evt);
			};
			websocket.onerror = function (evt) {
				onError(evt);
			};
			websocket.onopen = function (evt) {
				clearTimeout(connectTimeout);
				onOpen(evt);
			};
			websocket.onmessage = function (evt) {
				onMessage(evt);
			};
		} catch (e) {
			writeToLog(`[ERROR] WebSocketåˆ›å»ºå¤±è´¥: ${e.message}`);
			onDisconnect();
			if (wsUrl && wsUrl.startsWith('wss://')) {
				showSSLWarning(wsUrl);
			}
			alert(`è¿æ¥å¤±è´¥: ${e.message}\n\nå¦‚æœæ˜¯SSLè¯ä¹¦é”™è¯¯, è¯·ç‚¹å‡»"SSLå¸®åŠ©"æŸ¥çœ‹è§£å†³æ–¹æ¡ˆ`);
		}
	}

	function onClose(evt) {
		isConnected = false;
		let reason = evt.reason || 'è¿æ¥å…³é—­';
		let code = evt.code;
		let logMsg = `[CLOSE] Code: ${code}`;

		switch (code) {
			case 1000: logMsg += ' (æ­£å¸¸å…³é—­)'; break;
			case 1006: logMsg += ' (å¼‚å¸¸æ–­å¼€ - å¯èƒ½SSLè¯ä¹¦é”™è¯¯)'; break;
			case 1005: logMsg += ' (æ— çŠ¶æ€ç )'; break;
			case 1011: logMsg += ' (æœåŠ¡å™¨å¼‚å¸¸)'; break;
			default: if (code >= 4000 && code <= 4999) { logMsg += ' (åº”ç”¨å±‚é”™è¯¯)'; }
		}
		logMsg += ` - ${reason}`;

		writeToScreen("var(--clr-font)", "DISCONNECTED", statusChannel, "");
		writeToLog(logMsg);

		if (websocket) {
			try {
				websocket.onclose = null;
				websocket.onerror = null;
				websocket.onopen = null;
				websocket.onmessage = null;
			} catch (e) {
				writeToLog(`[WARN] æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å¤±è´¥: ${e.message}`);
			}
			websocket = null;
		}
		onDisconnect();
	}

	function onError(evt) {
		let errorType = 'WebSocketé”™è¯¯';
		if (evt && evt.target) {
			if (evt.target.readyState === WebSocket.CONNECTING) {
				errorType = 'è¿æ¥å¤±è´¥';
			} else if (evt.target.readyState === WebSocket.OPEN) {
				errorType = 'æ¶ˆæ¯é”™è¯¯';
			}
		}
		writeToScreen("var(--clr-red)", `ERROR: ${errorType}`, statusChannel, "");
		writeToLog(`[ERROR] ${errorType}: ${evt.data || 'æœªçŸ¥é”™è¯¯'}`);
		if (wsUrl && wsUrl.startsWith('wss://')) {
			showSSLWarning(wsUrl);
		}
	}

	function onOpen(evt) {
		isConnected = true;
		reconnectAttempts = 0;
		writeToScreen("var(--clr-font)", "CONNECTED", statusChannel, "");
		writeToLog(`[OPEN] WebSocketè¿æ¥æˆåŠŸ: ${wsUrl}`);
		updateConnectionStatus(true);

		const connectBtn = document.getElementById('connectBtn');
		if (connectBtn) {
			connectBtn.innerHTML = '<span class="btn-icon">ğŸ”Œ</span><span class="btn-text">æ–­å¼€</span>';
			connectBtn.disabled = false;
			connectBtn.classList.add('disconnect');
		}

		doSend("user websocket * * :WebSocket User");
		doSend("nick " + nickname);
	}

	function onMessage(evt) {
		if (!evt) return;
		rawData = evt.data;
		writeToLog(`â† RECV: ${typeof rawData === 'string' ? rawData : '[äºŒè¿›åˆ¶æ•°æ®]'}`);
		if (rawData instanceof Blob) {
			let fileReader = new FileReader();
			fileReader.addEventListener("loadend", handleBinaryInput);
			fileReader.readAsText(rawData);
		} else {
			process(rawData);
		}
	}

	function handleBinaryInput(event) {
		if (!event || !event.target) return;
		let fileReader = event.target;
		let raw = fileReader.result;
		writeToLog(`â† RECV (Blobâ†’Text): ${raw}`);
		process(raw);
	}

	function doSend(message) {
		if (!message) return;
		if (websocket && websocket.readyState === WebSocket.OPEN) {
			try {
				websocket.send(message);
				writeToLog(`â†’ SEND: ${message.trim()}`);
			} catch (e) {
				writeToLog(`[ERROR] å‘é€æ¶ˆæ¯å¤±è´¥: ${e.message}`);
				writeToScreen("var(--clr-red)", "å‘é€å¤±è´¥: " + e.message, statusChannel, "");
			}
		} else {
			writeToLog(`[ERROR] WebSocketæœªè¿æ¥, æ— æ³•å‘é€: ${message.trim()}`);
			if (!isConnected) {
				writeToScreen("var(--clr-red)", "æœªè¿æ¥, æ¶ˆæ¯æœªå‘é€", statusChannel, "");
			}
		}
	}

	var Commands = new Map();
	Commands.set("001", function (nick, data) {
		doSend("CAP REQ :multi-prefix");
		if (channelName) {
			doSend("join " + channelName);
			writeToLog(`[IRC] æ¥æ”¶001, å‡†å¤‡åŠ å…¥é¢‘é“: ${channelName}`);
		} else {
			writeToLog(`[IRC] æ¥æ”¶001, æœªè®¾ç½®è‡ªåŠ¨åŠ å…¥é¢‘é“`);
		}
	});
	Commands.set("005", function (nick, data) {
		if (!data || !PrefixChars) return;
		for (let i = 2; i < data.length; i++) {
			if (data[i].indexOf("PREFIX=") == 0) {
				let tmp = data[i].substring(8) + " ";
				if (tmp) {
					PrefixChars = tmp.split(")");
					writeToScreen("var(--clr-brown)", "PREFIX CHARS: " + PrefixChars[0] + " " + PrefixChars[1], statusChannel, "");
					writeToLog(`[IRC] æ”¯æŒçš„PREFIX: ${PrefixChars[0]} ${PrefixChars[1]}`);
				}
			}
		}
	});
	Commands.set("332", function (nick, data) {
		if (!data || data.length < 5) return;
		let channel = channelMap.get(data[3]);
		if (!channel || !channel.topic) return;
		let text = data[4].substring(1);
		for (let i = 5; i < data.length; i++) {
			text += " " + data[i];
		}
		channel.topic.innerHTML = HTML_escape(text || "æ— ä¸»é¢˜");
		writeToLog(`[IRC] é¢‘é“ä¸»é¢˜: ${data[3]} - ${text}`);
	});
	Commands.set("353", function (nick, data) {
		if (!data || data.length < 6) return;
		let channel = channelMap.get(data[4]);
		if (!channel) return;
		if (channel.names_end == true) {
			channel.users = [];
			channel.names_end = false;
		}
		data[5] = data[5].substring(1);
		for (let i = 5; i < data.length; i++) {
			let prefix = "";
			let ii = 0;
			while (PrefixChars && PrefixChars[1] && PrefixChars[1].indexOf(data[i][ii]) >= 0) {
				prefix += data[i][ii];
				ii++;
			}
			if (prefix == "") prefix = " ";
			channel.users.push([prefix, data[i].substring(ii)]);
		}
		writeToLog(`[IRC] æ¥æ”¶ç”¨æˆ·åˆ—è¡¨: ${channel.users.length} ç”¨æˆ·`);
	});
	Commands.set("366", function (nick, data) {
		if (!data || data.length < 4) return;
		let channel = channelMap.get(data[3]);
		if (!channel) return;
		channel.users.sort(sortUserList);
		channel.userlist.innerHTML = "";
		for (let i = 0; i < channel.users.length; i++) {
			Channel_AppendUser(channel.users[i][1], channel, true, channel.users[i][0]);
		}
		channel.names_end = true;
		writeToLog(`[IRC] ç”¨æˆ·åˆ—è¡¨åŠ è½½å®Œæˆ`);
	});
	Commands.set("432", function (nick, data) {
		nickname = prompt("é”™è¯¯: æ˜µç§°åŒ…å«éæ³•å­—ç¬¦\nè¯·è¾“å…¥æ–°çš„æ˜µç§°", "");
		if (nickname) {
			doSend("nick " + nickname);
			writeToLog(`[IRC] æ˜µç§°é”™è¯¯, é‡æ–°è¾“å…¥: ${nickname}`);
		}
	});
	Commands.set("433", function (nick, data) {
		nickname = prompt("é”™è¯¯: æ˜µç§°å·²è¢«å ç”¨\nè¯·è¾“å…¥æ–°çš„æ˜µç§°", "");
		if (nickname) {
			doSend("nick " + nickname);
			writeToLog(`[IRC] æ˜µç§°å†²çª, æ–°æ˜µç§°: ${nickname}`);
		}
	});
	Commands.set("JOIN", function (nick, data) {
		if (!data || data.length < 3) return;
		if (data[0].indexOf(":" + nickname + "!") != 0) {
			if (data[2][0] == ":") data[2] = data[2].substring(1);
			let channel = channelMap.get(data[2]);
			if (!channel) return;
			Channel_InsertUser(nick, channel, " ");
			writeToScreen("var(--clr-green)", `${nick} åŠ å…¥é¢‘é“`, channel, "*");
		} else {
			let channel = new Tab_Create(data[2].substring(1), "", true);
			nick = nickname;
			writeToScreen("var(--clr-green)", `ä½ å·²åŠ å…¥é¢‘é“ ${data[2].substring(1)}`, channel, "*");
		}
		writeToLog(`[IRC] ç”¨æˆ·åŠ å…¥: ${nick} â†’ ${data[2]}`);
	});
	Commands.set("KICK", function (nick, data) {
		if (!data || data.length < 5) return;
		let channel = channelMap.get(data[2]);
		if (!channel) return;
		let text = data[4].substring(1);
		for (let i = 5; i < data.length; i++) {
			text += " " + data[i];
		}
		if (data[3] != nickname) {
			if (Channel_RemoveUser(data[3], channel)) {
				writeToScreen("var(--clr-red)", `${data[3]} è¢« ${nick} è¸¢å‡º (åŸå› : ${text})`, channel, "*");
			}
		} else {
			Channel_Destroy(data[2]);
			writeToScreen("var(--clr-red)", `ä½ è¢« ${nick} è¸¢å‡º ${data[2]} (åŸå› : ${text})`, statusChannel, "");
		}
		writeToLog(`[IRC] è¢«è¸¢å‡º: ${data[2]} by ${nick} - ${text}`);
	});
	Commands.set("MODE", function (nick, data) {
		if (!data || data.length < 4) return;
		let channel = channelMap.get(data[2]);
		if (!channel) return;
		let text = data[3];
		for (let i = 4; i < data.length; i++) {
			text += " " + data[i];
		}
		writeToScreen("var(--clr-blue)", `${nick} è®¾ç½®æ¨¡å¼: ${text}`, channel, "*");
		if (!PrefixChars || data[3].length < 1) return;
		let ii = 4;
		let status = "false";
		for (let i = 0; i < data[3].length; i++) {
			if (data[3][i] == "+") status = "true";
			else if (data[3][i] == "-") status = "false";
			else {
				if (ii < data.length) {
					Channel_UpdateUserPrefix(data[ii], channel, status, data[3][i]);
					ii++;
				}
			}
		}
		writeToLog(`[IRC] æ¨¡å¼å˜æ›´: ${text}`);
	});
	Commands.set("NICK", function (nick, data) {
		if (!data || data.length < 3) return;
		let newnick = data[2].substring(1);
		if (nick == nickname) nickname = newnick;
		channelMap.forEach(function (channel, name) {
			if (Channel_RenameUser(nick, newnick, channel)) {
				if (newnick == nickname) {
					writeToScreen("var(--clr-green)", `ä½ ç°åœ¨çš„æ–°æ˜µç§°æ˜¯ ${newnick}`, channel, "*");
				} else {
					writeToScreen("var(--clr-green)", `${nick} æ›´åä¸º ${newnick}`, channel, "*");
				}
			}
		});
		writeToLog(`[IRC] æ˜µç§°å˜æ›´: ${nick} â†’ ${newnick}`);
	});
	Commands.set("PART", function (nick, data) {
		if (!data || data.length < 3) return;
		if (data[0].indexOf(":" + nickname + "!") != 0) {
			let channel = channelMap.get(data[2]);
			if (!channel) return;
			if (Channel_RemoveUser(nick, channel)) {
				writeToScreen("var(--clr-green)", `${nick} ç¦»å¼€é¢‘é“`, channel, "*");
			}
		} else {
			Channel_Destroy(data[2]);
			writeToScreen("var(--clr-green)", `ä½ å·²ç¦»å¼€é¢‘é“ ${data[2]}`, statusChannel, "");
		}
		writeToLog(`[IRC] ç¦»å¼€é¢‘é“: ${data[2]}`);
	});
	Commands.set("TOPIC", function (nick, data) {
		if (!data || data.length < 4) return;
		let channel = channelMap.get(data[2]);
		if (!channel || !channel.topic) return;
		let text = data[3].substring(1);
		for (let i = 4; i < data.length; i++) {
			text += " " + data[i];
		}
		channel.topic.innerHTML = HTML_escape(text || "æ— ä¸»é¢˜");
		writeToScreen("var(--clr-blue)", `${nick} è®¾ç½®ä¸»é¢˜ä¸º: ${text}`, channel, "*");
		writeToLog(`[IRC] ä¸»é¢˜å˜æ›´: ${data[2]} - ${text}`);
	});
	Commands.set("QUIT", function (nick, data) {
		channelMap.forEach(function (channel, name) {
			if (Channel_RemoveUser(nick, channel)) {
				writeToScreen("var(--clr-purple)", `${nick} é€€å‡ºIRC`, channel, "*");
			}
		});
		writeToLog(`[IRC] ç”¨æˆ·é€€å‡º: ${nick}`);
	});
	Commands.set("PRIVMSG", function (nick, data) {
		if (!data || data.length < 4) return;
		let channel = channelMap.get(data[2]);
		if (!channel) channel = statusChannel;
		let text = data[3].substring(1);
		for (let i = 4; i < data.length; i++) {
			text += " " + data[i];
		}
		nick = data[0].substring(1).split("!")[0];
		if (text[0] == "\x01") {
			if (text.indexOf("\x01ACTION ") == 0) {
				writeToScreen("var(--clr-red)", `${nick} ${text.substring(8)}`, channel, "*");
			} else {
				writeToScreen("var(--clr-red)", `${nick} ${text}`, channel, "*");
			}
		} else {
			writeToScreen("var(--clr-font)", text, channel, nick);
		}
	});
	Commands.set("NOTICE", function (nick, data) {
		if (!data || data.length < 4) return;
		let channel = channelMap.get(data[2]);
		if (!channel) channel = statusChannel;
		let text = data[3].substring(1);
		for (let i = 4; i < data.length; i++) {
			text += " " + data[i];
		}
		nick = data[0].substring(1).split("!")[0];
		writeToScreen("var(--clr-gold)", `é€šçŸ¥ ${nick}: ${text}`, channel, "-");
		writeToLog(`[NOTICE] ${nick}: ${text}`);
	});

	function process(rawData) {
		if (!rawData) return;
		let data = rawData.split(" ");
		if (!data || data.length < 2) {
			writeToLog(`[DEBUG] æ— æ•ˆæ•°æ®: ${rawData}`);
			return;
		}
		let nick = data[0].substring(1).split("!")[0];
		let command = data[1].toUpperCase();
		let fn = Commands.get(command);
		if (fn) {
			fn(nick, data);
			return;
		}
		if (!isNaN(parseInt(data[1]))) {
			let text = data[1];
			for (let i = 3; i < data.length; i++) {
				text += " " + data[i];
			}
			writeToScreen("var(--clr-gold)", text, statusChannel, "");
			writeToLog(`[SERVER] ${data[1]}: ${text}`);
			return;
		}
		if (data[0] == "PING") {
			let pongResponse = rawData.replace("PING", "PONG");
			writeToScreen("var(--clr-brown)", pongResponse, statusChannel, "");
			doSend(pongResponse);
			writeToLog(`[PING/PONG] ${pongResponse}`);
			return;
		}
		if (data[0] == "ERROR") {
			writeToScreen("var(--clr-font)", rawData, statusChannel, "");
			writeToLog(`[ERROR] ${rawData}`);
			return;
		}
		console.log("DEBUG:", rawData);
		writeToLog(`[DEBUG] ${rawData}`);
	}
</script>
</html>
