<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* 现代化配色方案 */
:root {
	--clr-background: #F5F7FA;
	--clr-background2: #E4E7F4;
	--clr-background3: #FFFFFF;
	--clr-background4: #D1D5DB;
	--clr-font: #1F2937;
	--clr-brown: #92400E;
	--clr-green: #065F46;
	--clr-gold: #D97706;
	--clr-red: #DC2626;
	--clr-purple: #7C3AED;
	--clr-blue: #2563EB;
	--clr-accent: #4F46E5;
	--clr-border: #9CA3AF;
}

@media (prefers-color-scheme: dark) {
	:root {
		--clr-background: #111827;
		--clr-background2: #1F2937;
		--clr-background3: #1F2937;
		--clr-background4: #4B5563;
		--clr-font: #F9FAFB;
		--clr-brown: #FDE68A;
		--clr-green: #6EE7B7;
		--clr-gold: #FBBF24;
		--clr-red: #FCA5A5;
		--clr-purple: #C4B5FD;
		--clr-blue: #93C5FD;
		--clr-accent: #818CF8;
		--clr-border: #4B5563;
	}
}

/* 全局字体和布局优化 */
html, body {
	text-align: center; 
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	margin: 0;
	padding: 0;
	height: 100%;
	width: 100%;
	box-sizing: border-box;
	overflow-x: hidden;
	background-color: var(--clr-background); 
	color: var(--clr-font);
	font-size: 14px;
	line-height: 1.5;
}

/* 标题样式优化 */
h1 {
	background: linear-gradient(90deg, var(--clr-accent), var(--clr-purple));
	-webkit-background-clip: text; 
	-webkit-text-fill-color: transparent;
	font-weight: 700;
	letter-spacing: -0.5px;
	margin: 0;
	padding: 20px;
}

/* 主容器优化 */
.main {
	margin: 0;
	height: 100%;
	width: 100%;
	display: flex;
	flex-direction: column;
	box-sizing: border-box;
}

/* 设置面板 - 卡片式设计 */
.settings-panel {
	flex: 0 1 auto;
	padding: 20px;
	background-color: var(--clr-background2);
	display: flex;
	flex-direction: column;
	gap: 15px;
	border-bottom: 2px solid var(--clr-border);
}

.settings-row {
	display: flex;
	gap: 15px;
	align-items: center;
	max-width: 800px;
	width: 100%;
	margin: 0 auto;
}

.settings-row label {
	flex: 0 0 100px;
	text-align: right;
	font-weight: 600;
	color: var(--clr-font);
}

.settings-row input {
	flex: 1 1 auto;
	padding: 10px 15px;
	background-color: var(--clr-background3);
	color: var(--clr-font);
	border: 1px solid var(--clr-border);
	border-radius: 8px;
	font-size: 14px;
	transition: all 0.3s ease;
}

.settings-row input:focus {
	outline: none;
	border-color: var(--clr-accent);
	box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.connect-btn {
	flex: 0 0 auto;
	padding: 10px 30px;
	background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
	color: white;
	border: none;
	border-radius: 8px;
	cursor: pointer;
	font-weight: 600;
	font-size: 14px;
	transition: all 0.3s ease;
	box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.connect-btn:hover {
	transform: translateY(-2px);
	box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.connect-btn:disabled {
	background: var(--clr-background4);
	cursor: not-allowed;
	transform: none;
	box-shadow: none;
}

.connect-btn.disconnect {
	background: linear-gradient(135deg, var(--clr-red), #EF4444);
}

/* 日志窗口 - 更集成化设计 */
.log-container {
	flex: 0 0 auto;
	height: 120px;
	border: 1px solid var(--clr-border);
	margin: 10px;
	border-radius: 8px;
	display: flex;
	flex-direction: column;
	overflow: hidden;
	background-color: var(--clr-background3);
}

.log-header {
	flex: 0 0 auto;
	padding: 8px 15px;
	background-color: var(--clr-background2);
	font-weight: 600;
	text-align: left;
	border-bottom: 1px solid var(--clr-border);
	color: var(--clr-font);
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.log-controls {
	display: flex;
	gap: 10px;
}

.log-controls button {
	padding: 4px 10px;
	background-color: var(--clr-background4);
	border: none;
	border-radius: 4px;
	cursor: pointer;
	font-size: 11px;
	transition: all 0.2s;
}

.log-controls button:hover {
	background-color: var(--clr-accent);
	color: white;
}

#logOutput {
	flex: 1 1 auto;
	overflow-y: auto;
	padding: 10px;
	font-size: 12px;
	text-align: left;
	white-space: pre-wrap;
	word-wrap: break-word;
	font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
	background-color: var(--clr-background3);
	color: var(--clr-font);
}

/* 频道标签样式 - 药丸式设计 */
.channels {
	padding: 0;
	flex: 0 1 auto;
	display: flex;
	flex-direction: row;
	justify-content: start;
	align-items: center;
	background-color: var(--clr-background2);
	border-bottom: 1px solid var(--clr-border);
	min-height: 50px;
}

.channel {
	padding: 10px 20px;
	margin: 5px;
	background-color: var(--clr-background3);
	border: 1px solid var(--clr-border);
	border-radius: 20px;
	cursor: pointer;
	font-weight: 500;
	transition: all 0.2s ease;
	display: flex;
	align-items: center;
	gap: 8px;
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.channel:hover {
	background-color: var(--clr-background4);
	transform: translateY(-1px);
}

.channel.active {
	background: linear-gradient(135deg, var(--clr-accent), var(--clr-purple));
	color: white;
	border-color: var(--clr-accent);
	box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
}

.channel button.x {
	background: none;
	border: none;
	color: inherit;
	cursor: pointer;
	padding: 2px 6px;
	font-weight: bold;
	border-radius: 50%;
	transition: all 0.2s;
}

.channel button.x:hover {
	background-color: rgba(255, 255, 255, 0.2);
}

/* 频道内容区域 */
.channelcontents {
	box-sizing: border-box;
	flex: 1 1 auto;
	flex-grow: 1;
	width: 100%;
	overflow: hidden;
	padding: 0 10px;
}

/* 输入框优化 */
#input {
	border: 1px solid var(--clr-border);
	flex: 0 1 auto;
	width: calc(100% - 20px);
	justify-content: end;
	padding: 12px 15px;
	margin: 0 10px 10px;
	border-radius: 8px;
	background-color: var(--clr-background3);
	color: var(--clr-font);
	font-size: 14px;
	transition: all 0.3s ease;
}

#input:focus {
	outline: none;
	border-color: var(--clr-accent);
	box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

/* 频道内容布局优化 */
.channelcontent {
	height: 100%;
	display: flex;
	flex-direction: row;
	gap: 10px;
	padding: 10px 0;
}

.channelcontent nav {
	box-sizing: border-box;
	flex: 1 1 auto;
	flex-grow: 1;
	float: left;
	height: 100%;
	width: 100%;
	display: flex;
	flex-direction: column;
	background-color: var(--clr-background3);
	border-radius: 8px;
	overflow: hidden;
	border: 1px solid var(--clr-border);
}

.channelcontent nav h3 {
	box-sizing: border-box;
	width: 100%;
	border-bottom: 1px solid var(--clr-border);
	float: left;
	text-align: left;
	padding: 12px 15px;
	margin: 0;
	flex: 0 1 auto;
	background-color: var(--clr-background2);
	font-weight: 600;
	color: var(--clr-font);
}

.channelcontent nav nav {
	width: 100%;
	float: left;
	overflow-y: auto;
	border: none;
	flex: 1 1 auto;
	flex-grow: 1;
	padding: 15px;
}

/* 消息样式优化 */
.channelcontent nav p {
	overflow-wrap: break-word;
	text-align: left;
	padding: 4px 0;
	margin: 0;
	line-height: 1.6;
}

/* 用户列表优化 */
ul {
	box-sizing: border-box;
	justify-content: right;
	overflow-y: auto;
	flex: 0 0 200px;
	height: 100%;
	padding: 10px;
	margin: 0;
	border-left: 1px solid var(--clr-border);
	list-style-type: none;
	background-color: var(--clr-background3);
	border-radius: 0 8px 8px 0;
}

.channelcontents li {
	padding: 6px 10px;
	margin: 2px 0;
	border-radius: 6px;
	display: flex;
	align-items: center;
	gap: 8px;
	transition: background-color 0.2s;
}

.channelcontents li:hover {
	background-color: var(--clr-background2);
}

.channelcontents li p {
	margin: 0;
	padding: 0;
}

.channelcontents li p:first-child {
	border: 0;
	float: left;
	width: 20px;
	color: var(--clr-purple);
	text-align: center;
	font-weight: bold;
}

.channelcontents li p:nth-child(2) {
	border: 0;
	float: right;
	flex: 1;
	color: var(--clr-green);
	text-align: left;
}

/* 滚动条美化 */
::-webkit-scrollbar {
	width: 8px;
	height: 8px;
}

::-webkit-scrollbar-track {
	background: var(--clr-background);
}

::-webkit-scrollbar-thumb {
	background: var(--clr-accent);
	border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
	background: var(--clr-purple);
}

/* 响应式设计 */
@media (max-width: 768px) {
	.settings-row {
		flex-direction: column;
		align-items: stretch;
	}
	
	.settings-row label {
		text-align: left;
		flex: 1 1 auto;
	}
	
	.channelcontent {
		flex-direction: column;
	}
	
	ul {
		flex: 0 0 150px;
		border-left: none;
		border-top: 1px solid var(--clr-border);
	}
}
</style>
</head>
<body>
<div class="main">
<div class="header" style = "background-image: linear-gradient(var(--clr-background2), var(--clr-background),var(--clr-background),var(--clr-background2));">
	<h1 id="caption">Abjects IRC Network</h1>
</div>

<!-- 设置面板 -->
<div class="settings-panel">
	<div class="settings-row">
		<label for="wsUrl">WebSocket地址:</label>
		<input type="text" id="wsUrl" value="" placeholder="wss://irc.example.com:port/">
	</div>
	<div class="settings-row">
		<label for="nickInput">昵称:</label>
		<input type="text" id="nickInput" value="" placeholder="输入你的昵称">
	</div>
	<div class="settings-row">
		<label for="channelInput">频道:</label>
		<input type="text" id="channelInput" value="#abjects" placeholder="#channel">
	</div>
	<div class="settings-row">
		<button class="connect-btn" id="connectBtn" onclick="toggleConnection()">连接</button>
	</div>
</div>

<!-- 日志输出窗口 -->
<div class="log-container" style="display: none;">
	<div class="log-header">
		<span>WebSocket日志</span>
		<div class="log-controls">
			<button onclick="clearLog()">清空</button>
			<button onclick="toggleLog()">折叠</button>
		</div>
	</div>
	<div id="logOutput"></div>
</div>

<div class="channels" style="display: none;"></div>
<nav class="channelcontents" style="display: none;"></nav>

<input type="text" name="input" id="input" size="30" value="" onKeyPress="onKeyPress(event)" onKeyDown="onKeyDown(event)" placeholder="输入消息..."/>
</div>
</body>
<script>
////////////////////////////////////////////////////////////////
//STARTUP + INIT
var nickname = "";
var channelName = "";
var wsUrl = "";
var channels, channelContents;
var channelMap = new Map();
var activeChannel = null;
var statusChannel = null;
var input;
var PrefixChars;

var websocket = null;
var isConnected = false;

function getSettingsElements() {
	return {
		wsUrlInput: document.getElementById('wsUrl'),
		nickInput: document.getElementById('nickInput'),
		channelInput: document.getElementById('channelInput'),
		connectBtn: document.getElementById('connectBtn')
	};
}

function onLoad()
{
	channels = document.getElementsByClassName("channels")[0];
	channelContents = document.getElementsByClassName("channelcontents")[0];
	input = document.getElementById("input");
	
	let url = new URL(document.location);
	if (url.hash) {
		let channelInput = document.getElementById('channelInput');
		channelInput.value = url.hash;
	}
	
	if (window.frameElement) {
		let caption = document.getElementById("caption");
		caption.style.display = "none";
	}
}

window.addEventListener("load", onLoad, false);

function toggleConnection() {
	if (isConnected) {
		if (websocket) {
			websocket.close();
		}
	} else {
		doConnect();
	}
}

function validateNickname(nick) {
	if (!nick || nick.trim() === "") {
		return false;
	}
	return /^[a-zA-Z_\\`\[\]{}^|][a-zA-Z0-9_\\`\[\]{}^|-]*$/.test(nick);
}

function doConnect() {
	const settings = getSettingsElements();
	
	wsUrl = settings.wsUrlInput.value.trim();
	nickname = settings.nickInput.value.trim();
	channelName = settings.channelInput.value.trim();
	
	if (!wsUrl) {
		alert("请输入WebSocket地址");
		return;
	}
	
	if (!validateNickname(nickname)) {
		alert("昵称格式无效！\n昵称必须以字母或特定符号开头，不能包含空格");
		return;
	}
	
	if (!channelName.startsWith('#')) {
		channelName = '#' + channelName;
	}
	
	settings.wsUrlInput.disabled = true;
	settings.nickInput.disabled = true;
	settings.channelInput.disabled = true;
	settings.connectBtn.textContent = '连接中...';
	settings.connectBtn.disabled = true;
	
	document.querySelector('.log-container').style.display = 'flex';
	
	channels.innerHTML = '';
	channelContents.innerHTML = '';
	channelMap.clear();
	
	statusChannel = new Tab_Create("Status", "Status Window", false);
	
	writeToLog(`[系统] 正在连接: ${wsUrl}`);
	WebSocket_Connect(wsUrl);
}

function onDisconnect() {
	isConnected = false;
	const settings = getSettingsElements();
	
	settings.wsUrlInput.disabled = false;
	settings.nickInput.disabled = false;
	settings.channelInput.disabled = false;
	settings.connectBtn.textContent = '连接';
	settings.connectBtn.disabled = false;
	settings.connectBtn.classList.remove('disconnect');
	
	writeToLog(`[系统] 已断开连接`);
	
	document.querySelector('.channels').style.display = 'none';
	document.querySelector('.channelcontents').style.display = 'none';
	document.getElementById('input').style.display = 'none';
}

// 新增日志控制函数
function clearLog() {
	document.getElementById('logOutput').textContent = '';
}

function toggleLog() {
	const logOutput = document.getElementById('logOutput');
	const btn = event.target;
	if (logOutput.style.display === 'none') {
		logOutput.style.display = 'block';
		btn.textContent = '折叠';
	} else {
		logOutput.style.display = 'none';
		btn.textContent = '展开';
	}
}

////////////////////////////////////////////////////////////////
//UI 
function onKeyPress(e) {
	if(e && e.keyCode == 13) {
		send();
	}
}

function onKeyDown(e) {
	if(e.keyCode == 9)
	{
		if(e.preventDefault) 
		{
			e.preventDefault();
		}
		console.log("TODO: TAB KEY");
		return false;
	}
}

function Tab_onClick(evt) {
	let chanName = evt.currentTarget.value;
	Tab_Show(chanName);
}

function Tabs_Hide()
{
	let i, tabcontent, tablinks;
	tabcontent = document.getElementsByClassName("channelcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}
	tablinks = document.getElementsByClassName("channel");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}
}

function Tab_Show(name) {
	let channel = channelMap.get(name);
	Tabs_Hide();
	if (channel && channel.channel) {
		channel.channel.style.display = "flex";
		channel.button.className += " active";
		activeChannel = channel;
	}
}

function HTML_escape(text)
{
	if (!text)
		return "";
	let map = {
		'&': '&amp;',
		'<': '&lt;',
		'>': '&gt;',
		'"': '&quot;',
		"'": '&#039;'
	};
	return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function sortUserList(user_a, user_b)
{
	if (user_a[0][0] === user_b[0][0])
		return user_a[1].localeCompare(user_b[1], undefined, { sensitivity: 'accent' });
	return PrefixChars[1].indexOf(user_a[0][0]) - PrefixChars[1].indexOf(user_b[0][0]);
}

function Tab_Create(name, topic, createlist)
{
	Tabs_Hide();
	this.name = name;
	let escapedName = HTML_escape(name);
	this.button = document.createElement("button");
		this.button.innerHTML = escapedName;
		this.button.value = escapedName;
		this.button.onclick = Tab_onClick;
		this.button.className = "channel active";
		let x = document.createElement("button");
			x.innerHTML = "×";
			x.nonce = escapedName;
			x.onclick = Tab_Close;
			x.value = escapedName;
			x.className = "x";
		this.button.appendChild(x);
	channels.appendChild(this.button);
	this.channel = document.createElement("nav");
		this.channel.className = "channelcontent";
		this.channelnav = document.createElement("nav");
			this.topic = document.createElement("h3");
			if (topic)
				this.topic.innerHTML = HTML_escape(topic);
			else
				this.topic.innerHTML = HTML_escape("no channeltopic available");
		this.channelnav.appendChild(this.topic)
		this.content = document.createElement("nav");
		this.channelnav.appendChild(this.content);
		this.channel.appendChild(this.channelnav);
		if (createlist) 
		{
			this.userlist = document.createElement("ul");
			this.users = new Array();
			this.names_end = true;
			this.channel.appendChild(this.userlist);
		}
	channelContents.insertBefore(this.channel, channelContents.children[0]);
	channelMap.set(name, this);
	activeChannel = this;
}

function Tab_Close(evt)
{
	doSend("part " + evt.currentTarget.value);
}

function Channel_Destroy(name) {
	let channel = channelMap.get(name);
	if (!channel)
		return;
	channel.button.remove();
	channel.channel.remove();
	if (activeChannel == channel)
	{
		activeChannel = statusChannel;
	}
	channelMap.delete(name);
	if (activeChannel) {
		Tab_Show(activeChannel.name);
	}
}

function Channel_InsertUser(nick, channel, prefix)
{
	let user = document.createElement("li");
	let tmp = document.createElement("p");
	if (prefix && prefix !== " ")
		tmp.innerHTML = prefix[0];
	user.appendChild(tmp);
	tmp = document.createElement("p");
	tmp.innerHTML = HTML_escape(nick);
	user.appendChild(tmp);
	let i = 0;
	for (i; i < channel.users.length; i++)
	{
		if (PrefixChars && PrefixChars[1] && channel.users[i][0] && channel.users[i][0][0]) {
			if (PrefixChars[1].indexOf(channel.users[i][0][0]) > PrefixChars[1].indexOf(prefix[0]))
				break;
			if (PrefixChars[1].indexOf(channel.users[i][0][0]) < PrefixChars[1].indexOf(prefix[0]))
				continue;
		}
		if (channel.users[i][1].localeCompare(nick, undefined, { sensitivity: 'accent' }) < 0)
			continue;
		break;
	}
	channel.users.splice(i, 0, [prefix , nick]);
	channel.userlist.insertBefore(user, channel.userlist.childNodes[i]);
}

function Channel_AppendUser(nick, channel, dontnotify, prefix)
{
	let user = document.createElement("li");
	let tmp = document.createElement("p");
	if (prefix && prefix !== " ")
		tmp.innerHTML = prefix[0];
	user.appendChild(tmp);
	tmp = document.createElement("p");
	tmp.innerHTML = HTML_escape(nick);
	user.appendChild(tmp);
	channel.userlist.appendChild(user);
}

function Channel_RemoveUser(nick, channel)
{
	if (!channel.userlist)
		return;
	for (let i = 0; i < channel.userlist.children.length; i++)
	{
		let anick = channel.userlist.children[i].children[1].textContent;
		if (anick == nick)
		{
			channel.userlist.children[i].remove();
			channel.users.splice(i, 1);
			return true;
		}
	}
}

function Channel_RenameUser(nick, newnick, channel)
{
	if (!channel.userlist)
		return;
	for (let i = 0; i < channel.users.length; i++)
	{
		if (channel.users[i][1] == nick)
		{
			let prefix = channel.users[i][0];
			Channel_RemoveUser(nick, channel);
			Channel_InsertUser(newnick, channel, prefix);
			return true;
		}
	}
}

function Channel_UpdateUserPrefix(nick, channel, add, prefix)
{
	for (let i=0;i<channel.users.length;i++)
	{
		if (channel.users[i][1] == nick)
		{
			let pos = PrefixChars[0].indexOf(prefix);
			if (pos < 0)
				return;
			let prefixes = "";
			if (add == "true")
			{
				let ii;
				for (ii=0; ii < channel.users[i][0].length;ii++)
				{
					if (PrefixChars[1].indexOf(channel.users[i][0][ii]) >= pos)
						break;
					prefixes += channel.users[i][0][ii]
				}
				prefixes += PrefixChars[1][pos]
				for (ii; ii < channel.users[i][0].length;ii++)
				{
					prefixes += channel.users[i][0][ii]
				}
			}
			else
			{
				let tmp = channel.users[i][0].indexOf(PrefixChars[1][pos]);
				prefixes = channel.users[i][0].substring(0, tmp) + channel.users[i][0].substring(tmp + 1);
			}
			if (prefixes == "")
				prefixes = " ";
			channel.users[i][0] = prefixes;
			Channel_RenameUser(nick, nick, channel);
			break;
		}
	}
}

function writeToScreen(color, message, channel)
{
	let pre = document.createElement("p");
	pre.style.color = color;
	pre.textContent = message;
	let output = channel.content;
	if (output) {
		output.appendChild(pre);
		while (output.children.length > 200)
		{
			output.removeChild(output.children[0]);
		}
		output.scrollTop = output.scrollHeight;
	}
}

function writeToLog(message) {
	const logOutput = document.getElementById('logOutput');
	if (logOutput) {
		const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
		logOutput.textContent += `[${timestamp}] ${message}\n`;
		logOutput.scrollTop = logOutput.scrollHeight;
	}
}

function send()
{
	let text = document.getElementById("input").value.trim();
	if (!text) return;
	
	let msg;
	if (text[0] == "/")
	{
		if (text.indexOf("/me ") == 0)
		{
			msg = "privmsg " + activeChannel.name + " :\x01ACTION " + text.substring(4) +"\n";
			writeToScreen("var(--clr-red)", "* " + nickname + " " + text.substring(4), activeChannel);
		} else {
			writeToScreen("var(--clr-font)", text, statusChannel);
			msg = text.substring(1) +"\n";
		}
	}
	else
	{
		msg = "privmsg " + activeChannel.name + " :" + text +"\n";
		writeToScreen("var(--clr-font)", "<" + nickname + "> " + text, activeChannel);
	}
	
	writeToLog(`→ SEND: ${msg.trim()}`);
	doSend(msg);
	input.value = "";
}
////////////////////////////////////////////////////////////////
//WEBSOCKET STUFF
function WebSocket_Connect(wsUri)
{
	websocket = new WebSocket(wsUri);
	websocket.binaryType = 'blob'
	websocket.onclose = function(evt) { onClose(evt) };
	websocket.onerror = function(evt) { onError(evt) };
	websocket.onopen = function(evt) { onOpen(evt) };
	websocket.onmessage = function(evt) { onMessage(evt) };
}

function onClose(evt)
{
	isConnected = false;
	writeToScreen("var(--clr-font)", "DISCONNECTED", statusChannel);
	writeToLog(`[CLOSE] ${evt.code} - ${evt.reason || '连接关闭'}`);
	onDisconnect();
}

function onError(evt)
{
	writeToScreen("var(--clr-red)", "ERROR: " + evt.data, statusChannel);
	writeToLog(`[ERROR] ${evt.data || 'WebSocket错误'}`);
}

function onOpen(evt)
{
	isConnected = true;
	writeToScreen("var(--clr-font)", "CONNECTED", statusChannel);
	writeToLog(`[OPEN] WebSocket连接成功: ${wsUrl}`);
	
	document.querySelector('.channels').style.display = 'flex';
	document.querySelector('.channelcontents').style.display = 'flex';
	document.getElementById('input').style.display = 'block';
	
	const settings = getSettingsElements();
	settings.connectBtn.textContent = '断开';
	settings.connectBtn.disabled = false;
	settings.connectBtn.classList.add('disconnect');
	
	doSend("user websocket * * :Abjects WebSocket User");
	doSend("nick " + nickname);
}

function onMessage(evt)
{
	rawData = evt.data;
	writeToLog(`← RECV: ${typeof rawData === 'string' ? rawData : '[Blob data]'}`);
	
	if (rawData instanceof Blob)
	{
		let fileReader = new FileReader();
		fileReader.addEventListener("loadend",handleBinaryInput);
		fileReader.readAsText(rawData);
	}
	else
	{
		process(rawData);
	}
}

function handleBinaryInput(event)
{
	let fileReader = event.target;
	let raw = fileReader.result;
	writeToLog(`← RECV (Blob): ${raw}`);
	process(raw);
}

function doSend(message)
{
	if (websocket && websocket.readyState === WebSocket.OPEN) {
		websocket.send(message);
	} else {
		writeToLog(`[ERROR] WebSocket未连接，无法发送: ${message.trim()}`);
	}
}

////////////////////////////////////////////////////////////////
//IRC PROTOCOL
var Commands = new Map();
Commands.set("001", function (nick, data) {
	doSend("CAP REQ :multi-prefix");
	doSend("join " + channelName);
	writeToLog(`[IRC] 接收001，准备加入频道: ${channelName}`);
});
Commands.set("005", function (nick, data) {
	for (let i=2;i<data.length;i++)
	{
		if (data[i].indexOf("PREFIX=") == 0)
		{
			PrefixChars = (data[i].substring(8) +" ").split(")");
			writeToScreen("var(--clr-brown)", "*** PREFIX CHARS: " + PrefixChars[0] + " " + PrefixChars[1], statusChannel);
			writeToLog(`[IRC] 支持的PREFIX: ${PrefixChars[0]} ${PrefixChars[1]}`);
		}
	}
});
Commands.set("332", function (nick, data) {
	channel = channelMap.get(data[3]);
	if (!channel)
		return;
	text = data[4].substring(1);
	for (let i=5;i<data.length;i++)
	{
		text += " " + data[i];
	}
	if (text)
		channel.topic.innerHTML = HTML_escape(text);
	else
		channel.topic.innerHTML = HTML_escape("no channeltopic available");
	writeToLog(`[IRC] 频道主题: ${data[3]} - ${text}`);
});
Commands.set("353", function (nick, data) {
	channel = channelMap.get(data[4]);
	if (!channel)
		return;
	if (channel.names_end == true)
	{
		channel.users = new Array();
		channel.names_end = false;
	}
	data[5] = data[5].substring(1);
	for (let i=5;i<data.length;i++)
	{
		prefix="";
		ii = 0;
		while (PrefixChars[1].indexOf(data[i][ii]) >= 0)
		{
			prefix += data[i][ii];
			ii++;
		}
		if (prefix == "")
			prefix = " ";
		channel.users.push([prefix, data[i].substring(ii)])
	}
	writeToLog(`[IRC] 接收用户列表: ${channel.users.length} 用户`);
});
Commands.set("366", function (nick, data) {
	channel = channelMap.get(data[3]);
	if (!channel)
		return;
	channel.users.sort(sortUserList);
	channel.userlist.innerHTML = "";
	for (let i=0;i<channel.users.length;i++)
		Channel_AppendUser(channel.users[i][1], channel, true, channel.users[i][0]);
	channel.names_end = true;
	writeToLog(`[IRC] 用户列表加载完成`);
});
Commands.set("432", function (nick, data) {
	nickname = prompt("ERROR: Nickname is unavailable: Illegal characters\r\nPlease enter your nickname", "AbjectsGuest" + Math.floor((Math.random() * 10000) + 1).toString());
	doSend("nick " + nickname);	
	writeToLog(`[IRC] 昵称错误，重新输入: ${nickname}`);
});
Commands.set("433", function (nick, data) {
	nickname = prompt("ERROR: Nickname is already in use.\r\nPlease enter your nickname", "AbjectsGuest" + Math.floor((Math.random() * 10000) + 1).toString());
	doSend("nick " + nickname);	
	writeToLog(`[IRC] 昵称冲突，新昵称: ${nickname}`);
});
Commands.set("JOIN", function (nick, data) {
	if (data[0].indexOf(":"+nickname+"!") != 0)
	{
		if (data[2][0] == ":")
			data[2] = data[2].substring(1);
		channel = channelMap.get(data[2]);
		if (!channel)
			return;
		Channel_InsertUser(nick, channel, " ");
	}
	else
	{
		channel = new Tab_Create(data[2].substring(1),"",true);
		nick = nickname;
	}
	writeToScreen("var(--clr-green)", "* " + nick + " JOINED", channel);
	writeToLog(`[IRC] 用户加入: ${nick} -> ${data[2]}`);
});
Commands.set("KICK", function (nick, data) {
	channel = channelMap.get(data[2]);
	if (!channel)
		return;
	text=data[4].substring(1);
	for (let i=5;i<data.length;i++)
	{
		text += " " + data[i];
	}
	if (data[3] != nickname)
	{
		if (Channel_RemoveUser(data[3], channel))
			writeToScreen("var(--clr-green)", "* " + data[3]+ " KICKED by " + nick + " because of " +text, channel);
		return;
	}
	Channel_Destroy(data[2]);
	writeToScreen("var(--clr-green)", "*** YOU GOT KICKED OUT OF "+ data[2] + " by " + nick + " because of " +text, statusChannel);
	writeToLog(`[IRC] 被踢出: ${data[2]} by ${nick} - ${text}`);
});
Commands.set("MODE", function (nick, data) {
	channel = channelMap.get(data[2]);
	if (!channel)
		return;
	text = data[3];
	for (let i=4;i<data.length;i++)
	{
		text += " " + data[i];
	}
	writeToScreen("var(--clr-green)", "* " + nick + " MODE "  + text, channel);
	ii = 4;
	status = "false";
	for (let i=0;i<data[3].length;i++)
	{
		if (data[3][i] == "+")
			status = "true";
		else if (data[3][i] == "-")
			status = "false";
		else 
		{
			if (ii < data.length) {
				Channel_UpdateUserPrefix(data[ii], channel, status, data[3][i]);
				ii++;
			}
		}
	}
	writeToLog(`[IRC] 模式变更: ${text}`);
});
Commands.set("NICK", function (nick, data) {
	newnick = data[2].substring(1);
	if (nick == nickname)
		nickname = newnick;
	channelMap.forEach(function(channel, name) {
		if (Channel_RenameUser(nick, newnick, channel))
		{
			if (newnick == nickname)
				writeToScreen("var(--clr-green)", "* YOU are now known as " + newnick, channel);
			else
				writeToScreen("var(--clr-green)", "* " +nick+ " is now known as " + newnick, channel);
		}
	});
	writeToLog(`[IRC] 昵称变更: ${nick} -> ${newnick}`);
});
Commands.set("PART", function (nick, data) {
	if (data[0].indexOf(":"+nickname+"!") != 0)
	{
		channel = channelMap.get(data[2]);
		if (!channel)
			return;
		if (Channel_RemoveUser(nick, channel))
			writeToScreen("var(--clr-green)", "* " + nick + " LEFT", channel);
		return;
	}
	Channel_Destroy(data[2]);
	writeToLog(`[IRC] 离开频道: ${data[2]}`);
});
Commands.set("TOPIC", function (nick, data) {
	channel = channelMap.get(data[2]);
	if (!channel)
		return;
	text = data[3].substring(1);
	for (let i=4;i<data.length;i++)
	{
		text += " " + data[i];
	}
	if (text)
		channel.topic.innerHTML = HTML_escape(text);
	else
		channel.topic.innerHTML = HTML_escape("no channeltopic available");
	writeToScreen("var(--clr-green)", "* "+nick + ' TOPIC set to : '+ text , channel);
	writeToLog(`[IRC] 主题变更: ${data[2]} - ${text}`);
});
Commands.set("QUIT", function (nick, data) {
	channelMap.forEach(function(channel, name) {
		if (Channel_RemoveUser(nick, channel))
		{
			writeToScreen("var(--clr-blue)", "* "+nick+" QUIT", channel);
		}
	})
	writeToLog(`[IRC] 用户退出: ${nick}`);
});
Commands.set("PRIVMSG", function (nick, data) {
	channel = channelMap.get(data[2]);
	if (!channel)
		channel = statusChannel;
	text=data[3].substring(1);
	for (let i=4;i<data.length;i++)
	{
		text += " " + data[i];
	}
	nick = data[0].substring(1).split("!",1)[0];
	if (text[0] == "\x01")
	{
		if (text.indexOf("\x01ACTION ") == 0)
			writeToScreen("var(--clr-red)", "* " + nick +" " + text.substring(8), channel);
		else
			writeToScreen("var(--clr-red)", "* " + nick +" " + text, channel);
	}
	else
		writeToScreen("var(--clr-font)", "<" + nick +"> " + text, channel);
});
Commands.set("NOTICE", function (nick, data) {
	channel = channelMap.get(data[2]);
	if (!channel)
		channel = statusChannel;
	text=data[3].substring(1);
	for (let i=4;i<data.length;i++)
	{
		text += " " + data[i];
	}
	nick = data[0].substring(1).split("!",1)[0];
	writeToScreen("var(--clr-red)", "-" + nick +"- " + text, channel);
	writeToLog(`[NOTICE] ${nick}: ${text}`);
});

function process(rawData)
{
	let data = rawData.split(" ");
	let nick = data[0].substring(1).split("!")[0];
	let fn = Commands.get(data[1].toUpperCase());
	if (fn)
	{
		fn(nick, data);
		return;
	}
	if (!isNaN(parseInt(data[1])))
	{
		text = data[1];
		for (let i=3;i<data.length;i++)
		{
			text += " " + data[i];
		}
		writeToScreen("var(--clr-gold)", text, statusChannel);
		writeToLog(`[SERVER] ${data[1]}: ${text}`);
		return;
	}
	if (data[0] == "PING")
	{
		pongResponse = rawData.replace("PING", "PONG");
		writeToScreen("var(--clr-brown)", pongResponse, statusChannel);
		websocket.send(pongResponse);
		writeToLog(`[PING/PONG] ${pongResponse}`);
		return;
	}
	if (data[0] == "ERROR")
	{
		writeToScreen("var(--clr-font)", rawData, statusChannel);
		writeToLog(`[ERROR] ${rawData}`);
		return;
	}
	console.log("DEBUG:", rawData);
	writeToLog(`[DEBUG] ${rawData}`);
}
</script>
</html>